# V5.0 快速实施指南（简化版）

更新日期：2025-10-15

---

## 📋 实施步骤

### 第1步：执行数据库迁移 ✅

1. 打开Supabase控制台
2. 进入 SQL Editor
3. 复制并执行：`supabase/migrations/migration_v5.0_upgrade.sql`

```sql
-- 核心SQL（已包含在迁移文件中）
UPDATE system_params SET param_value = 240 WHERE param_key = 'reinvest_threshold';
CREATE TABLE IF NOT EXISTS scheduled_tasks (...);
CREATE TABLE IF NOT EXISTS reserved_funds (...);
ALTER TABLE binary_members ADD COLUMN IF NOT EXISTS pending_settlement_amount DECIMAL(20, 2) DEFAULT 0;
```

**验证**：
```sql
SELECT * FROM scheduled_tasks;
SELECT * FROM reserved_funds LIMIT 1;
SELECT param_value FROM system_params WHERE param_key = 'reinvest_threshold';
```

---

### 第2步：配置文件已更新 ✅

**文件**：`src/config/binary.ts`

已完成的变更：
- ✅ 版本号更新为V5.0
- ✅ RESERVED_RATIO: 0.15（15%预留）
- ✅ THRESHOLD: 240（复投阈值）
- ✅ ADD_TO_WEAK_SIDE: true（复购单给弱区）
- ✅ STRATEGY: 'TEAM_INTERNAL'（团队内部滑落）
- ✅ SCHEDULED_SETTLEMENT: true（定时结算）
- ✅ 删除贡献奖配置
- ✅ 禁用分红池

---

### 第3步：配置定时任务 ⚠️

**使用Supabase Edge Functions**：

1. 创建Edge Function：
```bash
supabase functions new pairing-settlement
```

2. 编写函数代码：
```typescript
// supabase/functions/pairing-settlement/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

serve(async (req) => {
  const supabase = createClient(
    Deno.env.get('SUPABASE_URL') ?? '',
    Deno.env.get('SUPABASE_SERVICE_ROLE_KEY') ?? ''
  )

  try {
    // TODO: 实现对碰结算逻辑
    // 1. 查询所有pending单量
    // 2. 计算对碰结果
    // 3. 分配85%到账，15%预留
    // 4. 清零pending
    // 5. 记录日志
    
    return new Response(JSON.stringify({ success: true }), {
      headers: { 'Content-Type': 'application/json' },
    })
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    })
  }
})
```

3. 部署函数：
```bash
supabase functions deploy pairing-settlement
```

4. 配置Cron（在Supabase Dashboard）：
```
Schedule: 0 0 * * *  (每天凌晨12点)
Function: pairing-settlement
```

---

### 第4步：前端显示更新 📝

**需要修改的文件**：

#### 1. `src/views/binary/BinaryView.vue`
```vue
<!-- 删除平级奖说明 -->
<!-- 旧代码 -->
<div>💎 3代平级奖</div>

<!-- 新代码 -->
<!-- 删除整个平级奖部分 -->

<!-- 更新对碰奖说明 -->
<div class="font-bold text-purple-700 mb-1">💰 对碰奖</div>
<div>
  每组10U：85%（8.5U）自动到账 + 15%（1.5U）预留
  <br>
  每天凌晨12点统一结算
</div>
```

#### 2. `src/views/earnings/EarningsView.vue`
```vue
<!-- 删除平级奖选项卡 -->
<!-- 删除分红选项卡 -->
<!-- 只保留对碰奖选项卡 -->
```

#### 3. `src/views/profile/ProfileView.vue`
```vue
<!-- 更新复投提示 -->
<div v-if="totalEarnings >= 240">
  💡 您已赚取240U（8倍），建议复投30U
</div>
```

---

### 第5步：测试验证 🧪

#### 测试清单

1. **自动排线测试**
   - [ ] 推荐人A区B区都空 → 新用户放A区
   - [ ] 推荐人只有A区 → 新用户放B区
   - [ ] 推荐人A区B区都有 → 新用户滑到弱边

2. **对碰结算测试**
   - [ ] pending单量正确累积
   - [ ] 凌晨12点自动结算
   - [ ] 85%到账，15%进预留表

3. **复购测试**
   - [ ] 240U显示复投提示
   - [ ] 复购单自动加到弱区

4. **奖励测试**
   - [ ] 只有对碰奖，无平级奖
   - [ ] 无分红结算

---

### 第6步：部署上线 🚀

1. **提交代码**
```bash
git add .
git commit -m "feat: V5.0升级完成（简化版）"
git push origin main
```

2. **Netlify自动部署**
   - 自动检测到push
   - 自动构建
   - 自动部署

3. **验证部署**
```bash
# 访问线上地址，验证：
# 1. 对碰奖显示正确
# 2. 复投提示240U
# 3. 无平级奖显示
```

---

## 📝 简化对比

### V4.2（旧版）
```
对碰奖10U：
├─ 85%（8.5U）→ 会员
├─ 15%（1.5U）→ 分红池
│   └─ 直推≥10人分享
└─ 平级奖：3代，每人2U
```

### V5.0（新版）
```
对碰奖10U：
├─ 85%（8.5U）→ 会员
└─ 15%（1.5U）→ 预留（暂不分配）
```

**简化效果**：
- ❌ 删除平级奖
- ❌ 删除分红池
- ✅ 规则清晰
- ✅ 系统稳定
- ✅ 易于理解

---

## ⚠️ 注意事项

1. **数据备份**
   ```sql
   -- 备份binary_members表
   CREATE TABLE binary_members_backup AS SELECT * FROM binary_members;
   
   -- 备份rewards表
   CREATE TABLE rewards_backup AS SELECT * FROM rewards;
   ```

2. **回滚计划**
   - 保留V4.2配置文件备份
   - 记录数据库变更SQL
   - 准备回滚脚本

3. **用户通知**
   - 发布升级公告
   - 说明新规则（只有对碰奖）
   - 说明复投阈值变更（240U）

---

## 🎯 升级完成标志

- [x] ✅ 数据库迁移执行完成
- [x] ✅ 配置文件更新完成
- [ ] ⏳ 定时任务配置完成
- [ ] ⏳ 前端显示更新完成
- [ ] ⏳ 测试验证通过
- [ ] ⏳ 部署上线完成

---

## 📞 遇到问题？

1. 检查数据库迁移是否成功
2. 检查定时任务是否配置
3. 检查前端显示是否更新
4. 查看错误日志

---

**V5.0简化版，让系统更简单！** ✨

