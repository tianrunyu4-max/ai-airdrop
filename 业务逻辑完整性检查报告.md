# ğŸ” ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§æ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¶é—´**ï¼š2025-10-26  
**ç›®çš„**ï¼šç¡®ä¿æ•´ä½“ä¸šåŠ¡é€»è¾‘è·‘é€šï¼Œä¸ç¼ºå¤±ä»»ä½•ç¯èŠ‚

---

## âœ… æ ¸å¿ƒä¸šåŠ¡æµç¨‹æ£€æŸ¥

### 1ï¸âƒ£ **ç”¨æˆ·æ³¨å†Œæµç¨‹**

**ä»£ç ä½ç½®**ï¼š`src/stores/auth.ts` - `register()`

**æµç¨‹**ï¼š
```
1. ç”¨æˆ·å¡«å†™ç”¨æˆ·åã€å¯†ç 
2. ä¸éœ€è¦å¡«å†™é‚€è¯·ç ï¼ˆæ¸¸å®¢èº«ä»½ï¼‰
3. åˆ›å»ºç”¨æˆ·è®°å½•ï¼ˆinviter_id = nullï¼‰
4. ä¸å»ºç«‹ä»»ä½•æ¨èå…³ç³»
5. ä¸å‘æ”¾ä»»ä½•å¥–åŠ±
```

**æ£€æŸ¥ç»“æœ**ï¼šâœ… **æ­£ç¡®**ï¼ˆå·²ä¿®å¤ï¼Œä¸å†è¦æ±‚é‚€è¯·ç ï¼‰

---

### 2ï¸âƒ£ **å‡çº§AIä»£ç†æµç¨‹**

**ä»£ç ä½ç½®**ï¼š`src/services/AgentService.ts` - `becomeAgent()`

**æµç¨‹**ï¼š
```
1. ç”¨æˆ·è¾“å…¥é‚€è¯·ç 
2. éªŒè¯é‚€è¯·ç æœ‰æ•ˆæ€§
3. æ£€æŸ¥Uä½™é¢â‰¥30U
4. æ‰£é™¤30Uï¼ˆWalletManager.deductï¼‰
5. è®¾ç½® is_agent = true
6. å†™å…¥ referral_relationships è¡¨ï¼ˆå»ºç«‹ç›´æ¨å…³ç³»ï¼‰
7. èµ é€100ç§¯åˆ†ï¼ˆWalletManager.addTransferPoints + addPointsï¼‰
8. åŠ å…¥Binaryç³»ç»Ÿï¼ˆå¼‚æ­¥ï¼‰
```

**å¥–åŠ±**ï¼š
- âŒ **ä¸å‘æ”¾Uå¥–åŠ±ç»™æ¨èäºº**ï¼ˆæ­£ç¡®ï¼‰
- âœ… åªå»ºç«‹ç›´æ¨å…³ç³»
- âœ… èµ é€100ç§¯åˆ†ç»™æ–°ç”¨æˆ·

**æ£€æŸ¥ç»“æœ**ï¼šâœ… **æ­£ç¡®**

---

### 3ï¸âƒ£ **å¯¹ç¢°å¥–å‘æ”¾æµç¨‹**

**ä»£ç ä½ç½®**ï¼š`src/services/BinaryService.ts` - `calculatePairing()`

**æµç¨‹**ï¼š
```
1. æ£€æŸ¥ABåŒºpendingå•æ•°
2. è®¡ç®—å¯é…å¯¹ç»„æ•°ï¼ˆ2:1æˆ–1:2ï¼‰
3. å‘æ”¾å¯¹ç¢°å¥–ï¼š6U Ã— 80% = 4.8U/ç»„
4. è°ƒç”¨ WalletManager.add(userId, bonus, 'pairing_bonus', ...)
5. æ›´æ–°pendingå•æ•°
```

**ä¾èµ–**ï¼š
- âœ… `add_user_balance` RPCå‡½æ•°ï¼ˆWalletManageréœ€è¦ï¼‰

**æ£€æŸ¥ç»“æœ**ï¼šâœ… **æ­£ç¡®**

---

### 4ï¸âƒ£ **è§å•å¥–å‘æ”¾æµç¨‹**

**ä»£ç ä½ç½®**ï¼š`src/services/BinaryService.ts` - `triggerOrderBonus()`

**æµç¨‹**ï¼š
```
1. ä¸‹çº¿å¯¹ç¢°æˆåŠŸåè§¦å‘
2. å‘ä¸Šè¿½æº¯5ä»£ç›´æ¨é“¾ï¼ˆé€šè¿‡ users.inviter_idï¼‰
3. æ£€æŸ¥æ¯ä»£ä¸Šçº§çš„ç›´æ¨äººæ•°â‰¥2äºº
4. æ»¡è¶³æ¡ä»¶çš„ä¸Šçº§è·å¾—ï¼š1U Ã— å¯¹ç¢°ç»„æ•°
5. è°ƒç”¨ WalletManager.add(uplineId, bonus, 'order_bonus', ...)
```

**ä¾èµ–**ï¼š
- âœ… `users.inviter_id` å­—æ®µï¼ˆBinaryç³»ç»Ÿç”¨ï¼Œä¸referral_relationshipsä¸åŒï¼‰
- âœ… `add_user_balance` RPCå‡½æ•°

**âš ï¸ é—®é¢˜**ï¼šä»£ç ä¸­æŸ¥è¯¢çš„æ˜¯ `users.inviter_id`ï¼Œä½†æˆ‘ä»¬åˆ›å»ºçš„æ˜¯ `referral_relationships` è¡¨

**éœ€è¦ç¡®è®¤**ï¼š
- è§å•å¥–åº”è¯¥æŸ¥è¯¢ `users.inviter_id`ï¼ˆBinaryæ ‘ï¼‰ï¼Ÿ
- è¿˜æ˜¯æŸ¥è¯¢ `referral_relationships`ï¼ˆä¸šåŠ¡æ¨èå…³ç³»ï¼‰ï¼Ÿ

**æ£€æŸ¥ç»“æœ**ï¼šâš ï¸ **éœ€è¦æ¾„æ¸…**

---

### 5ï¸âƒ£ **ç§¯åˆ†é‡Šæ”¾åŠ é€Ÿæµç¨‹**

**ä»£ç ä½ç½®**ï¼š
- `src/services/MiningService.ts` - `calculateReleaseRate()`
- `src/views/earnings/EarningsView.vue` - `calculateReleaseRate()`
- `src/views/points/PointsView.vue` - `calculateReleaseRate()`

**æµç¨‹**ï¼š
```
1. æŸ¥è¯¢ç”¨æˆ·çš„ç›´æ¨äººæ•°ï¼ˆä» referral_relationships è¡¨ï¼‰
2. è®¡ç®—é‡Šæ”¾ç‡ï¼š0.01 + Math.min(count Ã— 0.03, 0.15)
3. ç­¾åˆ°æ—¶æŒ‰é‡Šæ”¾ç‡é‡Šæ”¾ç§¯åˆ†
```

**ä¾èµ–**ï¼š
- âœ… `referral_relationships` è¡¨

**æ£€æŸ¥ç»“æœ**ï¼šâœ… **æ­£ç¡®**ï¼ˆå·²ä¿®å¤ï¼‰

---

### 6ï¸âƒ£ **å¤è´­æµç¨‹**

**ä»£ç ä½ç½®**ï¼š`src/services/BinaryService.ts` - `checkReinvestRequired()`

**æµç¨‹**ï¼š
```
1. æ£€æŸ¥æ€»æ”¶ç›Šæ˜¯å¦è¾¾åˆ°240U
2. æç¤ºç”¨æˆ·å¤æŠ•30U
3. å¤æŠ•åè¡¥åˆ°å¼±åŒºpending
```

**æ£€æŸ¥ç»“æœ**ï¼šâœ… **æ­£ç¡®**

---

## ğŸ”§ éœ€è¦ä¿®å¤çš„RPCå‡½æ•°

### âœ… å¿…éœ€çš„RPCå‡½æ•°ï¼š

1. `add_user_balance(user_id, amount)` - å¢åŠ Uä½™é¢
2. `deduct_user_balance(user_id, amount)` - æ‰£é™¤Uä½™é¢
3. `add_user_points(user_id, amount)` - å¢åŠ æ€»ç§¯åˆ†
4. `deduct_user_points(user_id, amount)` - æ‰£é™¤æ€»ç§¯åˆ†
5. `add_transfer_points(user_id, amount)` - å¢åŠ äº’è½¬ç§¯åˆ†
6. `deduct_transfer_points(user_id, amount)` - æ‰£é™¤äº’è½¬ç§¯åˆ†

**çŠ¶æ€**ï¼šâœ… å·²åˆ›å»ºï¼ˆ`åˆ›å»ºæ ¸å¿ƒRPCå‡½æ•°-ä½™é¢åŸå­æ“ä½œ.sql`ï¼‰

---

## âŒ éœ€è¦åˆ é™¤çš„é”™è¯¯å†…å®¹

### 1. é”™è¯¯çš„è§¦å‘å™¨

**æ–‡ä»¶**ï¼š`supabase/migrations/åˆ›å»ºç›´æ¨å…³ç³»è¡¨-referral_relationships.sql`

**éœ€è¦åˆ é™¤**ï¼š
- `trigger_referral_bonus` è§¦å‘å™¨
- `reward_referrer_on_new_agent()` å‡½æ•°

**ä¿®å¤SQL**ï¼šâœ… å·²åˆ›å»ºï¼ˆ`ä¿®å¤-åˆ é™¤é”™è¯¯çš„è§å•å¥–è§¦å‘å™¨.sql`ï¼‰

---

## ğŸ¯ å¾…ç¡®è®¤çš„é—®é¢˜

### âš ï¸ é—®é¢˜1ï¼šè§å•å¥–æŸ¥è¯¢å“ªä¸ªå­—æ®µï¼Ÿ

**BinaryService.triggerOrderBonus()** ç¬¬686ã€694ã€703è¡Œä½¿ç”¨çš„æ˜¯ï¼š
```typescript
.select('id, username, inviter_id')  // æŸ¥è¯¢çš„æ˜¯ users.inviter_id
```

ä½†æˆ‘ä»¬åˆ›å»ºçš„æ˜¯ `referral_relationships` è¡¨ã€‚

**è¯·ç¡®è®¤**ï¼š
- è§å•å¥–åº”è¯¥æ²¿ç€ **Binaryæ ‘**ï¼ˆ`users.inviter_id`ï¼‰å‘ä¸Šè¿½æº¯ï¼Ÿ
- è¿˜æ˜¯æ²¿ç€ **ä¸šåŠ¡æ¨èå…³ç³»**ï¼ˆ`referral_relationships.referrer_id`ï¼‰ï¼Ÿ

---

## ğŸ“‹ å¾…æ‰§è¡Œçš„SQLï¼ˆæŒ‰é¡ºåºï¼‰

### ç¬¬1æ­¥ï¼šåˆ›å»ºRPCå‡½æ•°
**æ–‡ä»¶**ï¼š`åˆ›å»ºæ ¸å¿ƒRPCå‡½æ•°-ä½™é¢åŸå­æ“ä½œ.sql`  
**ç›®çš„**ï¼šä¸ºWalletManageræä¾›åŸå­æ“ä½œ

### ç¬¬2æ­¥ï¼šåˆ é™¤é”™è¯¯è§¦å‘å™¨
**æ–‡ä»¶**ï¼š`ä¿®å¤-åˆ é™¤é”™è¯¯çš„è§å•å¥–è§¦å‘å™¨.sql`  
**ç›®çš„**ï¼šåˆ é™¤é”™è¯¯çš„å‡çº§AIä»£ç†å‘5Ué€»è¾‘

### ç¬¬3æ­¥ï¼šåˆ›å»ºå¹²å‡€çš„ç›´æ¨å…³ç³»è¡¨
**æ–‡ä»¶**ï¼š`åˆ›å»ºç›´æ¨å…³ç³»è¡¨-referral_relationships-ä¿®æ­£ç‰ˆ.sql`  
**ç›®çš„**ï¼šå»ºç«‹ä¸šåŠ¡æ¨èå…³ç³»è¡¨ï¼ˆç”¨äºé‡Šæ”¾ç‡è®¡ç®—ï¼‰

---

## âœ… å®Œæ•´æ€§æ€»ç»“

### å·²å®Œæˆï¼š
- âœ… æ³¨å†Œæµç¨‹ï¼ˆä¸éœ€è¦é‚€è¯·ç ï¼‰
- âœ… å‡çº§AIä»£ç†æµç¨‹ï¼ˆå»ºç«‹ç›´æ¨å…³ç³»ï¼Œèµ é€ç§¯åˆ†ï¼‰
- âœ… å¯¹ç¢°å¥–æµç¨‹ï¼ˆ4.8U/ç»„ï¼‰
- âœ… ç§¯åˆ†é‡Šæ”¾åŠ é€Ÿï¼ˆæ¯äºº+3%ï¼‰
- âœ… å¤è´­æç¤ºï¼ˆ240Uå¤æŠ•30Uï¼‰

### å¾…ç¡®è®¤ï¼š
- âš ï¸ è§å•å¥–æŸ¥è¯¢é€»è¾‘ï¼ˆBinaryæ ‘ vs ä¸šåŠ¡æ¨èå…³ç³»ï¼‰

### å·²åˆ é™¤ï¼š
- âŒ å‡çº§AIä»£ç†å‘5Uçš„é”™è¯¯é€»è¾‘

---

**è¯·ç¡®è®¤ï¼šè§å•å¥–åº”è¯¥æ²¿ç€å“ªä¸ªå…³ç³»é“¾è¿½æº¯ï¼Ÿ**

