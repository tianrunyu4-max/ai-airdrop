# 🔍 业务逻辑完整性检查报告

**检查时间**：2025-10-26  
**目的**：确保整体业务逻辑跑通，不缺失任何环节

---

## ✅ 核心业务流程检查

### 1️⃣ **用户注册流程**

**代码位置**：`src/stores/auth.ts` - `register()`

**流程**：
```
1. 用户填写用户名、密码
2. 不需要填写邀请码（游客身份）
3. 创建用户记录（inviter_id = null）
4. 不建立任何推荐关系
5. 不发放任何奖励
```

**检查结果**：✅ **正确**（已修复，不再要求邀请码）

---

### 2️⃣ **升级AI代理流程**

**代码位置**：`src/services/AgentService.ts` - `becomeAgent()`

**流程**：
```
1. 用户输入邀请码
2. 验证邀请码有效性
3. 检查U余额≥30U
4. 扣除30U（WalletManager.deduct）
5. 设置 is_agent = true
6. 写入 referral_relationships 表（建立直推关系）
7. 赠送100积分（WalletManager.addTransferPoints + addPoints）
8. 加入Binary系统（异步）
```

**奖励**：
- ❌ **不发放U奖励给推荐人**（正确）
- ✅ 只建立直推关系
- ✅ 赠送100积分给新用户

**检查结果**：✅ **正确**

---

### 3️⃣ **对碰奖发放流程**

**代码位置**：`src/services/BinaryService.ts` - `calculatePairing()`

**流程**：
```
1. 检查AB区pending单数
2. 计算可配对组数（2:1或1:2）
3. 发放对碰奖：6U × 80% = 4.8U/组
4. 调用 WalletManager.add(userId, bonus, 'pairing_bonus', ...)
5. 更新pending单数
```

**依赖**：
- ✅ `add_user_balance` RPC函数（WalletManager需要）

**检查结果**：✅ **正确**

---

### 4️⃣ **见单奖发放流程**

**代码位置**：`src/services/BinaryService.ts` - `triggerOrderBonus()`

**流程**：
```
1. 下线对碰成功后触发
2. 向上追溯5代直推链（通过 users.inviter_id）
3. 检查每代上级的直推人数≥2人
4. 满足条件的上级获得：1U × 对碰组数
5. 调用 WalletManager.add(uplineId, bonus, 'order_bonus', ...)
```

**依赖**：
- ✅ `users.inviter_id` 字段（Binary系统用，与referral_relationships不同）
- ✅ `add_user_balance` RPC函数

**⚠️ 问题**：代码中查询的是 `users.inviter_id`，但我们创建的是 `referral_relationships` 表

**需要确认**：
- 见单奖应该查询 `users.inviter_id`（Binary树）？
- 还是查询 `referral_relationships`（业务推荐关系）？

**检查结果**：⚠️ **需要澄清**

---

### 5️⃣ **积分释放加速流程**

**代码位置**：
- `src/services/MiningService.ts` - `calculateReleaseRate()`
- `src/views/earnings/EarningsView.vue` - `calculateReleaseRate()`
- `src/views/points/PointsView.vue` - `calculateReleaseRate()`

**流程**：
```
1. 查询用户的直推人数（从 referral_relationships 表）
2. 计算释放率：0.01 + Math.min(count × 0.03, 0.15)
3. 签到时按释放率释放积分
```

**依赖**：
- ✅ `referral_relationships` 表

**检查结果**：✅ **正确**（已修复）

---

### 6️⃣ **复购流程**

**代码位置**：`src/services/BinaryService.ts` - `checkReinvestRequired()`

**流程**：
```
1. 检查总收益是否达到240U
2. 提示用户复投30U
3. 复投后补到弱区pending
```

**检查结果**：✅ **正确**

---

## 🔧 需要修复的RPC函数

### ✅ 必需的RPC函数：

1. `add_user_balance(user_id, amount)` - 增加U余额
2. `deduct_user_balance(user_id, amount)` - 扣除U余额
3. `add_user_points(user_id, amount)` - 增加总积分
4. `deduct_user_points(user_id, amount)` - 扣除总积分
5. `add_transfer_points(user_id, amount)` - 增加互转积分
6. `deduct_transfer_points(user_id, amount)` - 扣除互转积分

**状态**：✅ 已创建（`创建核心RPC函数-余额原子操作.sql`）

---

## ❌ 需要删除的错误内容

### 1. 错误的触发器

**文件**：`supabase/migrations/创建直推关系表-referral_relationships.sql`

**需要删除**：
- `trigger_referral_bonus` 触发器
- `reward_referrer_on_new_agent()` 函数

**修复SQL**：✅ 已创建（`修复-删除错误的见单奖触发器.sql`）

---

## 🎯 待确认的问题

### ⚠️ 问题1：见单奖查询哪个字段？

**BinaryService.triggerOrderBonus()** 第686、694、703行使用的是：
```typescript
.select('id, username, inviter_id')  // 查询的是 users.inviter_id
```

但我们创建的是 `referral_relationships` 表。

**请确认**：
- 见单奖应该沿着 **Binary树**（`users.inviter_id`）向上追溯？
- 还是沿着 **业务推荐关系**（`referral_relationships.referrer_id`）？

---

## 📋 待执行的SQL（按顺序）

### 第1步：创建RPC函数
**文件**：`创建核心RPC函数-余额原子操作.sql`  
**目的**：为WalletManager提供原子操作

### 第2步：删除错误触发器
**文件**：`修复-删除错误的见单奖触发器.sql`  
**目的**：删除错误的升级AI代理发5U逻辑

### 第3步：创建干净的直推关系表
**文件**：`创建直推关系表-referral_relationships-修正版.sql`  
**目的**：建立业务推荐关系表（用于释放率计算）

---

## ✅ 完整性总结

### 已完成：
- ✅ 注册流程（不需要邀请码）
- ✅ 升级AI代理流程（建立直推关系，赠送积分）
- ✅ 对碰奖流程（4.8U/组）
- ✅ 积分释放加速（每人+3%）
- ✅ 复购提示（240U复投30U）

### 待确认：
- ⚠️ 见单奖查询逻辑（Binary树 vs 业务推荐关系）

### 已删除：
- ❌ 升级AI代理发5U的错误逻辑

---

**请确认：见单奖应该沿着哪个关系链追溯？**

