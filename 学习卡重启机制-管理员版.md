# 🔧 学习卡重启机制 - 管理员版

## 🎯 核心设计

### 角色划分
- **管理员**：后台操作重启，手动或自动检测
- **普通用户**：前端只显示重启统计次数

---

## 🏗️ 系统架构

### 后端（管理员专用）
```
管理员后台
  ├─ 手动重启
  │   ├─ 全平台扫描
  │   ├─ 批量销毁达标卡片
  │   └─ 记录重启日志
  │
  └─ 自动重启（定时任务）
      ├─ 每日自动检测
      ├─ 达标自动销毁
      └─ 通知管理员
```

### 前端（用户端）
```
用户学习卡页面
  └─ 重启统计卡片
      ├─ 本周重启次数：3次
      ├─ 累计重启次数：15次
      └─ 最近重启时间
```

---

## 💻 实现方案

### 1. 后端服务（管理员）

#### 功能1：全平台扫描
```typescript
// 扫描所有用户的学习卡
async function scanAllCards() {
  const allCards = await getAllActiveCards()
  
  let destroyed = 0
  let kept = 0
  
  for (const card of allCards) {
    const status = checkCardStatus(card)
    
    if (status.shouldDestroy) {
      await destroyCard(card)
      destroyed++
    } else {
      kept++
    }
  }
  
  return { destroyed, kept }
}
```

#### 功能2：记录重启日志
```typescript
interface RestartLog {
  id: string
  admin_id: string          // 管理员ID
  restart_type: 'manual' | 'auto'  // 手动/自动
  total_scanned: number     // 扫描总数
  total_destroyed: number   // 销毁数量
  total_kept: number        // 保留数量
  restart_time: string      // 重启时间
  affected_users: string[]  // 受影响用户ID列表
}
```

#### 功能3：用户统计
```typescript
interface UserRestartStats {
  user_id: string
  total_restarts: number    // 累计重启次数
  this_week: number         // 本周重启次数
  this_month: number        // 本月重启次数
  last_restart: string      // 最近重启时间
}
```

---

### 2. 前端显示（用户）

#### 简化版统计卡片
```vue
<div class="restart-stats-card">
  <div class="stats-header">🔄 系统重启统计</div>
  <div class="stats-content">
    <div class="stat-item">
      <span class="label">本周重启</span>
      <span class="value">{{ weeklyRestarts }}次</span>
    </div>
    <div class="stat-item">
      <span class="label">累计重启</span>
      <span class="value">{{ totalRestarts }}次</span>
    </div>
  </div>
  <div class="last-restart">
    最近重启：{{ lastRestartTime }}
  </div>
</div>
```

---

### 3. 管理员后台页面

#### 页面结构
```
管理员后台 → 学习卡管理 → 重启系统

┌─────────────────────────────┐
│ 🔄 学习卡重启管理            │
├─────────────────────────────┤
│ 当前状态                      │
│ ├─ 活跃学习卡：1,234张       │
│ ├─ 达标待销毁：56张          │
│ └─ 继续运行：1,178张         │
├─────────────────────────────┤
│ 操作                         │
│ [🔍 全平台扫描]              │
│ [🔥 执行重启]                │
│ [⚙️ 自动重启设置]            │
├─────────────────────────────┤
│ 重启历史                      │
│ 2025-10-27 08:00 自动重启    │
│ 销毁：45张 | 保留：1,189张   │
│                              │
│ 2025-10-26 08:00 自动重启    │
│ 销毁：38张 | 保留：1,196张   │
└─────────────────────────────┘
```

---

## 🤖 自动重启配置

### 定时任务设置
```typescript
// supabase/functions/auto-restart-cards/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'

serve(async (req) => {
  // 每天凌晨2点自动执行
  const result = await autoRestartCards()
  
  return new Response(
    JSON.stringify({ success: true, ...result }),
    { headers: { 'Content-Type': 'application/json' } }
  )
})

async function autoRestartCards() {
  console.log('🤖 开始自动重启检测...')
  
  // 1. 扫描所有学习卡
  const allCards = await getAllActiveCards()
  
  // 2. 按用户分组
  const userCardsMap = groupByUser(allCards)
  
  // 3. 逐个用户处理
  let totalDestroyed = 0
  const affectedUsers = []
  
  for (const [userId, cards] of Object.entries(userCardsMap)) {
    const destroyed = await processUserCards(userId, cards)
    if (destroyed > 0) {
      totalDestroyed += destroyed
      affectedUsers.push(userId)
      
      // 更新用户统计
      await updateUserRestartStats(userId)
    }
  }
  
  // 4. 记录重启日志
  await logRestart({
    restart_type: 'auto',
    total_destroyed: totalDestroyed,
    affected_users: affectedUsers,
    restart_time: new Date().toISOString()
  })
  
  console.log(`✅ 自动重启完成：销毁${totalDestroyed}张学习卡`)
  
  return { totalDestroyed, affectedUsers: affectedUsers.length }
}
```

### Supabase Cron Job 配置
```sql
-- 创建定时任务：每天凌晨2点执行
SELECT cron.schedule(
  'auto-restart-cards',
  '0 2 * * *',  -- 每天2:00 AM
  $$
  SELECT net.http_post(
    url := 'https://your-project.supabase.co/functions/v1/auto-restart-cards',
    headers := '{"Content-Type": "application/json", "Authorization": "Bearer YOUR_ANON_KEY"}'::jsonb
  ) as request_id;
  $$
);
```

---

## 📊 数据库表设计

### restart_logs 表
```sql
CREATE TABLE restart_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID,                          -- 管理员ID（自动重启为NULL）
  restart_type VARCHAR(20) NOT NULL,      -- 'manual' | 'auto'
  total_scanned INTEGER,                  -- 扫描总数
  total_destroyed INTEGER,                -- 销毁数量
  total_kept INTEGER,                     -- 保留数量
  affected_users JSONB,                   -- 受影响用户列表
  restart_time TIMESTAMPTZ DEFAULT NOW(), -- 重启时间
  details JSONB                           -- 详细信息
);

-- 索引
CREATE INDEX idx_restart_logs_time ON restart_logs(restart_time DESC);
CREATE INDEX idx_restart_logs_type ON restart_logs(restart_type);
```

### user_restart_stats 表
```sql
CREATE TABLE user_restart_stats (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  total_restarts INTEGER DEFAULT 0,       -- 累计重启次数
  this_week INTEGER DEFAULT 0,            -- 本周重启次数
  this_month INTEGER DEFAULT 0,           -- 本月重启次数
  last_restart TIMESTAMPTZ,               -- 最近重启时间
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 每周重置
CREATE OR REPLACE FUNCTION reset_weekly_stats() RETURNS void AS $$
BEGIN
  UPDATE user_restart_stats SET this_week = 0;
END;
$$ LANGUAGE plpgsql;

-- 每月重置
CREATE OR REPLACE FUNCTION reset_monthly_stats() RETURNS void AS $$
BEGIN
  UPDATE user_restart_stats SET this_month = 0;
END;
$$ LANGUAGE plpgsql;
```

---

## 🎨 前端简化实现

### 用户端：只显示统计
```vue
<template>
  <!-- 重启统计卡片（简化版）-->
  <div v-if="restartStats" class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-4 shadow-xl">
    <div class="text-white/90 text-xs mb-2 font-semibold">🔄 系统重启统计</div>
    
    <div class="grid grid-cols-2 gap-3 mb-2">
      <div class="bg-white/20 rounded-lg p-2 text-center">
        <div class="text-white text-2xl font-bold">{{ restartStats.this_week }}</div>
        <div class="text-white/80 text-xs">本周重启</div>
      </div>
      <div class="bg-white/20 rounded-lg p-2 text-center">
        <div class="text-white text-2xl font-bold">{{ restartStats.total_restarts }}</div>
        <div class="text-white/80 text-xs">累计重启</div>
      </div>
    </div>
    
    <div class="text-white/70 text-xs text-center">
      最近重启：{{ formatLastRestart(restartStats.last_restart) }}
    </div>
  </div>
</template>

<script setup>
const restartStats = ref(null)

// 加载重启统计
const loadRestartStats = async () => {
  try {
    const { data } = await supabase
      .from('user_restart_stats')
      .select('*')
      .eq('user_id', user.value.id)
      .single()
    
    restartStats.value = data
  } catch (error) {
    console.error('加载重启统计失败:', error)
  }
}
</script>
```

---

## 🔑 权限控制

### 管理员权限检查
```typescript
// 只有管理员可以访问重启功能
export async function checkAdminPermission(userId: string): Promise<boolean> {
  const { data } = await supabase
    .from('users')
    .select('is_admin')
    .eq('id', userId)
    .single()
  
  return data?.is_admin === true
}

// 管理员重启函数
export async function manualRestart(adminId: string) {
  // 检查权限
  if (!await checkAdminPermission(adminId)) {
    throw new Error('无权限操作')
  }
  
  // 执行重启
  return await restartSystem()
}
```

---

## 📱 用户通知

### 重启后通知用户
```typescript
async function notifyUsersAfterRestart(affectedUsers: string[]) {
  for (const userId of affectedUsers) {
    await sendNotification(userId, {
      type: 'system_restart',
      title: '🔄 学习卡已重启',
      message: '您的部分学习卡已达标并自动销毁，可以兑换新的学习卡了！',
      created_at: new Date().toISOString()
    })
  }
}
```

---

## 🎯 总结

### 后端（管理员）
- ✅ 全平台扫描功能
- ✅ 手动/自动重启
- ✅ 定时任务配置
- ✅ 详细日志记录

### 前端（用户）
- ✅ 简洁统计显示
- ✅ 本周/累计次数
- ✅ 最近重启时间
- ❌ 无操作按钮

### 优势
1. **权限分离**：管理员控制，用户只读
2. **自动化**：定时任务自动执行
3. **简洁UI**：用户界面简单清晰
4. **可追溯**：详细日志记录

