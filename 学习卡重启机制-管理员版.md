# ğŸ”§ å­¦ä¹ å¡é‡å¯æœºåˆ¶ - ç®¡ç†å‘˜ç‰ˆ

## ğŸ¯ æ ¸å¿ƒè®¾è®¡

### è§’è‰²åˆ’åˆ†
- **ç®¡ç†å‘˜**ï¼šåå°æ“ä½œé‡å¯ï¼Œæ‰‹åŠ¨æˆ–è‡ªåŠ¨æ£€æµ‹
- **æ™®é€šç”¨æˆ·**ï¼šå‰ç«¯åªæ˜¾ç¤ºé‡å¯ç»Ÿè®¡æ¬¡æ•°

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### åç«¯ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰
```
ç®¡ç†å‘˜åå°
  â”œâ”€ æ‰‹åŠ¨é‡å¯
  â”‚   â”œâ”€ å…¨å¹³å°æ‰«æ
  â”‚   â”œâ”€ æ‰¹é‡é”€æ¯è¾¾æ ‡å¡ç‰‡
  â”‚   â””â”€ è®°å½•é‡å¯æ—¥å¿—
  â”‚
  â””â”€ è‡ªåŠ¨é‡å¯ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰
      â”œâ”€ æ¯æ—¥è‡ªåŠ¨æ£€æµ‹
      â”œâ”€ è¾¾æ ‡è‡ªåŠ¨é”€æ¯
      â””â”€ é€šçŸ¥ç®¡ç†å‘˜
```

### å‰ç«¯ï¼ˆç”¨æˆ·ç«¯ï¼‰
```
ç”¨æˆ·å­¦ä¹ å¡é¡µé¢
  â””â”€ é‡å¯ç»Ÿè®¡å¡ç‰‡
      â”œâ”€ æœ¬å‘¨é‡å¯æ¬¡æ•°ï¼š3æ¬¡
      â”œâ”€ ç´¯è®¡é‡å¯æ¬¡æ•°ï¼š15æ¬¡
      â””â”€ æœ€è¿‘é‡å¯æ—¶é—´
```

---

## ğŸ’» å®ç°æ–¹æ¡ˆ

### 1. åç«¯æœåŠ¡ï¼ˆç®¡ç†å‘˜ï¼‰

#### åŠŸèƒ½1ï¼šå…¨å¹³å°æ‰«æ
```typescript
// æ‰«ææ‰€æœ‰ç”¨æˆ·çš„å­¦ä¹ å¡
async function scanAllCards() {
  const allCards = await getAllActiveCards()
  
  let destroyed = 0
  let kept = 0
  
  for (const card of allCards) {
    const status = checkCardStatus(card)
    
    if (status.shouldDestroy) {
      await destroyCard(card)
      destroyed++
    } else {
      kept++
    }
  }
  
  return { destroyed, kept }
}
```

#### åŠŸèƒ½2ï¼šè®°å½•é‡å¯æ—¥å¿—
```typescript
interface RestartLog {
  id: string
  admin_id: string          // ç®¡ç†å‘˜ID
  restart_type: 'manual' | 'auto'  // æ‰‹åŠ¨/è‡ªåŠ¨
  total_scanned: number     // æ‰«ææ€»æ•°
  total_destroyed: number   // é”€æ¯æ•°é‡
  total_kept: number        // ä¿ç•™æ•°é‡
  restart_time: string      // é‡å¯æ—¶é—´
  affected_users: string[]  // å—å½±å“ç”¨æˆ·IDåˆ—è¡¨
}
```

#### åŠŸèƒ½3ï¼šç”¨æˆ·ç»Ÿè®¡
```typescript
interface UserRestartStats {
  user_id: string
  total_restarts: number    // ç´¯è®¡é‡å¯æ¬¡æ•°
  this_week: number         // æœ¬å‘¨é‡å¯æ¬¡æ•°
  this_month: number        // æœ¬æœˆé‡å¯æ¬¡æ•°
  last_restart: string      // æœ€è¿‘é‡å¯æ—¶é—´
}
```

---

### 2. å‰ç«¯æ˜¾ç¤ºï¼ˆç”¨æˆ·ï¼‰

#### ç®€åŒ–ç‰ˆç»Ÿè®¡å¡ç‰‡
```vue
<div class="restart-stats-card">
  <div class="stats-header">ğŸ”„ ç³»ç»Ÿé‡å¯ç»Ÿè®¡</div>
  <div class="stats-content">
    <div class="stat-item">
      <span class="label">æœ¬å‘¨é‡å¯</span>
      <span class="value">{{ weeklyRestarts }}æ¬¡</span>
    </div>
    <div class="stat-item">
      <span class="label">ç´¯è®¡é‡å¯</span>
      <span class="value">{{ totalRestarts }}æ¬¡</span>
    </div>
  </div>
  <div class="last-restart">
    æœ€è¿‘é‡å¯ï¼š{{ lastRestartTime }}
  </div>
</div>
```

---

### 3. ç®¡ç†å‘˜åå°é¡µé¢

#### é¡µé¢ç»“æ„
```
ç®¡ç†å‘˜åå° â†’ å­¦ä¹ å¡ç®¡ç† â†’ é‡å¯ç³»ç»Ÿ

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ å­¦ä¹ å¡é‡å¯ç®¡ç†            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å½“å‰çŠ¶æ€                      â”‚
â”‚ â”œâ”€ æ´»è·ƒå­¦ä¹ å¡ï¼š1,234å¼        â”‚
â”‚ â”œâ”€ è¾¾æ ‡å¾…é”€æ¯ï¼š56å¼           â”‚
â”‚ â””â”€ ç»§ç»­è¿è¡Œï¼š1,178å¼          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ“ä½œ                         â”‚
â”‚ [ğŸ” å…¨å¹³å°æ‰«æ]              â”‚
â”‚ [ğŸ”¥ æ‰§è¡Œé‡å¯]                â”‚
â”‚ [âš™ï¸ è‡ªåŠ¨é‡å¯è®¾ç½®]            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é‡å¯å†å²                      â”‚
â”‚ 2025-10-27 08:00 è‡ªåŠ¨é‡å¯    â”‚
â”‚ é”€æ¯ï¼š45å¼  | ä¿ç•™ï¼š1,189å¼    â”‚
â”‚                              â”‚
â”‚ 2025-10-26 08:00 è‡ªåŠ¨é‡å¯    â”‚
â”‚ é”€æ¯ï¼š38å¼  | ä¿ç•™ï¼š1,196å¼    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¤– è‡ªåŠ¨é‡å¯é…ç½®

### å®šæ—¶ä»»åŠ¡è®¾ç½®
```typescript
// supabase/functions/auto-restart-cards/index.ts
import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'

serve(async (req) => {
  // æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ‰§è¡Œ
  const result = await autoRestartCards()
  
  return new Response(
    JSON.stringify({ success: true, ...result }),
    { headers: { 'Content-Type': 'application/json' } }
  )
})

async function autoRestartCards() {
  console.log('ğŸ¤– å¼€å§‹è‡ªåŠ¨é‡å¯æ£€æµ‹...')
  
  // 1. æ‰«ææ‰€æœ‰å­¦ä¹ å¡
  const allCards = await getAllActiveCards()
  
  // 2. æŒ‰ç”¨æˆ·åˆ†ç»„
  const userCardsMap = groupByUser(allCards)
  
  // 3. é€ä¸ªç”¨æˆ·å¤„ç†
  let totalDestroyed = 0
  const affectedUsers = []
  
  for (const [userId, cards] of Object.entries(userCardsMap)) {
    const destroyed = await processUserCards(userId, cards)
    if (destroyed > 0) {
      totalDestroyed += destroyed
      affectedUsers.push(userId)
      
      // æ›´æ–°ç”¨æˆ·ç»Ÿè®¡
      await updateUserRestartStats(userId)
    }
  }
  
  // 4. è®°å½•é‡å¯æ—¥å¿—
  await logRestart({
    restart_type: 'auto',
    total_destroyed: totalDestroyed,
    affected_users: affectedUsers,
    restart_time: new Date().toISOString()
  })
  
  console.log(`âœ… è‡ªåŠ¨é‡å¯å®Œæˆï¼šé”€æ¯${totalDestroyed}å¼ å­¦ä¹ å¡`)
  
  return { totalDestroyed, affectedUsers: affectedUsers.length }
}
```

### Supabase Cron Job é…ç½®
```sql
-- åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
SELECT cron.schedule(
  'auto-restart-cards',
  '0 2 * * *',  -- æ¯å¤©2:00 AM
  $$
  SELECT net.http_post(
    url := 'https://your-project.supabase.co/functions/v1/auto-restart-cards',
    headers := '{"Content-Type": "application/json", "Authorization": "Bearer YOUR_ANON_KEY"}'::jsonb
  ) as request_id;
  $$
);
```

---

## ğŸ“Š æ•°æ®åº“è¡¨è®¾è®¡

### restart_logs è¡¨
```sql
CREATE TABLE restart_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  admin_id UUID,                          -- ç®¡ç†å‘˜IDï¼ˆè‡ªåŠ¨é‡å¯ä¸ºNULLï¼‰
  restart_type VARCHAR(20) NOT NULL,      -- 'manual' | 'auto'
  total_scanned INTEGER,                  -- æ‰«ææ€»æ•°
  total_destroyed INTEGER,                -- é”€æ¯æ•°é‡
  total_kept INTEGER,                     -- ä¿ç•™æ•°é‡
  affected_users JSONB,                   -- å—å½±å“ç”¨æˆ·åˆ—è¡¨
  restart_time TIMESTAMPTZ DEFAULT NOW(), -- é‡å¯æ—¶é—´
  details JSONB                           -- è¯¦ç»†ä¿¡æ¯
);

-- ç´¢å¼•
CREATE INDEX idx_restart_logs_time ON restart_logs(restart_time DESC);
CREATE INDEX idx_restart_logs_type ON restart_logs(restart_type);
```

### user_restart_stats è¡¨
```sql
CREATE TABLE user_restart_stats (
  user_id UUID PRIMARY KEY REFERENCES users(id),
  total_restarts INTEGER DEFAULT 0,       -- ç´¯è®¡é‡å¯æ¬¡æ•°
  this_week INTEGER DEFAULT 0,            -- æœ¬å‘¨é‡å¯æ¬¡æ•°
  this_month INTEGER DEFAULT 0,           -- æœ¬æœˆé‡å¯æ¬¡æ•°
  last_restart TIMESTAMPTZ,               -- æœ€è¿‘é‡å¯æ—¶é—´
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- æ¯å‘¨é‡ç½®
CREATE OR REPLACE FUNCTION reset_weekly_stats() RETURNS void AS $$
BEGIN
  UPDATE user_restart_stats SET this_week = 0;
END;
$$ LANGUAGE plpgsql;

-- æ¯æœˆé‡ç½®
CREATE OR REPLACE FUNCTION reset_monthly_stats() RETURNS void AS $$
BEGIN
  UPDATE user_restart_stats SET this_month = 0;
END;
$$ LANGUAGE plpgsql;
```

---

## ğŸ¨ å‰ç«¯ç®€åŒ–å®ç°

### ç”¨æˆ·ç«¯ï¼šåªæ˜¾ç¤ºç»Ÿè®¡
```vue
<template>
  <!-- é‡å¯ç»Ÿè®¡å¡ç‰‡ï¼ˆç®€åŒ–ç‰ˆï¼‰-->
  <div v-if="restartStats" class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-4 shadow-xl">
    <div class="text-white/90 text-xs mb-2 font-semibold">ğŸ”„ ç³»ç»Ÿé‡å¯ç»Ÿè®¡</div>
    
    <div class="grid grid-cols-2 gap-3 mb-2">
      <div class="bg-white/20 rounded-lg p-2 text-center">
        <div class="text-white text-2xl font-bold">{{ restartStats.this_week }}</div>
        <div class="text-white/80 text-xs">æœ¬å‘¨é‡å¯</div>
      </div>
      <div class="bg-white/20 rounded-lg p-2 text-center">
        <div class="text-white text-2xl font-bold">{{ restartStats.total_restarts }}</div>
        <div class="text-white/80 text-xs">ç´¯è®¡é‡å¯</div>
      </div>
    </div>
    
    <div class="text-white/70 text-xs text-center">
      æœ€è¿‘é‡å¯ï¼š{{ formatLastRestart(restartStats.last_restart) }}
    </div>
  </div>
</template>

<script setup>
const restartStats = ref(null)

// åŠ è½½é‡å¯ç»Ÿè®¡
const loadRestartStats = async () => {
  try {
    const { data } = await supabase
      .from('user_restart_stats')
      .select('*')
      .eq('user_id', user.value.id)
      .single()
    
    restartStats.value = data
  } catch (error) {
    console.error('åŠ è½½é‡å¯ç»Ÿè®¡å¤±è´¥:', error)
  }
}
</script>
```

---

## ğŸ”‘ æƒé™æ§åˆ¶

### ç®¡ç†å‘˜æƒé™æ£€æŸ¥
```typescript
// åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®é‡å¯åŠŸèƒ½
export async function checkAdminPermission(userId: string): Promise<boolean> {
  const { data } = await supabase
    .from('users')
    .select('is_admin')
    .eq('id', userId)
    .single()
  
  return data?.is_admin === true
}

// ç®¡ç†å‘˜é‡å¯å‡½æ•°
export async function manualRestart(adminId: string) {
  // æ£€æŸ¥æƒé™
  if (!await checkAdminPermission(adminId)) {
    throw new Error('æ— æƒé™æ“ä½œ')
  }
  
  // æ‰§è¡Œé‡å¯
  return await restartSystem()
}
```

---

## ğŸ“± ç”¨æˆ·é€šçŸ¥

### é‡å¯åé€šçŸ¥ç”¨æˆ·
```typescript
async function notifyUsersAfterRestart(affectedUsers: string[]) {
  for (const userId of affectedUsers) {
    await sendNotification(userId, {
      type: 'system_restart',
      title: 'ğŸ”„ å­¦ä¹ å¡å·²é‡å¯',
      message: 'æ‚¨çš„éƒ¨åˆ†å­¦ä¹ å¡å·²è¾¾æ ‡å¹¶è‡ªåŠ¨é”€æ¯ï¼Œå¯ä»¥å…‘æ¢æ–°çš„å­¦ä¹ å¡äº†ï¼',
      created_at: new Date().toISOString()
    })
  }
}
```

---

## ğŸ¯ æ€»ç»“

### åç«¯ï¼ˆç®¡ç†å‘˜ï¼‰
- âœ… å…¨å¹³å°æ‰«æåŠŸèƒ½
- âœ… æ‰‹åŠ¨/è‡ªåŠ¨é‡å¯
- âœ… å®šæ—¶ä»»åŠ¡é…ç½®
- âœ… è¯¦ç»†æ—¥å¿—è®°å½•

### å‰ç«¯ï¼ˆç”¨æˆ·ï¼‰
- âœ… ç®€æ´ç»Ÿè®¡æ˜¾ç¤º
- âœ… æœ¬å‘¨/ç´¯è®¡æ¬¡æ•°
- âœ… æœ€è¿‘é‡å¯æ—¶é—´
- âŒ æ— æ“ä½œæŒ‰é’®

### ä¼˜åŠ¿
1. **æƒé™åˆ†ç¦»**ï¼šç®¡ç†å‘˜æ§åˆ¶ï¼Œç”¨æˆ·åªè¯»
2. **è‡ªåŠ¨åŒ–**ï¼šå®šæ—¶ä»»åŠ¡è‡ªåŠ¨æ‰§è¡Œ
3. **ç®€æ´UI**ï¼šç”¨æˆ·ç•Œé¢ç®€å•æ¸…æ™°
4. **å¯è¿½æº¯**ï¼šè¯¦ç»†æ—¥å¿—è®°å½•

