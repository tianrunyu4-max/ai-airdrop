# 购买逻辑修改总结

## 📝 **用户需求**
1. 购买学习机改为使用U余额，不再使用积分
2. 底部提示文字改为："排队领取 学习机 毕业了可以持续学习送积分"

---

## ✅ **已完成的修改**

### **1. 前端UI修改（PointsView.vue）**

#### **购买判断逻辑：**
| 修改项 | 原逻辑 | 新逻辑 |
|--------|--------|--------|
| 检查余额 | 检查`transfer_points`（互转积分） | 检查`u_balance`（U余额） |
| 成本计算 | `purchaseCount * 100`积分 | `purchaseCount * 7`U |

**代码：**
```typescript
// 是否可以购买（使用U余额）
const canPurchase = computed(() => {
  const totalCostU = purchaseCount.value * 7 // 每台7U
  const uBalance = user.value?.u_balance || 0
  return uBalance >= totalCostU && myMachines.value.length + purchaseCount.value <= 10
})
```

#### **显示文字修改：**
| 位置 | 原文字 | 新文字 |
|------|--------|--------|
| 成本显示 | "总成本：XXX积分 ≈ XXXU" | "总成本：XXXU" |
| 按钮文字（不足时） | "积分不足" | "U余额不足" |
| 错误提示 | "积分不足或超出数量限制" | "U余额不足或超出数量限制" |
| 确认对话框 | "总成本：XXX积分（XXXU）" | "总成本：XXXU" |
| 底部提示 | "🎁 第一次免费送 · 出局后可复购或持续学习 送积分" | "🎁 排队领取 学习机 毕业了可以持续学习送积分" |

---

### **2. 后端逻辑修改（MiningService.ts）**

#### **购买扣款逻辑：**
| 修改项 | 原逻辑 | 新逻辑 |
|--------|--------|--------|
| 扣款方法 | `WalletManager.deductPoints()` | `WalletManager.deduct()` |
| 扣款数量 | 100积分 | 7U |
| 流水描述 | "购买学习机（100积分=7U）" | "购买学习机（7U）" |

**代码：**
```typescript
// 5. 如果不是第一次，扣除U余额（使用WalletManager - 自动验证+流水）
if (needsPayment) {
  await WalletManager.deduct(
    userId,
    MiningConfig.MACHINE.COST_IN_U, // 7U
    'mining_purchase',
    `购买${config.name}学习机（7U）`
  )
}
```

---

## 📊 **修改前后对比**

### **修改前（使用积分）：**
```
购买条件：互转积分 >= 100积分
显示：总成本：100积分 ≈ 7U
按钮：积分不足
扣款：扣除100积分
```

### **修改后（使用U）：**
```
购买条件：U余额 >= 7U
显示：总成本：7U
按钮：U余额不足
扣款：扣除7U
```

---

## 🔄 **数据流程**

### **购买流程：**
1. **用户点击购买** → 检查U余额是否 >= 7U × 数量
2. **余额充足** → 确认对话框显示："总成本：7U"
3. **用户确认** → 调用后端`MiningService.purchaseMachine`
4. **后端处理** → `WalletManager.deduct(userId, 7, ...)`
5. **扣除成功** → 创建学习机记录
6. **前端更新** → 重新加载学习机列表和用户余额

### **涉及的表和字段：**
- **users表**
  - `u_balance` - U余额（扣款来源） ✅
  - `transfer_points` - 互转积分（不再使用） ❌
- **transactions表**
  - 记录购买流水（类型：mining_purchase）
- **mining_machines表**
  - 创建新的学习机记录

---

## ⚠️ **重要注意事项**

### **1. 第一次购买仍然免费**
- 逻辑未改变：第一次购买不扣款
- 从第二次开始扣除7U

### **2. 奖励邀请人的逻辑**
- 购买成功后，邀请人仍然获得7U奖励
- 这部分逻辑未修改

### **3. 余额不足处理**
- 前端：提示"U余额不足"
- 后端：`WalletManager.deduct`自动检查余额，不足时抛出异常

### **4. 数据一致性**
- 所有购买记录都会写入`transactions`表
- 类型为`mining_purchase`
- 描述为"购买AI学习机（7U）"

---

## 🎯 **用户体验优化**

### **修改前的问题：**
- ❌ 用户需要先获得互转积分才能购买
- ❌ 显示"积分"和"U"两种单位，容易混淆
- ❌ 提示文字不够友好

### **修改后的改进：**
- ✅ 直接使用U购买，逻辑清晰
- ✅ 只显示U，单位统一
- ✅ 提示文字更友好："排队领取 学习机 毕业了可以持续学习送积分"

---

## 📂 **修改的文件清单**

1. ✅ `src/views/points/PointsView.vue`
   - 购买判断逻辑
   - UI显示文字
   - 确认对话框
   - 底部提示

2. ✅ `src/services/MiningService.ts`
   - 购买扣款逻辑
   - 从`deductPoints`改为`deduct`
   - 从扣100积分改为扣7U

---

## 🚀 **测试验证**

### **验证步骤：**
1. 访问 `http://localhost:3003`
2. 进入 **AI学习机** 页面
3. 检查以下内容：
   - ✅ 显示"总成本：7U"（不显示积分）
   - ✅ U余额不足时显示"U余额不足"
   - ✅ 底部显示"🎁 排队领取 学习机 毕业了可以持续学习送积分"
   - ✅ 确认对话框显示"总成本：7U"
   - ✅ 购买成功后扣除7U（不扣积分）

### **预期结果：**
- U余额 >= 7U → 可以购买
- U余额 < 7U → 按钮灰色，显示"U余额不足"
- 购买成功 → U余额减少7U，获得1台学习机
- 第一次购买 → 免费获得学习机

---

**修改完成时间：** 2025-10-08
**影响范围：** 前端UI + 后端购买逻辑
**风险等级：** 中（涉及支付逻辑）
**测试状态：** 待验证

