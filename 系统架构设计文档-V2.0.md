# ğŸ—ï¸ AIç§‘æŠ€åˆ›è–ªç³»ç»Ÿæ¶æ„è®¾è®¡æ–‡æ¡£ V2.0

> **åˆ›å»ºæ—¶é—´ï¼š** 2025-10-26  
> **çŠ¶æ€ï¼š** æ¶æ„è®¾è®¡é˜¶æ®µ  
> **ç›®æ ‡ï¼š** ç†æ¸…æ‰€æœ‰ä¸šåŠ¡é€»è¾‘ï¼Œé¿å…è¶Šæ”¹è¶Šä¹±

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒä¸šåŠ¡æ¨¡å—](#æ ¸å¿ƒä¸šåŠ¡æ¨¡å—)
2. [æ•°æ®è¡¨è®¾è®¡](#æ•°æ®è¡¨è®¾è®¡)
3. [ç›´æ¨å…³ç³»ç³»ç»Ÿ](#ç›´æ¨å…³ç³»ç³»ç»Ÿ)
4. [ç§¯åˆ†é‡Šæ”¾ç³»ç»Ÿ](#ç§¯åˆ†é‡Šæ”¾ç³»ç»Ÿ)
5. [Binaryå¯¹ç¢°ç³»ç»Ÿ](#binaryå¯¹ç¢°ç³»ç»Ÿ)
6. [æ•°æ®æµè½¬å›¾](#æ•°æ®æµè½¬å›¾)

---

## ğŸ¯ æ ¸å¿ƒä¸šåŠ¡æ¨¡å—

### æ¨¡å—å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  æ³¨å†Œ(æ¸¸å®¢) â†’ å……å€¼U â†’ å‡çº§AIä»£ç† â†’ æ¿€æ´»å­¦ä¹ å¡ â†’ æ¯æ—¥ç­¾åˆ°  â”‚
â”‚     â†“           â†“         â†“            â†“           â†“        â”‚
â”‚  æ— é‚€è¯·å…³ç³»   100U      å»ºç«‹ç›´æ¨å…³ç³»   æ¶ˆè€—100ç§¯åˆ†  é‡Šæ”¾ç§¯åˆ†â”‚
â”‚                         â†“                                    â”‚
â”‚                    åŠ å…¥Binaryç³»ç»Ÿ                            â”‚
â”‚                         â†“                                    â”‚
â”‚                   å¼€å§‹è·å¾—å¥–åŠ±                               â”‚
â”‚                    â”œâ”€ è§å•å¥–ï¼ˆç›´æ¨ï¼‰                        â”‚
â”‚                    â”œâ”€ å¯¹ç¢°å¥–ï¼ˆBinaryï¼‰                      â”‚
â”‚                    â”œâ”€ å¹³çº§å¥–ï¼ˆBinaryï¼‰                      â”‚
â”‚                    â””â”€ åˆ†çº¢å¥–ï¼ˆBinaryï¼‰                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ•°æ®è¡¨è®¾è®¡

### 1ï¸âƒ£ **usersï¼ˆç”¨æˆ·è¡¨ï¼‰** - åŸºç¡€ä¿¡æ¯

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  username VARCHAR(50) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  
  -- ä½™é¢ä¿¡æ¯
  u_balance DECIMAL(20, 2) DEFAULT 0,           -- Uä½™é¢ï¼ˆå¯æç°ï¼‰
  points_balance DECIMAL(20, 2) DEFAULT 0,      -- æ€»ç§¯åˆ†ä½™é¢ï¼ˆåªè¯»ï¼Œç”±è§¦å‘å™¨è®¡ç®—ï¼‰
  transfer_points DECIMAL(20, 2) DEFAULT 0,     -- äº’è½¬ç§¯åˆ†ï¼ˆå¯ç”¨äºæ¿€æ´»å­¦ä¹ å¡ã€äº’è½¬ï¼‰
  frozen_balance DECIMAL(20, 2) DEFAULT 0,      -- å†»ç»“ä½™é¢
  
  -- èº«ä»½ä¿¡æ¯
  is_agent BOOLEAN DEFAULT false,               -- æ˜¯å¦AIä»£ç†
  is_admin BOOLEAN DEFAULT false,               -- æ˜¯å¦ç®¡ç†å‘˜
  agent_paid_at TIMESTAMPTZ,                    -- æˆä¸ºä»£ç†æ—¶é—´
  
  -- é‚€è¯·ä¿¡æ¯
  invite_code VARCHAR(20) UNIQUE NOT NULL,      -- æˆ‘çš„é‚€è¯·ç 
  
  -- æ—¶é—´æˆ³
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- å…³é”®ç´¢å¼•
CREATE INDEX idx_users_is_agent ON users(is_agent);
CREATE INDEX idx_users_invite_code ON users(invite_code);

-- âš ï¸ æ³¨æ„ï¼šinviter_id å·²ç§»é™¤ï¼Œä½¿ç”¨ç‹¬ç«‹çš„ referral_relationships è¡¨
```

### 2ï¸âƒ£ **referral_relationshipsï¼ˆç›´æ¨å…³ç³»è¡¨ï¼‰** - â­ æ ¸å¿ƒæ–°å¢

```sql
CREATE TABLE referral_relationships (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  
  -- å…³ç³»åŒæ–¹ï¼ˆéƒ½å¿…é¡»æ˜¯AIä»£ç†ï¼‰
  referrer_id UUID NOT NULL REFERENCES users(id),  -- æ¨èäººï¼ˆä¸Šçº§ï¼‰
  referee_id UUID NOT NULL REFERENCES users(id),   -- è¢«æ¨èäººï¼ˆä¸‹çº§ï¼‰
  
  -- å…³ç³»å»ºç«‹æ—¶é—´
  created_at TIMESTAMPTZ DEFAULT NOW(),
  
  -- çŠ¶æ€
  is_active BOOLEAN DEFAULT true,                  -- å…³ç³»æ˜¯å¦æœ‰æ•ˆ
  
  -- å”¯ä¸€çº¦æŸï¼šä¸€ä¸ªäººåªèƒ½æœ‰ä¸€ä¸ªæ¨èäºº
  UNIQUE(referee_id)
);

-- ç´¢å¼•
CREATE INDEX idx_referral_referrer ON referral_relationships(referrer_id);
CREATE INDEX idx_referral_referee ON referral_relationships(referee_id);
CREATE INDEX idx_referral_active ON referral_relationships(is_active);

-- æ³¨é‡Š
COMMENT ON TABLE referral_relationships IS 'ç›´æ¨å…³ç³»è¡¨ï¼šè®°å½•AIä»£ç†ä¹‹é—´çš„æ¨èå…³ç³»';
COMMENT ON COLUMN referral_relationships.referrer_id IS 'æ¨èäººIDï¼ˆé‚€è¯·åˆ«äººçš„äººï¼‰';
COMMENT ON COLUMN referral_relationships.referee_id IS 'è¢«æ¨èäººIDï¼ˆè¢«é‚€è¯·çš„äººï¼‰';
```

**ä¸ºä»€ä¹ˆéœ€è¦ç‹¬ç«‹çš„ç›´æ¨å…³ç³»è¡¨ï¼Ÿ**

1. âœ… **ä¸šåŠ¡æ¸…æ™°**ï¼šç›´æ¨å…³ç³»æ˜¯ä¸šåŠ¡å…³ç³»ï¼Œåº”è¯¥ç‹¬ç«‹ç®¡ç†
2. âœ… **æŸ¥è¯¢é«˜æ•ˆ**ï¼šä¸“é—¨çš„è¡¨ï¼ŒæŸ¥è¯¢ç›´æ¨åˆ—è¡¨é€Ÿåº¦å¿«
3. âœ… **å†å²è¿½æº¯**ï¼šå¯ä»¥è®°å½•å…³ç³»å»ºç«‹æ—¶é—´ã€çŠ¶æ€å˜åŒ–
4. âœ… **æ‰©å±•æ€§å¼º**ï¼šæœªæ¥å¯ä»¥åŠ å­—æ®µï¼ˆå¦‚è§å•å¥–ç»Ÿè®¡ã€å…³ç³»å¤±æ•ˆç­‰ï¼‰

### 3ï¸âƒ£ **binary_membersï¼ˆBinaryå¯¹ç¢°ç³»ç»Ÿè¡¨ï¼‰** - æŠ€æœ¯å…³ç³»

```sql
CREATE TABLE binary_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID UNIQUE NOT NULL REFERENCES users(id),
  
  -- Binaryç³»ç»Ÿçš„æ’çº¿å…³ç³»ï¼ˆæŠ€æœ¯å…³ç³»ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ†é…ï¼‰
  upline_id UUID REFERENCES users(id),           -- ç³»ç»Ÿä¸Šçº§ï¼ˆè‡ªåŠ¨æ’çº¿ï¼‰
  position_side VARCHAR(1) CHECK (position_side IN ('A', 'B')),
  position_depth INTEGER DEFAULT 1,
  
  -- åŒºåŸŸä¸šç»©ç»Ÿè®¡
  a_side_count INTEGER DEFAULT 0,                -- AåŒºä¸šç»©
  b_side_count INTEGER DEFAULT 0,                -- BåŒºä¸šç»©
  a_side_pending INTEGER DEFAULT 0,              -- AåŒºå¾…å¯¹ç¢°
  b_side_pending INTEGER DEFAULT 0,              -- BåŒºå¾…å¯¹ç¢°
  
  -- è®¢å•æ•°ï¼ˆä¸€ç‚¹å¤šå•åˆ¶ï¼‰
  order_count INTEGER DEFAULT 1,
  
  -- å¥–åŠ±ç»Ÿè®¡
  total_pairing_bonus DECIMAL(20, 2) DEFAULT 0,  -- å¯¹ç¢°å¥–æ€»é¢
  total_level_bonus DECIMAL(20, 2) DEFAULT 0,    -- å¹³çº§å¥–æ€»é¢
  total_dividend DECIMAL(20, 2) DEFAULT 0,       -- åˆ†çº¢æ€»é¢
  total_earnings DECIMAL(20, 2) DEFAULT 0,       -- æ€»æ”¶ç›Š
  
  -- çŠ¶æ€
  is_active BOOLEAN DEFAULT true,
  reinvest_count INTEGER DEFAULT 0,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- âš ï¸ å…³é”®åŒºåˆ«ï¼š
-- referral_relationships.referrer_id = ä¸šåŠ¡æ¨èäººï¼ˆç›´æ¨å…³ç³»ï¼‰
-- binary_members.upline_id = ç³»ç»Ÿæ’çº¿ä¸Šçº§ï¼ˆå¯èƒ½ä¸æ˜¯åŒä¸€ä¸ªäººï¼‰
```

### 4ï¸âƒ£ **learning_cardsï¼ˆå­¦ä¹ å¡è¡¨ï¼‰**

```sql
CREATE TABLE learning_cards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  
  -- ç§¯åˆ†ä¿¡æ¯
  total_points DECIMAL(20, 2) DEFAULT 300,       -- æ€»ç§¯åˆ†ï¼ˆ100*3å€ï¼‰
  released_points DECIMAL(20, 2) DEFAULT 0,      -- å·²é‡Šæ”¾ç§¯åˆ†
  
  -- çŠ¶æ€
  status VARCHAR(20) DEFAULT 'active',           -- active, completed, expired
  is_active BOOLEAN DEFAULT true,
  
  -- é‡Šæ”¾ä¿¡æ¯
  last_release_date DATE,                        -- æœ€åé‡Šæ”¾æ—¥æœŸ
  last_checkin_date DATE,                        -- æœ€åç­¾åˆ°æ—¥æœŸ
  
  -- æ—¶é—´
  created_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ,                        -- å‡ºå±€æ—¶é—´
  
  -- å…ƒæ•°æ®
  metadata JSONB                                 -- é¢å¤–ä¿¡æ¯
);
```

### 5ï¸âƒ£ **transactionsï¼ˆäº¤æ˜“æµæ°´è¡¨ï¼‰**

```sql
CREATE TABLE transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  
  -- äº¤æ˜“ä¿¡æ¯
  type VARCHAR(50) NOT NULL,                     -- äº¤æ˜“ç±»å‹
  amount DECIMAL(20, 2) NOT NULL,                -- é‡‘é¢
  balance_after DECIMAL(20, 2),                  -- ä½™é¢ï¼ˆäº¤æ˜“åï¼‰
  
  -- æè¿°
  description VARCHAR(500),                      -- âœ… æ‰©å±•åˆ°500å­—ç¬¦
  
  -- å…³è”ä¿¡æ¯
  related_user_id UUID REFERENCES users(id),     -- å…³è”ç”¨æˆ·
  currency VARCHAR(20) DEFAULT 'U',              -- è´§å¸ç±»å‹
  
  -- å…ƒæ•°æ®
  metadata JSONB,
  
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- äº¤æ˜“ç±»å‹å®šä¹‰
-- 'agent_purchase'      - è´­ä¹°AIä»£ç†ï¼ˆ-30Uï¼‰
-- 'binary_auto_gift'    - Binaryç³»ç»Ÿèµ é€ç§¯åˆ†ï¼ˆ+100ç§¯åˆ†ï¼‰
-- 'card_purchase'       - è´­ä¹°å­¦ä¹ å¡ï¼ˆ-8Uæˆ–-100ç§¯åˆ†ï¼‰
-- 'daily_release'       - æ¯æ—¥é‡Šæ”¾ï¼ˆ+Uæˆ–+ç§¯åˆ†ï¼‰
-- 'pairing_bonus'       - å¯¹ç¢°å¥–ï¼ˆ+Uï¼‰
-- 'level_bonus'         - å¹³çº§å¥–ï¼ˆ+Uï¼‰
-- 'dividend'            - åˆ†çº¢ï¼ˆ+Uï¼‰
-- 'transfer_out'        - è½¬å‡ºï¼ˆ-Uæˆ–-ç§¯åˆ†ï¼‰
-- 'transfer_in'         - è½¬å…¥ï¼ˆ+Uæˆ–+ç§¯åˆ†ï¼‰
-- 'recharge'            - å……å€¼ï¼ˆ+Uï¼‰
-- 'withdraw'            - æç°ï¼ˆ-Uï¼‰
```

---

## ğŸ‘¥ ç›´æ¨å…³ç³»ç³»ç»Ÿ

### æ ¸å¿ƒæ¦‚å¿µ

```
ç›´æ¨å…³ç³»ï¼ˆReferral Relationshipï¼‰= ä¸šåŠ¡æ¨èå…³ç³»
- è°é‚€è¯·æˆ‘å‡çº§AIä»£ç†ï¼Ÿ
- æˆ‘çš„ç›´æ¨å›¢é˜Ÿæœ‰å¤šå°‘äººï¼Ÿ
- ç”¨äºï¼šè§å•å¥–ã€åŠ é€Ÿé‡Šæ”¾ç‡è®¡ç®—
```

### å»ºç«‹æ—¶æœº

```
âŒ é”™è¯¯ï¼šæ³¨å†Œæ—¶å¡«å†™é‚€è¯·ç  â†’ å»ºç«‹å…³ç³»
âœ… æ­£ç¡®ï¼šå‡çº§AIä»£ç†æ—¶å¡«å†™é‚€è¯·ç  â†’ å»ºç«‹å…³ç³»

åŸå› ï¼š
1. åªæœ‰ä»˜è´¹AIä»£ç†æ‰å‚ä¸å¥–åŠ±ä½“ç³»
2. å…è´¹ç”¨æˆ·ä¸åº”è¯¥å ç”¨é‚€è¯·å…³ç³»
3. å‡è½»ç³»ç»Ÿè´Ÿæ‹…
```

### æ•°æ®æ“ä½œ

**1. åˆ›å»ºç›´æ¨å…³ç³»**
```sql
-- ç”¨æˆ·Aï¼ˆID=user_aï¼‰é‚€è¯·ç”¨æˆ·Bï¼ˆID=user_bï¼‰å‡çº§AIä»£ç†
INSERT INTO referral_relationships (referrer_id, referee_id)
VALUES ('user_a', 'user_b')
ON CONFLICT (referee_id) DO NOTHING;  -- é˜²æ­¢é‡å¤
```

**2. æŸ¥è¯¢æˆ‘çš„ç›´æ¨åˆ—è¡¨**
```sql
SELECT 
  u.id, 
  u.username, 
  u.created_at,
  r.created_at as referral_created_at
FROM referral_relationships r
JOIN users u ON r.referee_id = u.id
WHERE r.referrer_id = 'my_user_id'
  AND r.is_active = true
  AND u.is_agent = true
ORDER BY r.created_at DESC;
```

**3. æŸ¥è¯¢æˆ‘çš„æ¨èäºº**
```sql
SELECT 
  u.id, 
  u.username
FROM referral_relationships r
JOIN users u ON r.referrer_id = u.id
WHERE r.referee_id = 'my_user_id'
  AND r.is_active = true;
```

**4. ç»Ÿè®¡ç›´æ¨äººæ•°**
```sql
SELECT COUNT(*) as direct_count
FROM referral_relationships
WHERE referrer_id = 'my_user_id'
  AND is_active = true;
```

### ç›´æ¨å…³ç³»çš„ä¸¤å¤§ç”¨é€”

#### ç”¨é€”1ï¸âƒ£: **åŠ é€Ÿé‡Šæ”¾ç‡è®¡ç®—**

```typescript
// è®¡ç®—é‡Šæ”¾ç‡
function calculateReleaseRate(userId: string): number {
  // 1. æŸ¥è¯¢ç›´æ¨äººæ•°
  const directCount = await supabase
    .from('referral_relationships')
    .select('*', { count: 'exact' })
    .eq('referrer_id', userId)
    .eq('is_active', true)
  
  // 2. è®¡ç®—åŠ é€Ÿç‡
  const baseRate = 0.01      // åŸºç¡€1%
  const boostRate = Math.min(directCount * 0.03, 0.15)  // æ¯äºº+3%ï¼Œæœ€é«˜15%
  
  return baseRate + boostRate
}

// ç¤ºä¾‹ï¼š
// 0ä¸ªç›´æ¨ â†’ 1%
// 1ä¸ªç›´æ¨ â†’ 1% + 3% = 4%
// 2ä¸ªç›´æ¨ â†’ 1% + 6% = 7%
// 3ä¸ªç›´æ¨ â†’ 1% + 9% = 10%
// 4ä¸ªç›´æ¨ â†’ 1% + 12% = 13%
// 5ä¸ªç›´æ¨ â†’ 1% + 15% = 16%ï¼ˆå°é¡¶15%ï¼‰
```

#### ç”¨é€”2ï¸âƒ£: **è§å•å¥–ï¼ˆæ¨èå¥–ï¼‰**

```typescript
// è§å•å¥–é€»è¾‘
async function onNewAgentJoined(newUserId: string, referrerId: string) {
  // 1. æ–°ç”¨æˆ·å‡çº§AIä»£ç†ï¼ˆæ”¯ä»˜30Uï¼‰
  // 2. æŸ¥è¯¢æ¨èäºº
  // 3. å‘æ”¾è§å•å¥–ç»™æ¨èäºº
  
  const REFERRAL_BONUS = 5  // è§å•å¥–ï¼š5U
  
  await WalletManager.add(
    referrerId,
    REFERRAL_BONUS,
    'referral_bonus',
    `ç›´æ¨è§å•å¥–ï¼šæ¨è${newUser.username}å‡çº§AIä»£ç†`
  )
}
```

---

## ğŸ“ˆ ç§¯åˆ†é‡Šæ”¾ç³»ç»Ÿ

### é‡Šæ”¾å…¬å¼

```
æ¯æ—¥é‡Šæ”¾ç§¯åˆ† = å­¦ä¹ å¡æœ¬é‡‘(100) Ã— é‡Šæ”¾ç‡

é‡Šæ”¾ç‡ = åŸºç¡€é‡Šæ”¾ç‡(1%) + ç›´æ¨åŠ é€Ÿç‡

ç›´æ¨åŠ é€Ÿç‡ = ç›´æ¨äººæ•° Ã— 3%ï¼Œæœ€é«˜15%
```

### ç§¯åˆ†åˆ†é…

```
æ¯æ—¥é‡Šæ”¾çš„ç§¯åˆ†åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š
â”œâ”€ 70% â†’ Uä½™é¢ï¼ˆå¯æç°ï¼‰
â””â”€ 30% â†’ äº’è½¬ç§¯åˆ†ï¼ˆå¯æ¿€æ´»å­¦ä¹ å¡ã€å¯äº’è½¬ï¼‰

ä¾‹å¦‚ï¼š
é‡Šæ”¾10ç§¯åˆ† â†’ 7U + 3äº’è½¬ç§¯åˆ†
```

### ç§¯åˆ†å­—æ®µå…³ç³»

```
points_balanceï¼ˆæ€»ç§¯åˆ†ï¼‰     = æ‰€æœ‰å­¦ä¹ å¡ç´¯è®¡é‡Šæ”¾çš„ç§¯åˆ†æ€»å’Œ
                            = SUM(released_points) from learning_cards
                            = åªè¯»å­—æ®µï¼Œä¸ç›´æ¥ä¿®æ”¹

transfer_pointsï¼ˆäº’è½¬ç§¯åˆ†ï¼‰  = å¯ç”¨äºäº’è½¬å’Œæ¿€æ´»å­¦ä¹ å¡çš„ç§¯åˆ†
                            = æ¯æ—¥é‡Šæ”¾çš„30%
                            = å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹ï¼ˆæ¶ˆè´¹ã€äº’è½¬ï¼‰

å…³ç³»ï¼š
transfer_points âŠ† points_balance
```

### æ¯æ—¥é‡Šæ”¾æµç¨‹

```sql
-- Edge Function: æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ

1. æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒå­¦ä¹ å¡
SELECT * FROM learning_cards 
WHERE status = 'active' 
  AND is_active = true
  AND (last_release_date IS NULL OR last_release_date < CURRENT_DATE);

2. å¯¹æ¯å¼ å­¦ä¹ å¡ï¼š
   a. è·å–ç”¨æˆ·çš„ç›´æ¨äººæ•°
   b. è®¡ç®—é‡Šæ”¾ç‡
   c. è®¡ç®—é‡Šæ”¾ç§¯åˆ†
   d. åˆ†é…ç§¯åˆ†ï¼ˆ70%â†’Uï¼Œ30%â†’äº’è½¬ï¼‰
   e. æ›´æ–°ä½™é¢
   f. è®°å½•æµæ°´
   g. æ£€æŸ¥æ˜¯å¦å‡ºå±€
```

### ä»£ç å®ç°

```typescript
async function dailyReleaseForCard(card: LearningCard) {
  // 1. è·å–ç›´æ¨äººæ•°
  const { count: directCount } = await supabase
    .from('referral_relationships')
    .select('*', { count: 'exact' })
    .eq('referrer_id', card.user_id)
    .eq('is_active', true)
  
  // 2. è®¡ç®—é‡Šæ”¾ç‡
  const baseRate = 0.01
  const boostRate = Math.min(directCount * 0.03, 0.15)
  const releaseRate = baseRate + boostRate
  
  // 3. è®¡ç®—é‡Šæ”¾ç§¯åˆ†
  const releaseAmount = 100 * releaseRate
  
  // 4. åˆ†é…ç§¯åˆ†
  const toU = releaseAmount * 0.7
  const toTransfer = releaseAmount * 0.3
  
  // 5. æ›´æ–°ä½™é¢ï¼ˆä½¿ç”¨RPCå‡½æ•°ä¿è¯åŸå­æ€§ï¼‰
  await supabase.rpc('add_user_balance', {
    p_user_id: card.user_id,
    p_amount: toU
  })
  
  await supabase.rpc('add_transfer_points', {
    p_user_id: card.user_id,
    p_amount: toTransfer
  })
  
  // 6. æ›´æ–°å­¦ä¹ å¡
  await supabase
    .from('learning_cards')
    .update({
      released_points: card.released_points + releaseAmount,
      last_release_date: new Date().toISOString().split('T')[0]
    })
    .eq('id', card.id)
  
  // 7. è®°å½•æµæ°´
  await TransactionLogger.log({
    user_id: card.user_id,
    type: 'daily_release',
    amount: toU,
    description: `å­¦ä¹ å¡æ¯æ—¥é‡Šæ”¾: ${releaseAmount.toFixed(2)}ç§¯åˆ† (é‡Šæ”¾ç‡${(releaseRate*100).toFixed(1)}%)`,
    currency: 'U',
    metadata: {
      card_id: card.id,
      release_rate: releaseRate,
      direct_count: directCount,
      to_u: toU,
      to_transfer: toTransfer
    }
  })
  
  // 8. æ£€æŸ¥å‡ºå±€
  if (card.released_points >= card.total_points) {
    await supabase
      .from('learning_cards')
      .update({ 
        status: 'completed',
        is_active: false,
        expires_at: new Date().toISOString()
      })
      .eq('id', card.id)
  }
}
```

---

## ğŸ”„ Binaryå¯¹ç¢°ç³»ç»Ÿ

### Binaryç³»ç»Ÿ vs ç›´æ¨å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç‰¹å¾           â”‚   ç›´æ¨å…³ç³»    â”‚   Binaryç³»ç»Ÿ      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å…³ç³»ç±»å‹           â”‚  ä¸šåŠ¡å…³ç³»     â”‚   æŠ€æœ¯å…³ç³»       â”‚
â”‚  å»ºç«‹æ–¹å¼           â”‚  äººå·¥é€‰æ‹©     â”‚   ç³»ç»Ÿè‡ªåŠ¨æ’çº¿   â”‚
â”‚  æ•°æ®è¡¨             â”‚  referral_    â”‚   binary_members â”‚
â”‚                     â”‚  relationshipsâ”‚                  â”‚
â”‚  å…³ç³»å­—æ®µ           â”‚  referrer_id  â”‚   upline_id      â”‚
â”‚  ç”¨é€”               â”‚  è§å•å¥–ã€åŠ é€Ÿ â”‚   å¯¹ç¢°å¥–ã€å¹³çº§å¥– â”‚
â”‚  æ˜¯å¦å¯èƒ½ä¸åŒ       â”‚  âœ… æ˜¯        â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¾‹å¦‚ï¼š
- ç”¨æˆ·Aé‚€è¯·ç”¨æˆ·Bå‡çº§ä»£ç†ï¼ˆç›´æ¨å…³ç³»ï¼‰
  referral: B.referrer_id = A
  
- ä½†ç³»ç»Ÿå¯èƒ½æŠŠBæ’åˆ°Cçš„ä¸‹é¢ï¼ˆBinaryå…³ç³»ï¼‰
  binary: B.upline_id = C (å› ä¸ºCçš„å¼±åŒºéœ€è¦äºº)
```

### Binaryæ’çº¿è§„åˆ™

```
1. ä¼˜å…ˆæ”¾åœ¨æ¨èäººï¼ˆreferrerï¼‰çš„å¼±åŒº
2. å¦‚æœæ¨èäººæ²¡æœ‰åŠ å…¥Binaryï¼Œæ”¾åœ¨åˆ›ä¸–èŠ‚ç‚¹
3. å¼±åŒºä¼˜å…ˆï¼šAåŒºå°‘æ”¾AåŒºï¼ŒBåŒºå°‘æ”¾BåŒº
4. 1:1å¹³è¡¡åŸåˆ™
```

### å‡çº§AIä»£ç†æ—¶çš„å®Œæ•´æµç¨‹

```typescript
async function becomeAgent(userId: string, inviteCode: string) {
  // 1. éªŒè¯é‚€è¯·ç ï¼Œè·å–æ¨èäºº
  const referrer = await getUserByInviteCode(inviteCode)
  
  // 2. æ‰£é™¤30U
  await WalletManager.deduct(userId, 30, 'agent_purchase', 'å‡çº§AIä»£ç†')
  
  // 3. è®¾ç½®ä¸ºAIä»£ç†
  await supabase
    .from('users')
    .update({ is_agent: true })
    .eq('id', userId)
  
  // 4. â­ å»ºç«‹ç›´æ¨å…³ç³»ï¼ˆå†™å…¥referral_relationshipsè¡¨ï¼‰
  await supabase
    .from('referral_relationships')
    .insert({
      referrer_id: referrer.id,
      referee_id: userId
    })
  
  // 5. èµ é€100äº’è½¬ç§¯åˆ†
  await WalletManager.addTransferPoints(userId, 100, 'binary_auto_gift', 'èµ é€100äº’è½¬ç§¯åˆ†')
  
  // 6. â­ åŠ å…¥Binaryç³»ç»Ÿï¼ˆå†™å…¥binary_membersè¡¨ï¼‰
  setTimeout(async () => {
    const placement = await findBestPlacement(referrer.id)
    await supabase
      .from('binary_members')
      .insert({
        user_id: userId,
        upline_id: placement.uplineId,  // æ³¨æ„ï¼šå¯èƒ½ â‰  referrer.id
        position_side: placement.side,
        position_depth: placement.depth
      })
  }, 100)
  
  // 7. å‘æ”¾è§å•å¥–ç»™æ¨èäºº
  await WalletManager.add(
    referrer.id, 
    5, 
    'referral_bonus', 
    `ç›´æ¨è§å•å¥–`
  )
  
  return { success: true }
}
```

---

## ğŸ”€ æ•°æ®æµè½¬å›¾

### ç”¨æˆ·å‡çº§AIä»£ç†

```
ç”¨æˆ·å¡«å†™é‚€è¯·ç æäº¤
    â†“
éªŒè¯é‚€è¯·ç æœ‰æ•ˆæ€§
    â†“
æ‰£é™¤30Uä½™é¢
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¹¶è¡Œæ‰§è¡Œ4ä¸ªæ“ä½œï¼ˆPromise.allï¼‰          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. usersè¡¨ï¼šè®¾ç½®is_agent=true           â”‚
â”‚ 2. referral_relationshipsï¼šå»ºç«‹ç›´æ¨å…³ç³» â”‚
â”‚ 3. èµ é€100äº’è½¬ç§¯åˆ†                      â”‚
â”‚ 4. å‘æ”¾5Uè§å•å¥–ç»™æ¨èäºº                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
åå°å¼‚æ­¥ï¼ˆ100msåï¼‰
    â†“
åŠ å…¥Binaryç³»ç»Ÿï¼ˆbinary_membersè¡¨ï¼‰
    â†“
å®Œæˆ
```

### æ¯æ—¥ç§¯åˆ†é‡Šæ”¾

```
å‡Œæ™¨2ç‚¹ Edge Functionè§¦å‘
    â†“
æŸ¥è¯¢æ‰€æœ‰æ´»è·ƒå­¦ä¹ å¡
    â†“
FOR EACH å­¦ä¹ å¡:
    â†“
    1. æŸ¥è¯¢ç›´æ¨äººæ•°ï¼ˆreferral_relationshipsï¼‰
    â†“
    2. è®¡ç®—é‡Šæ”¾ç‡ = 1% + ç›´æ¨äººæ•°*3%
    â†“
    3. è®¡ç®—é‡Šæ”¾ç§¯åˆ† = 100 * é‡Šæ”¾ç‡
    â†“
    4. åˆ†é…ç§¯åˆ†ï¼š70%â†’Uä½™é¢ï¼Œ30%â†’äº’è½¬ç§¯åˆ†
    â†“
    5. è°ƒç”¨RPCæ›´æ–°ä½™é¢ï¼ˆåŸå­æ“ä½œï¼‰
    â†“
    6. è®°å½•äº¤æ˜“æµæ°´ï¼ˆtransactionsè¡¨ï¼‰
    â†“
    7. æ›´æ–°å­¦ä¹ å¡é‡Šæ”¾è®°å½•
    â†“
    8. æ£€æŸ¥æ˜¯å¦å‡ºå±€ï¼ˆreleased >= totalï¼‰
    â†“
å®Œæˆ
```

---

## âœ… å…³é”®é—®é¢˜çš„æ˜ç¡®ç­”æ¡ˆ

### Q1: ç›´æ¨å…³ç³»ä½•æ—¶å»ºç«‹ï¼Ÿ
**A:** å‡çº§AIä»£ç†æ—¶ï¼Œå¡«å†™é‚€è¯·ç åå»ºç«‹ï¼ˆå†™å…¥`referral_relationships`è¡¨ï¼‰

### Q2: points_balance vs transfer_pointsï¼Ÿ
**A:** 
- `points_balance` = åªè¯»ï¼Œå­¦ä¹ å¡ç´¯è®¡é‡Šæ”¾æ€»å’Œ
- `transfer_points` = å¯è¯»å†™ï¼Œæ¯æ—¥é‡Šæ”¾çš„30%ï¼Œå¯ç”¨äºæ¿€æ´»å­¦ä¹ å¡å’Œäº’è½¬

### Q3: inviter_id vs upline_idï¼Ÿ
**A:**
- `referral_relationships.referrer_id` = ä¸šåŠ¡æ¨èäººï¼ˆäººå·¥é€‰æ‹©ï¼‰
- `binary_members.upline_id` = Binaryç³»ç»Ÿä¸Šçº§ï¼ˆè‡ªåŠ¨æ’çº¿ï¼‰
- ä¸¤è€…å¯èƒ½ä¸åŒï¼

### Q4: ç›´æ¨å…³ç³»çš„ç”¨é€”ï¼Ÿ
**A:**
1. è®¡ç®—åŠ é€Ÿé‡Šæ”¾ç‡ï¼ˆæ¯ä¸ªç›´æ¨+3%ï¼Œæœ€é«˜15%ï¼‰
2. å‘æ”¾è§å•å¥–ï¼ˆæ¨èä¸€ä¸ªäººå‡çº§ä»£ç†ï¼Œè·å¾—5Uï¼‰

### Q5: ä¸ºä»€ä¹ˆè¦ç‹¬ç«‹çš„ç›´æ¨å…³ç³»è¡¨ï¼Ÿ
**A:**
1. ä¸šåŠ¡æ¸…æ™°ï¼šç›´æ¨æ˜¯ä¸šåŠ¡å…³ç³»ï¼Œåº”ç‹¬ç«‹ç®¡ç†
2. æŸ¥è¯¢é«˜æ•ˆï¼šä¸“é—¨çš„è¡¨ï¼Œç´¢å¼•ä¼˜åŒ–
3. å†å²è¿½æº¯ï¼šå¯è®°å½•å…³ç³»å˜åŒ–å†å²
4. æ‰©å±•æ€§å¼ºï¼šæœªæ¥å¯åŠ ç»Ÿè®¡å­—æ®µ

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### 1. æ•°æ®åº“è¿ç§»
- [ ] åˆ›å»º `referral_relationships` è¡¨
- [ ] ä¿®æ”¹ `transactions.description` å­—æ®µé•¿åº¦ä¸º500
- [ ] åˆ›å»ºç›¸å…³ç´¢å¼•å’Œçº¦æŸ

### 2. ä»£ç é‡æ„
- [ ] `AgentService.becomeAgent()` - ä½¿ç”¨ç›´æ¨å…³ç³»è¡¨
- [ ] `MiningService.dailyRelease()` - ä»ç›´æ¨å…³ç³»è¡¨æŸ¥è¯¢ç›´æ¨äººæ•°
- [ ] `TeamView.vue` - ä»ç›´æ¨å…³ç³»è¡¨æŸ¥è¯¢å›¢é˜Ÿæ•°æ®

### 3. æµ‹è¯•éªŒè¯
- [ ] æµ‹è¯•å‡çº§ä»£ç†æµç¨‹
- [ ] æµ‹è¯•ç›´æ¨äººæ•°ç»Ÿè®¡
- [ ] æµ‹è¯•é‡Šæ”¾ç‡è®¡ç®—
- [ ] æµ‹è¯•è§å•å¥–å‘æ”¾

---

**æ–‡æ¡£çŠ¶æ€ï¼š** âœ… æ¶æ„è®¾è®¡å®Œæˆï¼Œå¾…å®æ–½

