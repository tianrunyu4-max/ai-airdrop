# 📚 学习卡重启机制 - 需求文档

## 🎯 核心需求

### 1. 学习卡生命周期管理

#### 达标条件
- ✅ **时间要求**：运行满5天
- ✅ **释放率要求**：加速释放率达到3%-15%
- ✅ **状态要求**：活跃状态（未手动停止）

#### 达标后处理
- 🔥 **自动销毁**：删除学习卡记录
- 🛑 **停止运行**：不再参与签到释放
- 📝 **记录清理**：从localStorage移除
- 💰 **最终结算**：记录总收益

#### 未达标处理
- ✅ **继续运行**：保留学习卡
- 📈 **持续加速**：继续累积释放率
- ⏰ **每日签到**：正常参与释放

---

## 🔧 实现方案

### 方案1：自动检测机制（推荐）

**触发时机**：
1. 每日签到时自动检测
2. 刷新页面时检查
3. 用户点击"重启"按钮

**检测逻辑**：
```javascript
function checkCardStatus(card) {
  // 1. 计算运行天数
  const createdDate = new Date(card.created_at)
  const today = new Date()
  const daysPassed = Math.floor((today - createdDate) / (1000 * 60 * 60 * 24))
  
  // 2. 检查释放率
  const currentRate = card.base_rate + card.boost_rate
  
  // 3. 判断是否达标
  const isQualified = daysPassed >= 5 && currentRate >= 0.03 && currentRate <= 0.15
  
  return {
    isQualified,
    daysPassed,
    currentRate,
    shouldDestroy: isQualified
  }
}
```

**处理流程**：
```
签到 → 检测所有学习卡
  ↓
达标？
  ├─ 是 → 销毁卡片 → 记录总收益 → 删除记录
  └─ 否 → 继续运行 → 累积天数 → 下次检测
```

---

### 方案2：手动重启按钮

**UI位置**：AI学习卡页面
**按钮名称**："🔄 重启系统"
**功能**：
- 检测所有学习卡状态
- 删除达标的卡片
- 显示处理结果

**流程**：
```
点击重启按钮
  ↓
扫描所有学习卡
  ↓
分类处理
  ├─ 达标的卡片 → 销毁 → 统计收益
  └─ 未达标的卡片 → 保留 → 继续运行
  ↓
显示处理结果
  - 已销毁：X张
  - 保留运行：X张
  - 累计收益：X U
```

---

## 📊 数据结构

### 学习卡状态字段
```typescript
interface LearningCard {
  id: string
  user_id: string
  created_at: string          // 创建时间
  last_checkin_date: string   // 最后签到时间
  base_rate: number           // 基础释放率 1%
  boost_rate: number          // 加速释放率 0-14%
  total_points: number        // 总积分 300
  released_points: number     // 已释放积分
  status: 'active' | 'completed' | 'destroyed'  // 状态
  days_active: number         // 活跃天数
  is_qualified: boolean       // 是否达标
}
```

### 销毁记录
```typescript
interface DestroyRecord {
  id: string
  card_id: string
  user_id: string
  destroy_reason: string      // 销毁原因："达标自动销毁"
  days_active: number         // 运行天数
  final_rate: number          // 最终释放率
  total_earned: number        // 总收益
  destroyed_at: string        // 销毁时间
}
```

---

## 🎨 UI设计

### 重启按钮位置
```
AI学习卡页面
  ├─ 顶部资产卡片
  ├─ 签到卡片
  ├─ 兑换卡片
  └─ [新增] 重启系统按钮
      ↓
  我的学习卡列表
```

### 重启提示
```
🔄 系统重启

检测到以下学习卡已达标：
✅ AI学习机 #1 - 运行5天 - 释放率15%
✅ AI学习机 #2 - 运行6天 -释放率12%

未达标学习卡将继续运行：
⏰ AI学习机 #3 - 运行3天 - 释放率8%

确认销毁达标学习卡？
[取消] [确认销毁]
```

---

## 🔄 自动化流程

### 签到时自动检测
```javascript
async function checkin() {
  // 1. 执行签到
  const result = await performCheckin()
  
  // 2. 自动检测达标卡片
  const qualifiedCards = await detectQualifiedCards()
  
  // 3. 如果有达标的，提示用户
  if (qualifiedCards.length > 0) {
    showDestroyNotification(qualifiedCards)
  }
  
  return result
}
```

### 每日定时检测（可选）
```javascript
// 每天0点自动检测
cron.schedule('0 0 * * *', async () => {
  const allCards = await getAllActiveCards()
  
  for (const card of allCards) {
    if (isQualified(card)) {
      await destroyCard(card)
      await notifyUser(card.user_id, '学习卡已达标并自动销毁')
    }
  }
})
```

---

## 📝 实现清单

### 前端
- [ ] 添加"重启系统"按钮
- [ ] 创建检测达标卡片函数
- [ ] 创建销毁卡片UI
- [ ] 显示处理结果统计
- [ ] 签到时自动检测提示

### 后端
- [ ] 创建检测达标逻辑
- [ ] 创建销毁卡片函数
- [ ] 记录销毁日志
- [ ] 统计总收益

### 数据库
- [ ] 添加`destroy_records`表
- [ ] 添加`is_qualified`字段
- [ ] 添加`days_active`字段
- [ ] 创建销毁记录索引

---

## 🎯 用户体验

### 自动化
- ✅ 签到时自动检测
- ✅ 达标后自动提示
- ✅ 一键销毁确认

### 透明化
- ✅ 显示运行天数
- ✅ 显示当前释放率
- ✅ 显示达标进度
- ✅ 显示总收益统计

### 可控性
- ✅ 手动重启按钮
- ✅ 批量处理
- ✅ 单卡查看详情

---

## 🚀 分阶段实现

### Phase 1: 基础检测（本次）
- ✅ 计算运行天数
- ✅ 检测释放率范围
- ✅ 判断是否达标

### Phase 2: 手动重启（本次）
- ✅ 添加重启按钮
- ✅ 扫描所有卡片
- ✅ 批量销毁达标卡片

### Phase 3: 自动化（后续）
- 签到时自动检测
- 自动提示用户
- 定时任务清理

### Phase 4: 数据统计（后续）
- 销毁记录查询
- 收益统计图表
- 卡片生命周期分析

---

**总结**：实现学习卡智能生命周期管理，达标自动销毁，未达标继续加速！

