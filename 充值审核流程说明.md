# 充值审核流程说明

## 🎯 如何防止假充值？

### ✅ **3层验证机制**

```
1️⃣ 用户提交申请 → 填写金额和交易哈希
2️⃣ 管理员审核 → 验证交易真实性
3️⃣ 确认到账 → 系统自动加余额
```

---

## 📋 完整流程

### **用户端（提交充值申请）**

```
步骤1：打开"我的"页面 → 点击"💰 充值"
步骤2：选择网络（TRC20 或 BEP20）
步骤3：复制收款地址：
       - TRC20：TQTjfehUeHRWkw7QkcRKojWYdzYPebr9iS
       - BEP20：0xc8288b98f7c2cc11bccbc033754effcc87c1909e
步骤4：在钱包转账（最低30 USDT）
步骤5：填写充值信息：
       - 充值金额：例如 30
       - 交易哈希：例如 a1b2c3d4e5f6...（区块链交易ID）
步骤6：点击"✅ 提交充值"
步骤7：等待管理员审核
```

---

### **管理员端（验证和确认）**

#### **步骤1：进入审核页面**

```
登录后台 → 点击左侧菜单"💰 充值管理"
```

#### **步骤2：查看待审核充值**

看到类似这样的列表：

```
┌──────────┬────────┬────────┬─────────────────────┬──────────┬────────┬────────┐
│ 用户     │ 金额   │ 网络   │ 交易哈希             │ 时间     │ 状态   │ 操作   │
├──────────┼────────┼────────┼─────────────────────┼──────────┼────────┼────────┤
│ 张三     │ 30 USDT│ TRC20  │ a1b2c3d4e5f6...     │ 10:30    │ 待审核 │ ✅ ❌  │
│ 李四     │ 50 USDT│ BEP20  │ 9x8y7z6w5v4u...     │ 11:15    │ 待审核 │ ✅ ❌  │
└──────────┴────────┴────────┴─────────────────────┴──────────┴────────┴────────┘
```

#### **步骤3：验证交易真实性** ⚠️ **重要！**

##### **方法1：复制交易哈希到区块浏览器查询**

**TRC20（波场链）：**
1. 打开：https://tronscan.org/
2. 在搜索框粘贴交易哈希
3. 查看交易详情：
   - ✅ **收款地址**：必须是 `TQTjfehUeHRWkw7QkcRKojWYdzYPebr9iS`
   - ✅ **转账金额**：必须≥用户填写的金额（例如30 USDT）
   - ✅ **代币类型**：必须是 `USDT`
   - ✅ **交易状态**：必须是 `成功` 或 `Success`

**BEP20（币安智能链）：**
1. 打开：https://bscscan.com/
2. 在搜索框粘贴交易哈希
3. 查看交易详情：
   - ✅ **收款地址**：必须是 `0xc8288b98f7c2cc11bccbc033754effcc87c1909e`
   - ✅ **转账金额**：必须≥用户填写的金额（例如30 USDT）
   - ✅ **代币类型**：必须是 `USDT`
   - ✅ **交易状态**：必须是 `成功` 或 `Success`

##### **方法2：检查钱包余额（更简单）**

1. 打开你的钱包（例如：TokenPocket、Trust Wallet）
2. 查看USDT余额是否增加
3. 查看交易记录，找到对应金额的转账

#### **步骤4：确认充值（触发自动到账）** ✅

**如果验证通过：**

1. 点击"✅ 确认"按钮
2. 弹出确认框：
   ```
   ┌─────────────────────────────────────┐
   │        ✅ 确认充值                    │
   ├─────────────────────────────────────┤
   │                                     │
   │  用户：张三                          │
   │  金额：30 USDT                       │
   │  网络：TRC20                         │
   │                                     │
   │  备注（可选）：                       │
   │  ┌─────────────────────────────┐   │
   │  │ 例如：已收到30U转账，哈希验证通过│   │
   │  └─────────────────────────────┘   │
   │                                     │
   │  ⚠️ 确认后将自动增加用户余额！       │
   │                                     │
   │  [取消]  [✅ 确认充值]               │
   └─────────────────────────────────────┘
   ```

3. 点击"✅ 确认充值"按钮
4. ✅ **系统自动执行**：
   - 更新充值记录状态为"已确认"
   - 自动增加用户U余额（例如+30U）
   - 记录交易流水

**如果验证失败：**

1. 点击"❌ 拒绝"按钮
2. 填写拒绝原因：
   ```
   常见拒绝原因：
   - 交易哈希无效
   - 收款地址不匹配
   - 转账金额不足
   - 未找到对应交易
   - 重复提交（已处理过）
   ```

3. 点击"确认拒绝"
4. 用户将收到拒绝通知（带原因）

---

## 🔍 **假充值识别方法**

### **常见假充值手段：**

| 假充值类型 | 识别方法 |
|-----------|---------|
| **伪造交易哈希** | 到区块浏览器查询，如果查不到 → 假的 ❌ |
| **转错地址** | 交易存在，但收款地址不是你的 → 假的 ❌ |
| **转错币种** | 转的不是USDT（例如转了TRX）→ 假的 ❌ |
| **金额不符** | 交易5U，但申请充值30U → 假的 ❌ |
| **重复使用同一笔交易** | 同一个哈希被多个用户提交 → 假的 ❌ |
| **截图造假** | 用户提供截图，但不提供哈希 → 可疑 ⚠️ |

### **验证要点：**

```
✅ 收款地址必须完全一致（区分大小写）
✅ 金额必须≥申请金额
✅ 代币类型必须是USDT
✅ 交易状态必须是成功
✅ 交易时间应该接近提交时间
✅ 每个哈希只能使用一次
```

---

## 🎬 **系统如何自动到账**

### **后端代码逻辑**（`RechargeService.confirmRecharge`）

```typescript
// 1. 更新充值记录状态为"已确认"
await supabase
  .from('recharge_records')
  .update({
    status: 'confirmed',
    confirmed_at: new Date().toISOString(),
    confirmed_by: 管理员ID,
    admin_note: 备注
  })
  .eq('id', rechargeId)

// 2. 自动增加用户余额（数据库原子操作）
await supabase.rpc('update_user_balance', {
  p_user_id: recharge.user_id,
  p_amount: recharge.amount,  // 例如：30
  p_type: 'recharge',
  p_description: `充值确认 ${recharge.amount} USDT`
})

// 3. 完成 ✅
return { success: true, message: '充值已确认' }
```

### **触发时机：**

```
管理员点击"✅ 确认充值"按钮
           ↓
后端执行 confirmRecharge()
           ↓
更新充值记录 + 增加用户余额
           ↓
用户余额立即到账 ✅
```

---

## 📊 **审核页面功能**

### **统计卡片：**

```
┌────────────────────────────────────────────────┐
│  待审核: 3    已确认: 15    已拒绝: 2    总金额: 450.00 U │
└────────────────────────────────────────────────┘
```

### **筛选选项：**

```
[全部 (20)] [待审核 (3)] [已确认 (15)] [已拒绝 (2)]
```

### **充值记录详情：**

每条记录显示：
- 用户名/手机号
- 充值金额
- 网络类型（TRC20/BEP20）
- 交易哈希（可复制）
- 提交时间
- 状态标签
- 操作按钮（待审核才显示）

---

## ⚠️ **安全建议**

### **防止被骗：**

1. ✅ **每笔都验证**：哪怕是老用户，每次都要验证交易哈希
2. ✅ **不接受截图**：只认区块链上的真实交易
3. ✅ **核对金额**：用户说充了30，实际只转了3 → 拒绝
4. ✅ **核对地址**：转到别的地址 → 拒绝
5. ✅ **防止重复**：记录已使用的哈希，防止重复提交
6. ✅ **小额测试**：新功能上线，先用小额测试（30U）

### **建议流程：**

```
收到充值申请
    ↓
复制交易哈希
    ↓
到区块浏览器查询
    ↓
验证：地址✅ 金额✅ 代币✅ 状态✅
    ↓
点击"确认充值"
    ↓
用户自动到账 ✅
```

---

## 🚀 **快速测试**

### **测试步骤：**

1. 创建一个测试账号（例如：testuser）
2. 用这个账号提交一个充值申请（金额30U，交易哈希随便填）
3. 管理员登录后台，进入"充值管理"
4. 看到这条待审核充值
5. 点击"✅ 确认"→ 点击"✅ 确认充值"
6. 刷新页面，检查testuser的余额是否增加了30U

---

## 📝 **管理员操作清单**

- [ ] 1. 登录管理后台
- [ ] 2. 进入"💰 充值管理"
- [ ] 3. 查看"待审核"充值申请
- [ ] 4. 复制交易哈希
- [ ] 5. 到区块浏览器验证交易
  - [ ] TRC20：https://tronscan.org/
  - [ ] BEP20：https://bscscan.com/
- [ ] 6. 验证收款地址、金额、代币类型
- [ ] 7. 如果验证通过 → 点击"✅ 确认"
- [ ] 8. 如果验证失败 → 点击"❌ 拒绝"并填写原因
- [ ] 9. 刷新页面，检查状态更新

---

## 🎯 **核心要点**

| 问题 | 答案 |
|------|------|
| **怎么知道真假充值？** | 到区块浏览器查询交易哈希，验证收款地址和金额 ✅ |
| **怎么触发自动到账？** | 管理员点击"✅ 确认充值"按钮 ✅ |
| **到账需要多久？** | 管理员确认后立即到账（秒到）✅ |
| **最低充值金额？** | 30 USDT ✅ |
| **支持哪些链？** | TRC20（波场）+ BEP20（币安智能链）✅ |

---

**配置时间：** 2025-10-25  
**管理后台：** https://ai-airdrop.top/admin  
**充值地址：**  
- TRC20：`TQTjfehUeHRWkw7QkcRKojWYdzYPebr9iS`  
- BEP20：`0xc8288b98f7c2cc11bccbc033754effcc87c1909e`

