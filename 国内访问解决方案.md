# 🌐 国内访问解决方案

## 问题分析
- Supabase 服务器在国外，国内用户需要翻墙才能访问
- 当前配置：`vtezesyfhvbkgpdkuyeo.supabase.co`
- 国内网络限制导致登录失败

## 解决方案

### 方案1：使用国内CDN代理（推荐）

#### 1.1 配置反向代理
在 `src/lib/supabase.ts` 中添加代理配置：

```typescript
// 国内用户使用代理
const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL
const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY

// 检测是否在国内
const isChina = () => {
  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone
  return timezone.includes('Asia/Shanghai') || timezone.includes('Asia/Chongqing')
}

// 使用代理URL（需要自己搭建）
const getSupabaseUrl = () => {
  if (isChina()) {
    return 'https://your-proxy-domain.com/supabase' // 替换为你的代理域名
  }
  return SUPABASE_URL
}

export const supabase = createClient(
  getSupabaseUrl(),
  SUPABASE_ANON_KEY,
  {
    auth: {
      autoRefreshToken: true,
      persistSession: true,
      detectSessionInUrl: true
    }
  }
)
```

#### 1.2 搭建代理服务器
使用 Nginx 或 Cloudflare Workers：

```nginx
# Nginx 配置
location /supabase/ {
    proxy_pass https://vtezesyfhvbkgpdkuyeo.supabase.co/;
    proxy_set_header Host vtezesyfhvbkgpdkuyeo.supabase.co;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### 方案2：使用国内云服务（推荐）

#### 2.1 迁移到阿里云/腾讯云
- 使用阿里云 RDS PostgreSQL
- 使用腾讯云 TDSQL
- 部署在国内，访问速度快

#### 2.2 使用 Supabase 国内镜像
- 寻找 Supabase 的国内镜像服务
- 或使用自建的 Supabase 实例

### 方案3：混合模式（临时方案）

#### 3.1 检测网络环境
```typescript
// 检测网络连接
const checkNetwork = async () => {
  try {
    const response = await fetch('https://vtezesyfhvbkgpdkuyeo.supabase.co/rest/v1/', {
      method: 'HEAD',
      timeout: 5000
    })
    return response.ok
  } catch (error) {
    return false
  }
}

// 根据网络环境选择模式
const initApp = async () => {
  const canAccessSupabase = await checkNetwork()
  
  if (canAccessSupabase) {
    // 使用 Supabase 模式
    useSupabaseMode()
  } else {
    // 使用本地模式
    useLocalMode()
  }
}
```

#### 3.2 本地数据模式
```typescript
// 当无法访问 Supabase 时，使用本地存储
const useLocalMode = () => {
  // 所有数据存储在 localStorage
  // 功能受限，但可以正常使用
  console.log('使用本地模式（国内用户）')
}
```

### 方案4：PWA + 离线模式

#### 4.1 启用 Service Worker
```typescript
// 注册 Service Worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(registration => {
      console.log('SW registered: ', registration)
    })
    .catch(registrationError => {
      console.log('SW registration failed: ', registrationError)
    })
}
```

#### 4.2 离线数据同步
```typescript
// 离线时使用本地数据，在线时同步到服务器
const syncData = async () => {
  if (navigator.onLine) {
    // 同步本地数据到 Supabase
    await syncLocalToSupabase()
  } else {
    // 使用本地数据
    useLocalData()
  }
}
```

## 推荐实施步骤

### 立即实施（5分钟）
1. 添加网络检测
2. 启用本地模式作为备选
3. 显示网络状态提示

### 中期实施（1-2天）
1. 搭建代理服务器
2. 配置 CDN 加速
3. 优化网络请求

### 长期实施（1周）
1. 迁移到国内云服务
2. 部署国内镜像
3. 完善离线功能

## 用户提示

在登录页面添加提示：

```html
<div class="network-tip">
  <p>🌐 网络提示：</p>
  <p>• 国内用户：如无法登录，请使用翻墙工具</p>
  <p>• 或等待系统自动切换到本地模式</p>
  <p>• 本地模式功能有限，但可以正常使用</p>
</div>
```

