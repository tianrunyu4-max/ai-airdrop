# 聊天系统稳定解决方案

## 🔴 当前问题

1. **消息不自动删除** - 超过5分钟的消息还在显示
2. **代码复杂混乱** - 定时器、过滤器、computed互相干扰
3. **修了2天没稳定** - 缺乏系统性设计

## ✅ 稳定方案（3选1）

### **方案1：数据库自动清理（最稳定）⭐推荐**

**原理**：数据库层面自动删除过期消息，前端只负责显示

**实施步骤**：

1. **执行SQL** `supabase/migrations/自动清理过期消息.sql`
   - 创建清理函数 `cleanup_expired_messages()`
   - 创建定时任务：每分钟执行一次
   - 或创建视图 `valid_messages`：只查询有效消息

2. **前端改动**（极简）：
   ```typescript
   // 查询视图而非表
   const { data } = await supabase
     .from('valid_messages')  // 使用视图
     .select('*')
     .eq('chat_group_id', groupId)
     .order('created_at', { ascending: true })
   
   // 取消所有定时器和过滤逻辑
   messages.value = data
   ```

**优点**：
- ✅ 前端代码极简
- ✅ 数据库自动清理，不会遗漏
- ✅ 性能最优

**缺点**：
- 需要Supabase启用 `pg_cron` 扩展
- 如果不支持，改用视图方案

---

### **方案2：前端定时重新加载（简单）**

**原理**：每30秒重新从数据库加载最新消息

**实施步骤**：

```typescript
// 1. 移除所有过滤逻辑
const validMessages = computed(() => messages.value)

// 2. 定时重新加载
setInterval(async () => {
  await loadMessages()  // 重新加载最新50条
}, 30000)  // 30秒

// 3. 数据库查询时加时间限制
const { data } = await supabase
  .from('messages')
  .select('*')
  .eq('chat_group_id', groupId)
  .gte('created_at', new Date(Date.now() - 5 * 60 * 1000).toISOString())  // 只查5分钟内
  .order('created_at', { ascending: true })
```

**优点**：
- ✅ 代码简单
- ✅ 不依赖数据库扩展

**缺点**：
- 每30秒查询一次，网络开销大
- 消息可能延迟30秒才消失

---

### **方案3：前端计算属性过滤（当前方案优化）**

**原理**：使用 `computed` 实时过滤过期消息

**实施步骤**：

```typescript
const validMessages = computed(() => {
  const now = Date.now()
  return messages.value.filter(msg => {
    const age = now - new Date(msg.created_at).getTime()
    
    // 用户消息5分钟，机器人消息根据群组类型
    if (msg.is_bot) {
      const limit = currentGroup.value?.type === 'ai_push' 
        ? 24 * 60 * 60 * 1000  // 24小时
        : 10 * 60 * 1000       // 10分钟
      return age <= limit
    }
    return age <= 5 * 60 * 1000  // 5分钟
  })
})

// 每10秒触发重新计算（强制更新）
setInterval(() => {
  // 触发 computed 重新计算
  messages.value = [...messages.value]
}, 10000)
```

**优点**：
- ✅ 不依赖数据库
- ✅ 实时过滤

**缺点**：
- computed 可能不主动重新计算
- 需要定时触发更新

---

## 🎯 立即行动方案

### **我推荐：混合方案**

1. **数据库层**：创建视图 `valid_messages`（不需要 pg_cron）
2. **前端层**：简化代码，直接查询视图
3. **保险层**：保留 computed 过滤

**执行步骤**：

1. 执行 SQL（创建视图部分）
2. 修改前端查询
3. 简化定时器逻辑
4. 测试验证

**预计时间**：30分钟
**稳定性**：⭐⭐⭐⭐⭐

---

## 📝 下一步

请选择方案：
1. **方案1** - 我帮您执行SQL并修改前端
2. **方案2** - 我实施定时重载方案
3. **方案3** - 我优化当前computed方案
4. **混合方案** - 我执行混合方案（推荐）

**您的选择？**

