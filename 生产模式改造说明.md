# 🔥 生产模式改造 - 进度报告

## ✅ 已完成的任务

### 1. P0-1: 用户系统连接真实数据库 ✅

**改造内容：**
- `src/stores/auth.ts` 全面重构
- `login()`: 从 Supabase 数据库查询用户
- `register()`: 创建用户到 Supabase 数据库
- `initialize()`: 从数据库验证并刷新用户数据
- `loadUser()`: 从数据库刷新用户信息
- 删除了所有 localStorage 的模拟逻辑
- 保留 localStorage 作为会话缓存（性能优化）

**影响：**
- ✅ 用户数据持久化到数据库
- ✅ 多设备可同步
- ✅ 刷新浏览器不丢失数据
- ⚠️ 需要配置 Supabase 数据库（用户需要手动创建第一个管理员账号）

---

### 2. P0-2: 真实多人聊天 - Supabase Realtime 🚧 进行中

**计划改造：**
- ChatView.vue 重构
- 使用 Supabase Realtime 订阅消息
- 消息存储到数据库
- 多用户实时同步
- localStorage 作为离线缓存

**当前状态：**
- 代码已经有 `subscribeToMessages()` 函数
- 但被禁用了，使用的是 `localStorage` 模拟
- 需要启用真实的 Realtime 订阅

---

## 🔄 正在进行的任务

### ChatView.vue 生产模式改造计划

**需要修改的关键函数：**

1. **`loadMessages()`**
   - 从 Supabase 数据库加载消息
   - localStorage 作为缓存
   - 首次加载：数据库 → localStorage → 显示
   - 再次加载：localStorage → 显示 → 数据库刷新

2. **`sendMessage()`**
   - 发送到 Supabase 数据库
   - 保存到 localStorage（离线缓存）
   - Realtime 会自动推送给所有在线用户

3. **`subscribeToMessages()`**
   - 启用 Supabase Realtime 订阅
   - 接收新消息时：保存到 localStorage + 添加到 messages 数组

4. **`switchGroup()`**
   - 切换群组时：取消旧订阅 + 加载新群组消息 + 订阅新群组

5. **`initDevMode()` 和 `startBotSimulation()`**
   - 保留用于演示/测试
   - 生产环境可以禁用（或改为真实的空投推送）

---

## 📝 待完成任务

### 3. P0-3: 移除调试代码 ⏳
- 删除所有 `console.log`
- 移除调试表情符号
- 清理开发模式代码

### 4. P0-4: 启用真实空投爬取 ⏳
- 连接 Binance RSS
- 连接 OKX RSS
- 定时爬取（Supabase Cron）

### 5. P0-5: Binary树连接真实后端 ⏳
- 前端调用后端API
- 显示真实团队数据
- 计算真实奖励

---

## ⚠️ 重要提示

### 数据库准备工作（用户需要手动完成）

1. **创建第一个管理员用户**
   ```sql
   -- 在 Supabase SQL Editor 中执行
   INSERT INTO users (
     username, 
     password_hash,  -- TODO: 需要加密
     invite_code,
     is_agent,
     is_admin,
     u_balance,
     points_balance
   ) VALUES (
     'boss',
     'boss123',  -- ⚠️ 生产环境需要加密！
     'ADMIN001',
     true,
     true,
     10000,
     5000
   );
   ```

2. **确保数据库表存在**
   - `users` 表
   - `messages` 表
   - `chat_groups` 表
   - `airdrops` 表

3. **创建默认群组**
   ```sql
   INSERT INTO chat_groups (
     name,
     icon,
     type,
     description,
     is_active
   ) VALUES (
     'AI科技',
     '🤖',
     'default_hall',
     '核心群聊',
     true
   );
   ```

---

## 🎯 下一步行动

继续完成 P0-2: 真实多人聊天

