# 🔥 生产模式改造 - P0任务进度

## ✅ 已完成任务

### 1. P0-1: 用户系统连接真实数据库 ✅

**文件修改：** `src/stores/auth.ts`

**核心改动：**
- ✅ `login()` - 从 Supabase 查询用户
- ✅ `register()` - 创建用户到数据库
- ✅ `initialize()` - 从数据库验证用户会话
- ✅ `loadUser()` - 刷新用户数据
- ✅ `logout()` - 清除会话
- ✅ 删除了所有 localStorage 模拟逻辑
- ✅ localStorage 作为会话缓存（性能优化）

---

### 2. P0-2: 真实多人聊天 - Supabase Realtime ✅

**文件修改：** `src/views/chat/ChatView.vue`

**核心改动：**
- ✅ `loadMessages()` - 从 Supabase 加载消息（带缓存优化）
- ✅ `sendMessage()` - 发送消息到数据库
- ✅ `subscribeToMessages()` - 订阅 Realtime 消息
- ✅ `switchGroup()` - 切换群组时重新订阅
- ✅ `getDefaultGroup()` - 获取或创建"AI科技"主群
- ✅ `joinGroup()` - 加入群组（仅限已登录用户）
- ✅ `onMounted()` - 初始化时加载并订阅

**实现效果：**
- ✅ 多用户实时同步消息
- ✅ 消息持久化到数据库
- ✅ localStorage 作为离线缓存
- ✅ 切换群组流畅
- ✅ 必须登录才能发送消息

---

## 🚧 进行中任务

### 3. P0-3: 移除调试代码 🚧

**计划清理：**
- ⏳ 删除所有 `console.log`
- ⏳ 删除调试表情符号
- ⏳ 删除开发模式代码（`isDevMode`、`initDevMode`、`startBotSimulation`）
- ⏳ 删除不再需要的函数

**需要检查的文件：**
- src/stores/auth.ts
- src/views/chat/ChatView.vue
- src/views/profile/ProfileView.vue
- src/views/points/PointsView.vue
- src/views/team/TeamView.vue
- src/components/*.vue

---

## ⏳ 待完成任务

### 4. P0-4: 启用真实空投爬取

**文件修改：** `src/services/AirdropCrawlerService.ts`, `supabase/functions/auto-crawl-airdrops/index.ts`

**计划：**
- 修改 RSS 源配置
- 启用自动爬取
- 配置 Supabase Cron Job
- 测试推送到群聊

### 5. P0-5: Binary树连接真实后端

**文件修改：** `src/views/team/TeamView.vue`, 相关服务文件

**计划：**
- 调用 Supabase 数据库查询 Binary 树
- 调用 Supabase Functions 计算奖励
- 显示真实团队数据
- 计算真实对碰奖励

---

## ⚠️ 重要提示

### 用户需要手动配置数据库

在部署前，需要在 Supabase 中执行以下操作：

#### 1. 创建"AI科技"主群（可选，代码会自动创建）
```sql
INSERT INTO chat_groups (name, icon, type, description, is_active, member_count, max_members)
VALUES ('AI科技', '🤖', 'default_hall', '核心群聊', true, 0, 50000)
ON CONFLICT DO NOTHING;
```

#### 2. 创建第一个管理员用户
```sql
INSERT INTO users (
  username, 
  password_hash,  -- ⚠️ 生产环境需要加密！
  invite_code,
  is_agent,
  is_admin,
  u_balance,
  points_balance,
  mining_points
) VALUES (
  'admin',
  'admin123',  -- ⚠️ TODO: 加密密码
  'ADMIN001',
  true,
  true,
  10000,
  5000,
  5000
);
```

#### 3. 启用 Supabase Realtime

在 Supabase Dashboard → Database → Replication 中，确保以下表已启用 Realtime：
- ✅ `messages`
- ✅ `chat_groups`

#### 4. 配置 RLS (Row Level Security)

确保以下表的 RLS 策略正确配置：
- `users` - 允许注册、允许查询自己的数据
- `messages` - 允许所有人读取、允许已登录用户插入
- `chat_groups` - 允许所有人读取
- `group_members` - 允许已登录用户加入群组

---

## 🎯 下一步

继续完成 P0-3: 移除调试代码

