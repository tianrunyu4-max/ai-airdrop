# 用户名片系统功能说明

**创建时间**：2025-10-15  
**功能**：群聊用户名片系统

---

## 🎯 功能概述

为群聊系统添加用户名片功能，让用户可以：
1. ✅ 自动生成正方形头像
2. ✅ 上传2张广告图片
3. ✅ 填写商家信息
4. ✅ 名片在所有群同步显示
5. ✅ 其他用户点击头像查看名片

---

## 📊 数据库设计

### 用户名片表（user_cards）

```sql
CREATE TABLE user_cards (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id) UNIQUE,  -- 用户ID
  avatar_url TEXT,                            -- 正方形头像
  ad_image_1 TEXT,                            -- 广告图片1
  ad_image_2 TEXT,                            -- 广告图片2
  business_name VARCHAR(100),                 -- 商家名称
  business_desc TEXT,                         -- 商家描述
  contact_info VARCHAR(200),                  -- 联系方式
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

### 特性

1. **自动创建**：用户加入群组时自动创建名片
2. **默认头像**：自动生成带首字母的SVG头像
3. **图片存储**：使用Supabase Storage存储
4. **权限控制**：RLS策略保证安全

---

## 🔧 功能实现

### 1. 后端服务（UserCardService.ts）

**核心功能**：
- `getUserCard(userId)` - 获取用户名片
- `createDefaultCard(userId)` - 创建默认名片
- `updateUserCard(userId, updates)` - 更新名片
- `uploadImage(userId, file, type)` - 上传图片
- `deleteImage(imageUrl)` - 删除图片
- `getUserCards(userIds)` - 批量获取名片

**默认头像生成**：
```typescript
generateDefaultAvatar(username: string): string {
  // 随机颜色
  const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', ...]
  const color = colors[random]
  const firstChar = username[0].toUpperCase()
  
  // 生成SVG头像
  return 'data:image/svg+xml;base64,...'
}
```

### 2. 显示组件（UserCard.vue）

**功能**：
- 显示用户头像（正方形）
- 显示商家信息
- 显示2张广告图片
- 点击图片可预览大图
- 如果是自己的名片，显示编辑按钮

**布局**：
```
┌─────────────────────────┐
│ [背景渐变]               │
│   [正方形头像]           │
│                          │
│ 用户名                   │
│ 商家名称                 │
│                          │
│ 商家描述                 │
│                          │
│ [广告图1] [广告图2]      │
│                          │
│ 📞 联系方式              │
│                          │
│ [编辑我的名片] (自己)    │
└─────────────────────────┘
```

### 3. 编辑组件（UserCardEditor.vue）

**功能**：
- 上传/更换正方形头像
- 上传/删除2张广告图片
- 编辑商家名称
- 编辑商家描述
- 编辑联系方式
- 实时预览
- 图片压缩和验证

**验证规则**：
- 图片类型：仅支持图片格式
- 图片大小：最大5MB
- 商家名称：最多100字符
- 商家描述：最多500字符
- 联系方式：最多200字符

### 4. 群聊集成（ChatView.vue）

**修改点**：
- 头像添加点击事件
- 点击头像打开用户名片
- 自己的名片可以点击编辑
- 名片在所有群同步

---

## 🎨 UI设计

### 头像样式

**默认头像**（自动生成）：
```
┌──────────┐
│          │
│    A     │  ← 首字母大写
│          │
└──────────┘
随机颜色背景
```

**用户上传头像**：
```
┌──────────┐
│          │
│  [图片]   │
│          │
└──────────┘
正方形，圆角
```

### 名片卡片

**渐变头部**：
- 黄色渐变背景（#F7DC6F → #F39C12）
- 头像居中显示
- AI代理徽章

**信息区域**：
- 用户名（大字号、粗体）
- 商家名称（灰色、小字号）
- 商家描述（灰色背景区域）

**广告区域**：
- 2张图片并排显示
- 点击可放大预览
- 悬停高亮边框

**联系方式**：
- 黄色背景
- 图标+文字

---

## 📱 使用流程

### 新用户流程

1. **加入群组**
   ```
   用户加入群组
   ↓
   系统自动创建名片
   ↓
   生成默认正方形头像（首字母）
   ↓
   名片创建完成
   ```

2. **编辑名片**
   ```
   点击自己的头像
   ↓
   查看名片
   ↓
   点击"编辑我的名片"
   ↓
   上传头像、广告图片
   ↓
   填写商家信息
   ↓
   保存
   ↓
   所有群同步更新
   ```

3. **查看其他人名片**
   ```
   在群聊中
   ↓
   点击任意用户头像
   ↓
   查看该用户名片
   ↓
   可查看广告图片
   ↓
   可获取联系方式
   ```

---

## 🔐 安全设计

### RLS权限策略

**查看名片**：所有人可见
```sql
CREATE POLICY user_cards_select_all ON user_cards
  FOR SELECT USING (true);
```

**创建名片**：只能创建自己的
```sql
CREATE POLICY user_cards_insert_own ON user_cards
  FOR INSERT WITH CHECK (auth.uid() = user_id);
```

**更新名片**：只能更新自己的
```sql
CREATE POLICY user_cards_update_own ON user_cards
  FOR UPDATE USING (auth.uid() = user_id);
```

### 图片存储策略

**目录结构**：
```
user-cards/
  ├─ {user_id}/
  │  ├─ avatar_{timestamp}.jpg
  │  ├─ ad1_{timestamp}.jpg
  │  └─ ad2_{timestamp}.jpg
```

**存储策略**：
- 所有人可查看（public bucket）
- 只能上传到自己的文件夹
- 只能删除自己的文件

---

## 💡 功能特点

### 1. 自动化

✅ **自动创建**：用户加入群组时自动创建名片  
✅ **自动生成**：默认头像自动生成（带首字母）  
✅ **自动同步**：名片在所有群聊中自动同步  

### 2. 灵活性

✅ **可选填写**：所有信息都是选填  
✅ **随时编辑**：用户可以随时编辑名片  
✅ **图片替换**：可以随时更换头像和广告图  

### 3. 推广价值

✅ **广告展示**：2张广告图片展示商品/服务  
✅ **商家信息**：展示商家名称和描述  
✅ **联系方式**：方便其他用户联系  
✅ **全局同步**：一次设置，所有群可见  

### 4. 用户体验

✅ **简单易用**：点击头像即可查看/编辑  
✅ **实时预览**：上传图片立即预览  
✅ **大图预览**：点击广告图可放大查看  
✅ **视觉优化**：渐变背景、圆角设计  

---

## 📊 应用场景

### 场景1：电商卖家

```
头像：店铺Logo
商家名称：张三服装店
商家描述：专营女装，品质保证，全国包邮
广告图1：热销商品图片
广告图2：促销活动海报
联系方式：微信号 zhangsan123
```

### 场景2：服务提供者

```
头像：个人形象照
商家名称：李四美容工作室
商家描述：专业美容美甲，10年经验
广告图1：工作环境照片
广告图2：作品展示图片
联系方式：电话 138xxxx1234
```

### 场景3：普通用户

```
头像：自动生成（首字母）
商家名称：（不填）
商家描述：（不填）
广告图1：（不填）
广告图2：（不填）
联系方式：（不填）
```

---

## 🧪 测试建议

### 功能测试

- [ ] 用户加入群组后自动创建名片
- [ ] 默认头像正确生成（首字母、随机颜色）
- [ ] 点击头像可查看名片
- [ ] 点击"编辑我的名片"可进入编辑页面
- [ ] 上传头像成功并显示
- [ ] 上传2张广告图片成功
- [ ] 填写商家信息并保存
- [ ] 名片在所有群聊中同步显示
- [ ] 其他用户可以查看我的名片
- [ ] 点击广告图片可放大预览

### 边界测试

- [ ] 上传非图片文件（应该报错）
- [ ] 上传超过5MB的图片（应该报错）
- [ ] 商家名称超过100字符（应该截断）
- [ ] 商家描述超过500字符（应该截断）
- [ ] 删除图片后再次上传
- [ ] 网络中断时的错误处理

### 权限测试

- [ ] 无法编辑其他用户的名片
- [ ] 无法删除其他用户的图片
- [ ] 无法上传到其他用户的文件夹

---

## 📦 部署清单

### 数据库迁移

1. ✅ 执行 `supabase/migrations/create_user_cards.sql`
2. ✅ 验证表和索引创建成功
3. ✅ 验证RLS策略生效
4. ✅ 创建 `user-cards` 存储桶
5. ✅ 验证存储桶策略

### 前端文件

1. ✅ `src/services/UserCardService.ts` - 服务层
2. ✅ `src/components/UserCard.vue` - 显示组件
3. ✅ `src/components/UserCardEditor.vue` - 编辑组件
4. ✅ 修改 `src/views/chat/ChatView.vue` - 集成到群聊

### 配置更新

- ✅ Supabase Storage配置
- ✅ RLS策略配置
- ✅ 自动触发器配置

---

## 🎉 功能总结

### 核心价值

1. **用户展示**：每个用户都有自己的电子名片
2. **商家推广**：支持上传广告图片和商家信息
3. **全局同步**：一次编辑，所有群可见
4. **简单易用**：点击头像即可查看/编辑

### 技术亮点

- ✅ 自动生成默认头像（SVG + Base64）
- ✅ Supabase Storage图片存储
- ✅ RLS权限精细控制
- ✅ 自动触发器（加入群组自动创建名片）
- ✅ 响应式UI设计
- ✅ 图片预览功能

### 用户体验

- ✅ 正方形头像（统一美观）
- ✅ 渐变背景（视觉优化）
- ✅ 2张广告图（商家展示）
- ✅ 大图预览（点击放大）
- ✅ 实时同步（所有群可见）

---

**用户名片系统已完成！让群聊更具商业价值。** 🎉

