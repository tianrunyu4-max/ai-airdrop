# 🔍 代码检查报告 - 直推关系与释放率

> **检查时间：** 2025-10-26  
> **检查范围：** 直推关系、释放率计算、见单奖发放

---

## ⚠️ 发现的严重问题

### 🔴 问题1：释放率计算公式**完全错误**！

#### 当前代码（错误）：
```typescript
// 当前在 MiningService.ts, EarningsView.vue, PointsView.vue 中使用：

// 0个直推 → 1%
// 1个直推 → 3% = 1% + 2%
// 2个直推 → 6% = 1% + 5%
// 3个直推 → 9% = 1% + 8%
// 4个直推 → 12% = 1% + 11%
// 5个直推 → 15% = 1% + 14%

// 公式：rate = 0.01 + 0.01 * (3 * count - 1)
//       当count=1时: 0.01 + 0.01 * (3*1-1) = 0.01 + 0.02 = 0.03 (3%)
//       当count=2时: 0.01 + 0.01 * (3*2-1) = 0.01 + 0.05 = 0.06 (6%)
```

#### 用户要求（正确）：
```typescript
// 0个直推 → 1%
// 1个直推 → 1% + 3% = 4%
// 2个直推 → 1% + 6% = 7%
// 3个直推 → 1% + 9% = 10%
// 4个直推 → 1% + 12% = 13%
// 5个直推 → 1% + 15% = 16%（但封顶15%）

// 公式：rate = 0.01 + Math.min(count * 0.03, 0.15)
//       当count=1时: 0.01 + 0.03 = 0.04 (4%)
//       当count=2时: 0.01 + 0.06 = 0.07 (7%)
```

#### 差异对比表：

| 直推数 | 当前代码（错） | 用户要求（对） | 差异 |
|--------|---------------|---------------|------|
| 0个    | 1%            | 1%            | ✅    |
| 1个    | 3%            | 4%            | -1%  |
| 2个    | 6%            | 7%            | -1%  |
| 3个    | 9%            | 10%           | -1%  |
| 4个    | 12%           | 13%           | -1%  |
| 5个    | 15%           | 15%           | ✅    |

**影响：** 用户实际获得的释放率比应该的少1%（除了0人和5人）

---

### 🔴 问题2：直推关系查询使用错误的字段

#### 当前代码（3处）：
```typescript
// ❌ 错误1: MiningService.ts Line 477-481
const { count } = await supabase
  .from('users')
  .select('id', { count: 'exact', head: true })
  .eq('inviter_id', userId)  // ❌ 使用 inviter_id
  .eq('is_agent', true)

// ❌ 错误2: EarningsView.vue Line 198-207
const registeredUsers = JSON.parse(localStorage.getItem('registered_users') || '{}')
for (const key in registeredUsers) {
  const userData = registeredUsers[key].userData
  if (userData.inviter_id === userId && userData.is_agent) {  // ❌ localStorage
    count++
  }
}

// ❌ 错误3: PointsView.vue Line 536-546
const registeredUsers = JSON.parse(localStorage.getItem('registered_users') || '{}')
for (const key in registeredUsers) {
  const userData = registeredUsers[key].userData
  if (userData.inviter_id === user.value.id && userData.is_agent) {  // ❌ localStorage
    referralCount++
  }
}
```

#### 正确做法：
```typescript
// ✅ 使用 referral_relationships 表
const { count } = await supabase
  .from('referral_relationships')
  .select('*', { count: 'exact', head: true })
  .eq('referrer_id', userId)
  .eq('is_active', true)
```

**问题：**
1. `users.inviter_id` 字段在注册时就设置了（错误！）
2. 应该只在升级AI代理时写入 `referral_relationships` 表
3. localStorage 数据不可靠，应该用数据库

---

### 🔴 问题3：升级AI代理时没有写入直推关系表

#### 当前代码（AgentService.ts）：
```typescript
// Line 104-111
await supabase
  .from('users')
  .update({
    is_agent: true,
    inviter_id: inviter.id,  // ❌ 写到 users 表
    agent_paid_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  })
  .eq('id', userId)

// ❌ 没有写入 referral_relationships 表！
```

#### 正确做法：
```typescript
// 1. 设置为代理
await supabase
  .from('users')
  .update({
    is_agent: true,
    agent_paid_at: new Date().toISOString()
  })
  .eq('id', userId)

// 2. ✅ 写入直推关系表
await supabase
  .from('referral_relationships')
  .insert({
    referrer_id: inviter.id,
    referee_id: userId
  })
```

---

### 🔴 问题4：见单奖没有发放

#### 当前代码：
```typescript
// AgentService.becomeAgent() 中没有发放见单奖的逻辑！
```

#### 正确做法：
```typescript
// 方案A：在代码中发放
await WalletManager.add(
  inviter.id,
  5,
  'referral_bonus',
  '直推见单奖'
)

// 方案B：使用数据库触发器（已在SQL迁移文件中）
// 当 INSERT INTO referral_relationships 时自动触发
```

---

### 🔴 问题5：TeamView 查询直推列表逻辑错误

#### 当前代码（TeamView.vue Line 136-148）：
```typescript
// ❌ 从 users 表查询 inviter_id
const { data, error } = await supabase
  .from('users')
  .select('id, username, is_agent, created_at')
  .eq('inviter_id', userId)
  .eq('is_agent', true)
  .order('created_at', { ascending: false })
```

#### 正确做法：
```typescript
// ✅ 从 referral_relationships 表 JOIN users 表
const { data, error } = await supabase
  .from('referral_relationships')
  .select(`
    referee_id,
    created_at,
    users!referee_id (
      id,
      username,
      is_agent,
      agent_paid_at
    )
  `)
  .eq('referrer_id', userId)
  .eq('is_active', true)
  .order('created_at', { ascending: false })
```

---

## 📋 需要修改的文件清单

### 优先级1：核心业务逻辑（必须修改）

| 文件 | 行号 | 问题 | 修改内容 |
|------|------|------|----------|
| **src/services/AgentService.ts** | 92-147 | 没写直推关系表 | 1. 写入referral_relationships<br>2. 移除inviter_id更新 |
| **src/services/MiningService.ts** | 474-513 | 释放率公式错误<br>查询字段错误 | 1. 改公式：count * 0.03<br>2. 改表：referral_relationships |

### 优先级2：前端显示（影响用户体验）

| 文件 | 行号 | 问题 | 修改内容 |
|------|------|------|----------|
| **src/views/earnings/EarningsView.vue** | 191-228 | 释放率公式错误<br>用localStorage | 1. 改公式<br>2. 改用数据库查询 |
| **src/views/points/PointsView.vue** | 531-562 | 释放率公式错误<br>用localStorage | 1. 改公式<br>2. 改用数据库查询 |
| **src/views/team/TeamView.vue** | 136-148 | 查询字段错误 | 改用referral_relationships |

### 优先级3：数据库迁移（基础设施）

| 文件 | 状态 | 说明 |
|------|------|------|
| **supabase/migrations/修复交易流水字段长度.sql** | ✅ 已创建 | 扩展description到500字符 |
| **supabase/migrations/创建直推关系表-referral_relationships.sql** | ✅ 已创建 | 创建新表+触发器 |

### 优先级4：注册逻辑（清理历史问题）

| 文件 | 行号 | 问题 | 修改内容 |
|------|------|------|----------|
| **src/stores/auth.ts** | 183-210 | 注册时不应设置inviter_id | 已修复✅（inviter_id = null） |

---

## ✅ 修改建议顺序

### 第1步：部署数据库迁移（5分钟）
```bash
# 在 Supabase SQL Editor 中执行：
1. 修复交易流水字段长度.sql
2. 创建直推关系表-referral_relationships.sql
```

### 第2步：修改后端核心逻辑（15分钟）
```
1. AgentService.becomeAgent() - 写入referral_relationships表
2. MiningService.calculateReleaseRate() - 修改公式和查询
```

### 第3步：修改前端显示（10分钟）
```
1. EarningsView.vue - 修改释放率计算
2. PointsView.vue - 修改释放率计算
3. TeamView.vue - 修改直推列表查询
```

### 第4步：测试验证（10分钟）
```
1. 测试升级AI代理 → 检查referral_relationships表
2. 测试释放率计算 → 验证公式正确
3. 测试直推列表 → 验证显示正确
4. 测试见单奖 → 验证自动发放
```

---

## 🎯 正确的释放率公式

```typescript
/**
 * 计算释放率（正确版本）
 * 
 * @param userId 用户ID
 * @returns 释放率（0.01 - 0.15）
 */
async function calculateReleaseRate(userId: string): Promise<number> {
  // 1. 从直推关系表查询直推人数
  const { count, error } = await supabase
    .from('referral_relationships')
    .select('*', { count: 'exact', head: true })
    .eq('referrer_id', userId)
    .eq('is_active', true)
  
  if (error) {
    console.error('查询直推数量失败:', error)
    return 0.01
  }
  
  const directCount = count || 0
  
  // 2. 计算释放率
  const BASE_RATE = 0.01        // 基础1%
  const BOOST_PER_PERSON = 0.03 // 每人+3%
  const MAX_BOOST = 0.15        // 最高+15%
  
  const boostRate = Math.min(directCount * BOOST_PER_PERSON, MAX_BOOST)
  const finalRate = BASE_RATE + boostRate
  
  // 3. 封顶15%（即使计算出16%也要限制为15%）
  return Math.min(finalRate, 0.15)
}

// 示例：
// 0个直推 → 0.01 + 0.00 = 0.01 (1%)
// 1个直推 → 0.01 + 0.03 = 0.04 (4%)
// 2个直推 → 0.01 + 0.06 = 0.07 (7%)
// 3个直推 → 0.01 + 0.09 = 0.10 (10%)
// 4个直推 → 0.01 + 0.12 = 0.13 (13%)
// 5个直推 → 0.01 + 0.15 = 0.16 → 0.15 (15% 封顶)
// 6个直推 → 0.01 + 0.18 = 0.19 → 0.15 (15% 封顶)
```

---

## 📝 下一步行动

请确认：
1. ✅ 释放率公式：**基础1% + 每人3% = 最高15%**（正确）
2. ✅ 见单奖：**5U**（正确）
3. ✅ 使用独立的 **referral_relationships 表**（正确）

确认后，我将按照上述顺序开始修改代码。

