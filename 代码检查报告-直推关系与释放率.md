# ğŸ” ä»£ç æ£€æŸ¥æŠ¥å‘Š - ç›´æ¨å…³ç³»ä¸é‡Šæ”¾ç‡

> **æ£€æŸ¥æ—¶é—´ï¼š** 2025-10-26  
> **æ£€æŸ¥èŒƒå›´ï¼š** ç›´æ¨å…³ç³»ã€é‡Šæ”¾ç‡è®¡ç®—ã€è§å•å¥–å‘æ”¾

---

## âš ï¸ å‘ç°çš„ä¸¥é‡é—®é¢˜

### ğŸ”´ é—®é¢˜1ï¼šé‡Šæ”¾ç‡è®¡ç®—å…¬å¼**å®Œå…¨é”™è¯¯**ï¼

#### å½“å‰ä»£ç ï¼ˆé”™è¯¯ï¼‰ï¼š
```typescript
// å½“å‰åœ¨ MiningService.ts, EarningsView.vue, PointsView.vue ä¸­ä½¿ç”¨ï¼š

// 0ä¸ªç›´æ¨ â†’ 1%
// 1ä¸ªç›´æ¨ â†’ 3% = 1% + 2%
// 2ä¸ªç›´æ¨ â†’ 6% = 1% + 5%
// 3ä¸ªç›´æ¨ â†’ 9% = 1% + 8%
// 4ä¸ªç›´æ¨ â†’ 12% = 1% + 11%
// 5ä¸ªç›´æ¨ â†’ 15% = 1% + 14%

// å…¬å¼ï¼šrate = 0.01 + 0.01 * (3 * count - 1)
//       å½“count=1æ—¶: 0.01 + 0.01 * (3*1-1) = 0.01 + 0.02 = 0.03 (3%)
//       å½“count=2æ—¶: 0.01 + 0.01 * (3*2-1) = 0.01 + 0.05 = 0.06 (6%)
```

#### ç”¨æˆ·è¦æ±‚ï¼ˆæ­£ç¡®ï¼‰ï¼š
```typescript
// 0ä¸ªç›´æ¨ â†’ 1%
// 1ä¸ªç›´æ¨ â†’ 1% + 3% = 4%
// 2ä¸ªç›´æ¨ â†’ 1% + 6% = 7%
// 3ä¸ªç›´æ¨ â†’ 1% + 9% = 10%
// 4ä¸ªç›´æ¨ â†’ 1% + 12% = 13%
// 5ä¸ªç›´æ¨ â†’ 1% + 15% = 16%ï¼ˆä½†å°é¡¶15%ï¼‰

// å…¬å¼ï¼šrate = 0.01 + Math.min(count * 0.03, 0.15)
//       å½“count=1æ—¶: 0.01 + 0.03 = 0.04 (4%)
//       å½“count=2æ—¶: 0.01 + 0.06 = 0.07 (7%)
```

#### å·®å¼‚å¯¹æ¯”è¡¨ï¼š

| ç›´æ¨æ•° | å½“å‰ä»£ç ï¼ˆé”™ï¼‰ | ç”¨æˆ·è¦æ±‚ï¼ˆå¯¹ï¼‰ | å·®å¼‚ |
|--------|---------------|---------------|------|
| 0ä¸ª    | 1%            | 1%            | âœ…    |
| 1ä¸ª    | 3%            | 4%            | -1%  |
| 2ä¸ª    | 6%            | 7%            | -1%  |
| 3ä¸ª    | 9%            | 10%           | -1%  |
| 4ä¸ª    | 12%           | 13%           | -1%  |
| 5ä¸ª    | 15%           | 15%           | âœ…    |

**å½±å“ï¼š** ç”¨æˆ·å®é™…è·å¾—çš„é‡Šæ”¾ç‡æ¯”åº”è¯¥çš„å°‘1%ï¼ˆé™¤äº†0äººå’Œ5äººï¼‰

---

### ğŸ”´ é—®é¢˜2ï¼šç›´æ¨å…³ç³»æŸ¥è¯¢ä½¿ç”¨é”™è¯¯çš„å­—æ®µ

#### å½“å‰ä»£ç ï¼ˆ3å¤„ï¼‰ï¼š
```typescript
// âŒ é”™è¯¯1: MiningService.ts Line 477-481
const { count } = await supabase
  .from('users')
  .select('id', { count: 'exact', head: true })
  .eq('inviter_id', userId)  // âŒ ä½¿ç”¨ inviter_id
  .eq('is_agent', true)

// âŒ é”™è¯¯2: EarningsView.vue Line 198-207
const registeredUsers = JSON.parse(localStorage.getItem('registered_users') || '{}')
for (const key in registeredUsers) {
  const userData = registeredUsers[key].userData
  if (userData.inviter_id === userId && userData.is_agent) {  // âŒ localStorage
    count++
  }
}

// âŒ é”™è¯¯3: PointsView.vue Line 536-546
const registeredUsers = JSON.parse(localStorage.getItem('registered_users') || '{}')
for (const key in registeredUsers) {
  const userData = registeredUsers[key].userData
  if (userData.inviter_id === user.value.id && userData.is_agent) {  // âŒ localStorage
    referralCount++
  }
}
```

#### æ­£ç¡®åšæ³•ï¼š
```typescript
// âœ… ä½¿ç”¨ referral_relationships è¡¨
const { count } = await supabase
  .from('referral_relationships')
  .select('*', { count: 'exact', head: true })
  .eq('referrer_id', userId)
  .eq('is_active', true)
```

**é—®é¢˜ï¼š**
1. `users.inviter_id` å­—æ®µåœ¨æ³¨å†Œæ—¶å°±è®¾ç½®äº†ï¼ˆé”™è¯¯ï¼ï¼‰
2. åº”è¯¥åªåœ¨å‡çº§AIä»£ç†æ—¶å†™å…¥ `referral_relationships` è¡¨
3. localStorage æ•°æ®ä¸å¯é ï¼Œåº”è¯¥ç”¨æ•°æ®åº“

---

### ğŸ”´ é—®é¢˜3ï¼šå‡çº§AIä»£ç†æ—¶æ²¡æœ‰å†™å…¥ç›´æ¨å…³ç³»è¡¨

#### å½“å‰ä»£ç ï¼ˆAgentService.tsï¼‰ï¼š
```typescript
// Line 104-111
await supabase
  .from('users')
  .update({
    is_agent: true,
    inviter_id: inviter.id,  // âŒ å†™åˆ° users è¡¨
    agent_paid_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  })
  .eq('id', userId)

// âŒ æ²¡æœ‰å†™å…¥ referral_relationships è¡¨ï¼
```

#### æ­£ç¡®åšæ³•ï¼š
```typescript
// 1. è®¾ç½®ä¸ºä»£ç†
await supabase
  .from('users')
  .update({
    is_agent: true,
    agent_paid_at: new Date().toISOString()
  })
  .eq('id', userId)

// 2. âœ… å†™å…¥ç›´æ¨å…³ç³»è¡¨
await supabase
  .from('referral_relationships')
  .insert({
    referrer_id: inviter.id,
    referee_id: userId
  })
```

---

### ğŸ”´ é—®é¢˜4ï¼šè§å•å¥–æ²¡æœ‰å‘æ”¾

#### å½“å‰ä»£ç ï¼š
```typescript
// AgentService.becomeAgent() ä¸­æ²¡æœ‰å‘æ”¾è§å•å¥–çš„é€»è¾‘ï¼
```

#### æ­£ç¡®åšæ³•ï¼š
```typescript
// æ–¹æ¡ˆAï¼šåœ¨ä»£ç ä¸­å‘æ”¾
await WalletManager.add(
  inviter.id,
  5,
  'referral_bonus',
  'ç›´æ¨è§å•å¥–'
)

// æ–¹æ¡ˆBï¼šä½¿ç”¨æ•°æ®åº“è§¦å‘å™¨ï¼ˆå·²åœ¨SQLè¿ç§»æ–‡ä»¶ä¸­ï¼‰
// å½“ INSERT INTO referral_relationships æ—¶è‡ªåŠ¨è§¦å‘
```

---

### ğŸ”´ é—®é¢˜5ï¼šTeamView æŸ¥è¯¢ç›´æ¨åˆ—è¡¨é€»è¾‘é”™è¯¯

#### å½“å‰ä»£ç ï¼ˆTeamView.vue Line 136-148ï¼‰ï¼š
```typescript
// âŒ ä» users è¡¨æŸ¥è¯¢ inviter_id
const { data, error } = await supabase
  .from('users')
  .select('id, username, is_agent, created_at')
  .eq('inviter_id', userId)
  .eq('is_agent', true)
  .order('created_at', { ascending: false })
```

#### æ­£ç¡®åšæ³•ï¼š
```typescript
// âœ… ä» referral_relationships è¡¨ JOIN users è¡¨
const { data, error } = await supabase
  .from('referral_relationships')
  .select(`
    referee_id,
    created_at,
    users!referee_id (
      id,
      username,
      is_agent,
      agent_paid_at
    )
  `)
  .eq('referrer_id', userId)
  .eq('is_active', true)
  .order('created_at', { ascending: false })
```

---

## ğŸ“‹ éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### ä¼˜å…ˆçº§1ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆå¿…é¡»ä¿®æ”¹ï¼‰

| æ–‡ä»¶ | è¡Œå· | é—®é¢˜ | ä¿®æ”¹å†…å®¹ |
|------|------|------|----------|
| **src/services/AgentService.ts** | 92-147 | æ²¡å†™ç›´æ¨å…³ç³»è¡¨ | 1. å†™å…¥referral_relationships<br>2. ç§»é™¤inviter_idæ›´æ–° |
| **src/services/MiningService.ts** | 474-513 | é‡Šæ”¾ç‡å…¬å¼é”™è¯¯<br>æŸ¥è¯¢å­—æ®µé”™è¯¯ | 1. æ”¹å…¬å¼ï¼šcount * 0.03<br>2. æ”¹è¡¨ï¼šreferral_relationships |

### ä¼˜å…ˆçº§2ï¼šå‰ç«¯æ˜¾ç¤ºï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰

| æ–‡ä»¶ | è¡Œå· | é—®é¢˜ | ä¿®æ”¹å†…å®¹ |
|------|------|------|----------|
| **src/views/earnings/EarningsView.vue** | 191-228 | é‡Šæ”¾ç‡å…¬å¼é”™è¯¯<br>ç”¨localStorage | 1. æ”¹å…¬å¼<br>2. æ”¹ç”¨æ•°æ®åº“æŸ¥è¯¢ |
| **src/views/points/PointsView.vue** | 531-562 | é‡Šæ”¾ç‡å…¬å¼é”™è¯¯<br>ç”¨localStorage | 1. æ”¹å…¬å¼<br>2. æ”¹ç”¨æ•°æ®åº“æŸ¥è¯¢ |
| **src/views/team/TeamView.vue** | 136-148 | æŸ¥è¯¢å­—æ®µé”™è¯¯ | æ”¹ç”¨referral_relationships |

### ä¼˜å…ˆçº§3ï¼šæ•°æ®åº“è¿ç§»ï¼ˆåŸºç¡€è®¾æ–½ï¼‰

| æ–‡ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **supabase/migrations/ä¿®å¤äº¤æ˜“æµæ°´å­—æ®µé•¿åº¦.sql** | âœ… å·²åˆ›å»º | æ‰©å±•descriptionåˆ°500å­—ç¬¦ |
| **supabase/migrations/åˆ›å»ºç›´æ¨å…³ç³»è¡¨-referral_relationships.sql** | âœ… å·²åˆ›å»º | åˆ›å»ºæ–°è¡¨+è§¦å‘å™¨ |

### ä¼˜å…ˆçº§4ï¼šæ³¨å†Œé€»è¾‘ï¼ˆæ¸…ç†å†å²é—®é¢˜ï¼‰

| æ–‡ä»¶ | è¡Œå· | é—®é¢˜ | ä¿®æ”¹å†…å®¹ |
|------|------|------|----------|
| **src/stores/auth.ts** | 183-210 | æ³¨å†Œæ—¶ä¸åº”è®¾ç½®inviter_id | å·²ä¿®å¤âœ…ï¼ˆinviter_id = nullï¼‰ |

---

## âœ… ä¿®æ”¹å»ºè®®é¡ºåº

### ç¬¬1æ­¥ï¼šéƒ¨ç½²æ•°æ®åº“è¿ç§»ï¼ˆ5åˆ†é’Ÿï¼‰
```bash
# åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š
1. ä¿®å¤äº¤æ˜“æµæ°´å­—æ®µé•¿åº¦.sql
2. åˆ›å»ºç›´æ¨å…³ç³»è¡¨-referral_relationships.sql
```

### ç¬¬2æ­¥ï¼šä¿®æ”¹åç«¯æ ¸å¿ƒé€»è¾‘ï¼ˆ15åˆ†é’Ÿï¼‰
```
1. AgentService.becomeAgent() - å†™å…¥referral_relationshipsè¡¨
2. MiningService.calculateReleaseRate() - ä¿®æ”¹å…¬å¼å’ŒæŸ¥è¯¢
```

### ç¬¬3æ­¥ï¼šä¿®æ”¹å‰ç«¯æ˜¾ç¤ºï¼ˆ10åˆ†é’Ÿï¼‰
```
1. EarningsView.vue - ä¿®æ”¹é‡Šæ”¾ç‡è®¡ç®—
2. PointsView.vue - ä¿®æ”¹é‡Šæ”¾ç‡è®¡ç®—
3. TeamView.vue - ä¿®æ”¹ç›´æ¨åˆ—è¡¨æŸ¥è¯¢
```

### ç¬¬4æ­¥ï¼šæµ‹è¯•éªŒè¯ï¼ˆ10åˆ†é’Ÿï¼‰
```
1. æµ‹è¯•å‡çº§AIä»£ç† â†’ æ£€æŸ¥referral_relationshipsè¡¨
2. æµ‹è¯•é‡Šæ”¾ç‡è®¡ç®— â†’ éªŒè¯å…¬å¼æ­£ç¡®
3. æµ‹è¯•ç›´æ¨åˆ—è¡¨ â†’ éªŒè¯æ˜¾ç¤ºæ­£ç¡®
4. æµ‹è¯•è§å•å¥– â†’ éªŒè¯è‡ªåŠ¨å‘æ”¾
```

---

## ğŸ¯ æ­£ç¡®çš„é‡Šæ”¾ç‡å…¬å¼

```typescript
/**
 * è®¡ç®—é‡Šæ”¾ç‡ï¼ˆæ­£ç¡®ç‰ˆæœ¬ï¼‰
 * 
 * @param userId ç”¨æˆ·ID
 * @returns é‡Šæ”¾ç‡ï¼ˆ0.01 - 0.15ï¼‰
 */
async function calculateReleaseRate(userId: string): Promise<number> {
  // 1. ä»ç›´æ¨å…³ç³»è¡¨æŸ¥è¯¢ç›´æ¨äººæ•°
  const { count, error } = await supabase
    .from('referral_relationships')
    .select('*', { count: 'exact', head: true })
    .eq('referrer_id', userId)
    .eq('is_active', true)
  
  if (error) {
    console.error('æŸ¥è¯¢ç›´æ¨æ•°é‡å¤±è´¥:', error)
    return 0.01
  }
  
  const directCount = count || 0
  
  // 2. è®¡ç®—é‡Šæ”¾ç‡
  const BASE_RATE = 0.01        // åŸºç¡€1%
  const BOOST_PER_PERSON = 0.03 // æ¯äºº+3%
  const MAX_BOOST = 0.15        // æœ€é«˜+15%
  
  const boostRate = Math.min(directCount * BOOST_PER_PERSON, MAX_BOOST)
  const finalRate = BASE_RATE + boostRate
  
  // 3. å°é¡¶15%ï¼ˆå³ä½¿è®¡ç®—å‡º16%ä¹Ÿè¦é™åˆ¶ä¸º15%ï¼‰
  return Math.min(finalRate, 0.15)
}

// ç¤ºä¾‹ï¼š
// 0ä¸ªç›´æ¨ â†’ 0.01 + 0.00 = 0.01 (1%)
// 1ä¸ªç›´æ¨ â†’ 0.01 + 0.03 = 0.04 (4%)
// 2ä¸ªç›´æ¨ â†’ 0.01 + 0.06 = 0.07 (7%)
// 3ä¸ªç›´æ¨ â†’ 0.01 + 0.09 = 0.10 (10%)
// 4ä¸ªç›´æ¨ â†’ 0.01 + 0.12 = 0.13 (13%)
// 5ä¸ªç›´æ¨ â†’ 0.01 + 0.15 = 0.16 â†’ 0.15 (15% å°é¡¶)
// 6ä¸ªç›´æ¨ â†’ 0.01 + 0.18 = 0.19 â†’ 0.15 (15% å°é¡¶)
```

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

è¯·ç¡®è®¤ï¼š
1. âœ… é‡Šæ”¾ç‡å…¬å¼ï¼š**åŸºç¡€1% + æ¯äºº3% = æœ€é«˜15%**ï¼ˆæ­£ç¡®ï¼‰
2. âœ… è§å•å¥–ï¼š**5U**ï¼ˆæ­£ç¡®ï¼‰
3. âœ… ä½¿ç”¨ç‹¬ç«‹çš„ **referral_relationships è¡¨**ï¼ˆæ­£ç¡®ï¼‰

ç¡®è®¤åï¼Œæˆ‘å°†æŒ‰ç…§ä¸Šè¿°é¡ºåºå¼€å§‹ä¿®æ”¹ä»£ç ã€‚

