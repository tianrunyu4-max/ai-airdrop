<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä½™é¢ä¿®å¤å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 800px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
      border-left: 4px solid #667eea;
    }
    
    .section h2 {
      color: #667eea;
      font-size: 18px;
      margin-bottom: 15px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-radius: 8px;
    }
    
    .label {
      font-weight: 600;
      color: #555;
    }
    
    .value {
      font-family: 'Courier New', monospace;
      color: #667eea;
      font-weight: bold;
    }
    
    .error {
      color: #e74c3c;
    }
    
    .success {
      color: #27ae60;
    }
    
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin: 5px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    .danger {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    
    .log {
      background: #1e1e1e;
      color: #00ff00;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
    
    .log-line {
      margin: 3px 0;
    }
    
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ ä½™é¢ä¿®å¤å·¥å…·</h1>
    <p class="subtitle">è¯Šæ–­å’Œä¿®å¤ç­¾åˆ°ä½™é¢æ¸…é›¶é—®é¢˜</p>
    
    <!-- å½“å‰çŠ¶æ€ -->
    <div class="section">
      <h2>ğŸ“Š å½“å‰çŠ¶æ€</h2>
      <div id="currentStatus"></div>
    </div>
    
    <!-- å­¦ä¹ å¡çŠ¶æ€ -->
    <div class="section">
      <h2>ğŸ“š å­¦ä¹ å¡çŠ¶æ€</h2>
      <div id="cardsStatus"></div>
    </div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="section">
      <h2>ğŸ› ï¸ æ“ä½œ</h2>
      <div class="buttons">
        <button onclick="checkBalance()">ğŸ” æ£€æŸ¥ä½™é¢</button>
        <button onclick="fixBalance()">âœ¨ ä¿®å¤ä½™é¢</button>
        <button onclick="testCheckin()">ğŸ“ æ¨¡æ‹Ÿç­¾åˆ°æµ‹è¯•</button>
        <button onclick="showDetails()">ğŸ“‹ è¯¦ç»†ä¿¡æ¯</button>
        <button onclick="clearAll()" class="danger">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
      </div>
    </div>
    
    <!-- æ—¥å¿— -->
    <div class="section">
      <h2>ğŸ“œ æ“ä½œæ—¥å¿—</h2>
      <div class="log" id="logContainer"></div>
    </div>
  </div>

  <script>
    let logs = []
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString()
      const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'ğŸ“'
      logs.push(`[${timestamp}] ${prefix} ${message}`)
      updateLog()
    }
    
    function updateLog() {
      const container = document.getElementById('logContainer')
      container.innerHTML = logs.map(l => `<div class="log-line">${l}</div>`).join('')
      container.scrollTop = container.scrollHeight
    }
    
    function getCurrentUser() {
      const currentUser = localStorage.getItem('current_user')
      if (!currentUser) {
        log('æœªæ‰¾åˆ°ç™»å½•ç”¨æˆ·', 'error')
        return null
      }
      
      const users = JSON.parse(localStorage.getItem('registered_users') || '{}')
      if (!users[currentUser]) {
        log(`ç”¨æˆ· ${currentUser} æ•°æ®ä¸å­˜åœ¨`, 'error')
        return null
      }
      
      return {
        username: currentUser,
        data: users[currentUser].userData,
        allUsers: users
      }
    }
    
    function checkBalance() {
      log('å¼€å§‹æ£€æŸ¥ä½™é¢...')
      const user = getCurrentUser()
      if (!user) return
      
      const data = user.data
      const html = `
        <div class="info-row">
          <span class="label">ç”¨æˆ·å:</span>
          <span class="value">${user.username}</span>
        </div>
        <div class="info-row">
          <span class="label">Uä½™é¢:</span>
          <span class="value ${isNaN(data.u_balance) ? 'error' : ''}">${data.u_balance} U ${isNaN(data.u_balance) ? '(é”™è¯¯ï¼)' : ''}</span>
        </div>
        <div class="info-row">
          <span class="label">äº’è½¬ç§¯åˆ†:</span>
          <span class="value ${isNaN(data.transfer_points) ? 'error' : ''}">${data.transfer_points} ${isNaN(data.transfer_points) ? '(é”™è¯¯ï¼)' : ''}</span>
        </div>
        <div class="info-row">
          <span class="label">æ€»ç§¯åˆ†:</span>
          <span class="value ${isNaN(data.points_balance) ? 'error' : ''}">${data.points_balance} ${isNaN(data.points_balance) ? '(é”™è¯¯ï¼)' : ''}</span>
        </div>
        <div class="info-row">
          <span class="label">ä»£ç†èº«ä»½:</span>
          <span class="value ${data.is_agent ? 'success' : 'error'}">${data.is_agent ? 'âœ… æ˜¯' : 'âŒ å¦'}</span>
        </div>
      `
      
      document.getElementById('currentStatus').innerHTML = html
      
      if (isNaN(data.u_balance) || isNaN(data.transfer_points) || isNaN(data.points_balance)) {
        log('å‘ç°ä½™é¢å¼‚å¸¸ï¼å»ºè®®ç«‹å³ä¿®å¤', 'error')
      } else {
        log('ä½™é¢æ£€æŸ¥å®Œæˆï¼Œæ•°æ®æ­£å¸¸', 'success')
      }
      
      checkCards()
    }
    
    function checkCards() {
      const user = getCurrentUser()
      if (!user) return
      
      const cards = JSON.parse(localStorage.getItem('user_learning_cards') || '[]')
      const userCards = cards.filter(c => c.user_id === user.data.id)
      
      if (userCards.length === 0) {
        document.getElementById('cardsStatus').innerHTML = '<p>æš‚æ— å­¦ä¹ å¡</p>'
        log(`ç”¨æˆ·æ²¡æœ‰å­¦ä¹ å¡`)
        return
      }
      
      const html = userCards.map((card, idx) => `
        <div class="info-row">
          <span class="label">å­¦ä¹ å¡ ${idx + 1}:</span>
          <span class="value">${card.released_points} / ${card.total_points} (${((card.released_points / card.total_points) * 100).toFixed(1)}%)</span>
        </div>
      `).join('')
      
      document.getElementById('cardsStatus').innerHTML = html
      log(`æ‰¾åˆ° ${userCards.length} å¼ å­¦ä¹ å¡`)
    }
    
    function fixBalance() {
      log('å¼€å§‹ä¿®å¤ä½™é¢...')
      const user = getCurrentUser()
      if (!user) return
      
      const data = user.data
      let fixed = false
      
      // ä¿®å¤ u_balance
      if (isNaN(data.u_balance) || data.u_balance === null || data.u_balance === undefined) {
        log('ä¿®å¤ u_balance: undefined/NaN â†’ 50U', 'success')
        data.u_balance = 50
        fixed = true
      }
      
      // ä¿®å¤ transfer_points
      if (isNaN(data.transfer_points) || data.transfer_points === null || data.transfer_points === undefined) {
        log('ä¿®å¤ transfer_points: undefined/NaN â†’ 0', 'success')
        data.transfer_points = 0
        fixed = true
      }
      
      // ä¿®å¤ points_balance
      if (isNaN(data.points_balance) || data.points_balance === null || data.points_balance === undefined) {
        log('ä¿®å¤ points_balance: undefined/NaN â†’ 0', 'success')
        data.points_balance = 0
        fixed = true
      }
      
      if (fixed) {
        // ä¿å­˜ä¿®å¤åçš„æ•°æ®
        user.allUsers[user.username].userData = data
        localStorage.setItem('registered_users', JSON.stringify(user.allUsers))
        log('âœ… ä½™é¢ä¿®å¤å®Œæˆï¼', 'success')
        
        // é‡æ–°æ£€æŸ¥
        setTimeout(() => checkBalance(), 500)
      } else {
        log('ä½™é¢æ•°æ®æ­£å¸¸ï¼Œæ— éœ€ä¿®å¤', 'success')
      }
    }
    
    function testCheckin() {
      log('å¼€å§‹æ¨¡æ‹Ÿç­¾åˆ°æµ‹è¯•...')
      const user = getCurrentUser()
      if (!user) return
      
      const data = user.data
      const cards = JSON.parse(localStorage.getItem('user_learning_cards') || '[]')
      const userCards = cards.filter(c => c.user_id === data.id && c.released_points < c.total_points)
      
      if (userCards.length === 0) {
        log('æ²¡æœ‰å¯ç­¾åˆ°çš„å­¦ä¹ å¡', 'error')
        return
      }
      
      const releaseRate = 0.02 // 2%
      let totalReleased = 0
      
      userCards.forEach(card => {
        const dailyRelease = card.total_points * releaseRate
        totalReleased += dailyRelease
        log(`å­¦ä¹ å¡é‡Šæ”¾: ${dailyRelease.toFixed(2)} ç§¯åˆ†`)
      })
      
      const toU = totalReleased * 0.7
      const toTransfer = totalReleased * 0.3
      
      // æ¨¡æ‹Ÿé˜²å¾¡æ€§æ£€æŸ¥
      const currentUBalance = Number(data.u_balance) || 0
      const currentTransferPoints = Number(data.transfer_points) || 0
      const currentPointsBalance = Number(data.points_balance) || 0
      
      log(`å½“å‰ä½™é¢: ${currentUBalance}U`)
      log(`é‡Šæ”¾æ€»é‡: ${totalReleased.toFixed(2)} ç§¯åˆ†`)
      log(`â†’ 70% è½¬U: ${toU.toFixed(2)} â†’ é¢„è®¡ä½™é¢: ${(currentUBalance + toU).toFixed(2)}U`)
      log(`â†’ 30% è½¬ç§¯åˆ†: ${toTransfer.toFixed(2)} â†’ é¢„è®¡ç§¯åˆ†: ${(currentTransferPoints + toTransfer).toFixed(2)}`)
      log('âœ… æ¨¡æ‹Ÿæµ‹è¯•å®Œæˆï¼ˆæœªå®é™…ä¿®æ”¹æ•°æ®ï¼‰', 'success')
    }
    
    function showDetails() {
      log('æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯...')
      const user = getCurrentUser()
      if (!user) return
      
      log('=== ç”¨æˆ·è¯¦ç»†ä¿¡æ¯ ===')
      log(`ID: ${user.data.id}`)
      log(`ç”¨æˆ·å: ${user.username}`)
      log(`Uä½™é¢: ${user.data.u_balance}`)
      log(`äº’è½¬ç§¯åˆ†: ${user.data.transfer_points}`)
      log(`æ€»ç§¯åˆ†: ${user.data.points_balance}`)
      log(`ä»£ç†èº«ä»½: ${user.data.is_agent}`)
      log(`ç®¡ç†å‘˜: ${user.data.is_admin}`)
      log(`é‚€è¯·ç : ${user.data.invite_code}`)
      
      const cards = JSON.parse(localStorage.getItem('user_learning_cards') || '[]')
      const userCards = cards.filter(c => c.user_id === user.data.id)
      log(`=== å­¦ä¹ å¡ä¿¡æ¯ (${userCards.length}å¼ ) ===`)
      userCards.forEach((card, idx) => {
        log(`[${idx + 1}] é‡Šæ”¾: ${card.released_points}/${card.total_points} | çŠ¶æ€: ${card.status}`)
      })
    }
    
    function clearAll() {
      if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰ç”¨æˆ·ã€å­¦ä¹ å¡å’Œäº¤æ˜“è®°å½•ï¼')) {
        return
      }
      
      log('æ¸…é™¤æ‰€æœ‰æ•°æ®...', 'error')
      localStorage.clear()
      log('âœ… æ•°æ®å·²æ¸…é™¤', 'success')
      
      setTimeout(() => {
        if (confirm('æ˜¯å¦é‡æ–°åŠ è½½é¡µé¢ï¼Ÿ')) {
          location.href = '/'
        }
      }, 1000)
    }
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.onload = () => {
      log('ä½™é¢ä¿®å¤å·¥å…·å·²å°±ç»ª')
      checkBalance()
    }
  </script>
</body>
</html>

