<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>紧急登录修复 - AI科技创新发展</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 28px;
      text-align: center;
    }
    
    .subtitle {
      color: #666;
      text-align: center;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .status {
      background: #f0f0f0;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 10px;
      transition: transform 0.2s;
    }
    
    button:hover {
      transform: translateY(-2px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button.secondary {
      background: #6c757d;
    }
    
    .progress {
      margin-top: 20px;
      text-align: center;
      color: #666;
      font-size: 14px;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .step {
      padding: 10px;
      margin: 5px 0;
      border-left: 3px solid #667eea;
      padding-left: 15px;
    }
    
    .step.done {
      opacity: 0.6;
      border-left-color: #28a745;
    }
    
    .step.active {
      background: #f8f9fa;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🚀 紧急登录修复</h1>
    <p class="subtitle">AI科技创新发展平台</p>
    
    <div id="status" class="status info">
      准备清除缓存并重新初始化...
    </div>
    
    <div id="steps">
      <div class="step" id="step1">1️⃣ 清除浏览器缓存</div>
      <div class="step" id="step2">2️⃣ 注销 Service Worker</div>
      <div class="step" id="step3">3️⃣ 清除 localStorage</div>
      <div class="step" id="step4">4️⃣ 重新注册测试账号</div>
      <div class="step" id="step5">5️⃣ 跳转到登录页</div>
    </div>
    
    <div id="progress"></div>
    
    <button id="fixBtn" onclick="startFix()">🔧 开始修复</button>
    <button class="secondary" onclick="window.location.href='/'">返回首页</button>
  </div>

  <script>
    let currentStep = 0;
    
    function updateStep(step, status = 'active') {
      const stepEl = document.getElementById(`step${step}`);
      if (stepEl) {
        stepEl.classList.remove('active', 'done');
        stepEl.classList.add(status);
      }
    }
    
    function updateStatus(message, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
    }
    
    async function startFix() {
      const btn = document.getElementById('fixBtn');
      btn.disabled = true;
      btn.textContent = '修复中...';
      
      try {
        // Step 1: 清除缓存
        updateStep(1, 'active');
        updateStatus('正在清除浏览器缓存...', 'info');
        await sleep(500);
        
        if ('caches' in window) {
          const cacheNames = await caches.keys();
          await Promise.all(cacheNames.map(name => caches.delete(name)));
          console.log('✅ 已清除所有缓存');
        }
        updateStep(1, 'done');
        
        // Step 2: 注销 Service Worker
        updateStep(2, 'active');
        updateStatus('正在注销 Service Worker...', 'info');
        await sleep(500);
        
        if ('serviceWorker' in navigator) {
          const registrations = await navigator.serviceWorker.getRegistrations();
          await Promise.all(registrations.map(reg => reg.unregister()));
          console.log('✅ 已注销所有 Service Worker');
        }
        updateStep(2, 'done');
        
        // Step 3: 清除 localStorage
        updateStep(3, 'active');
        updateStatus('正在清除本地存储...', 'info');
        await sleep(500);
        
        localStorage.clear();
        sessionStorage.clear();
        console.log('✅ 已清除 localStorage 和 sessionStorage');
        updateStep(3, 'done');
        
        // Step 4: 重新注册测试账号
        updateStep(4, 'active');
        updateStatus('正在重新注册测试账号...', 'info');
        await sleep(500);
        
        // 创建测试账号（包含所有必需字段）
        const testUser = {
          id: 'user-' + Date.now(),
          username: 'boss',
          email: 'boss@example.com',
          invite_code: 'BOSS2025',
          role: 'agent',
          is_agent: true,
          is_admin: true,
          u_balance: 32.00,
          points_balance: 0.00,
          mining_points: 0.00,
          transfer_points: 0.00,
          inviter_id: null,
          referral_position: 1,
          has_network: false,
          network_root_id: null,
          direct_referral_count: 0,
          total_earnings: 0,
          qualified_for_dividend: false,
          agent_paid_at: new Date().toISOString(),
          language: 'zh',
          created_at: new Date().toISOString()
        };
        
        const registeredUsers = {
          'boss': {
            password: 'boss123',
            userData: testUser
          }
        };
        
        localStorage.setItem('registered_users', JSON.stringify(registeredUsers));
        localStorage.setItem('current_user', 'boss');
        
        // 创建3张学习卡
        const learningCards = [];
        for (let i = 0; i < 3; i++) {
          learningCards.push({
            id: `card-${Date.now()}-${i}`,
            user_id: testUser.id,
            type: 'type1',
            status: 'inactive',
            is_active: false,
            total_points: 100,
            released_points: 0,
            daily_output: 2,
            base_rate: 0.02,
            boost_rate: 0,
            compound_count: 0,
            last_release_date: null,
            last_checkin_date: null,
            created_at: new Date().toISOString(),
            expires_at: null
          });
        }
        
        localStorage.setItem('user_learning_cards', JSON.stringify(learningCards));
        
        console.log('✅ 已创建测试账号和3张学习卡');
        console.log('用户名: boss');
        console.log('密码: boss123');
        updateStep(4, 'done');
        
        // Step 5: 跳转
        updateStep(5, 'active');
        updateStatus('✅ 修复完成！准备跳转到登录页...', 'success');
        await sleep(1000);
        updateStep(5, 'done');
        
        // 强制刷新并跳转
        window.location.href = '/login?t=' + Date.now();
        
      } catch (error) {
        console.error('修复失败:', error);
        updateStatus('❌ 修复失败: ' + error.message, 'error');
        btn.disabled = false;
        btn.textContent = '🔧 重试修复';
      }
    }
    
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // 页面加载时显示当前状态
    window.addEventListener('load', () => {
      const hasUsers = localStorage.getItem('registered_users');
      const currentUser = localStorage.getItem('current_user');
      
      if (hasUsers) {
        updateStatus('检测到已有用户数据，点击"开始修复"将清除所有数据并重新初始化', 'info');
      } else {
        updateStatus('未检测到用户数据，点击"开始修复"将创建测试账号', 'info');
      }
    });
  </script>
</body>
</html>

