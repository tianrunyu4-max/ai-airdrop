# 🚀 AI代理系统 - 完整测试指南

## 📋 系统概述

### **新业务流程：**
```
第1步：成为AI代理（30U） 
  ↓
第2步：获得互转积分（代理之间互转）
  ↓
第3步：激活第一台学习机（100互转积分）
  ↓
第4步：购买后续学习机（7U/台）
```

---

## ✅ 测试场景

### **场景1：非代理用户尝试购买学习机**

#### **操作步骤：**
1. 登录非代理用户
2. 进入"AI学习机"页面
3. 尝试购买第1台学习机

#### **预期结果：**
- ❌ 无法购买（即使有100积分）
- ⚠️ 提示："需要先成为AI代理（30U）才能激活第一台学习机"
- 💡 页面底部显示："💡 需要先成为AI代理（30U）才能激活第一台学习机"

---

### **场景2：成为AI代理**

#### **操作步骤：**
1. 登录用户（U余额 ≥ 30U）
2. 进入"我的"页面
3. 找到"成为AI代理"卡片（紫色）
4. 点击"🚀 立即成为代理"按钮
5. 确认支付30U

#### **预期结果：**
- ✅ 扣除30U
- ✅ 用户状态变为代理
- ✅ 顶部显示"👑 代理会员"徽章
- ✅ "成为AI代理"卡片消失
- 🎉 提示："恭喜！您已成为AI代理，现在可以互转积分并激活学习机了！"

---

### **场景3：非代理尝试互转积分**

#### **操作步骤：**
1. 登录非代理用户
2. 进入"转账"页面
3. 选择"互转积分"
4. 输入接收方和金额
5. 点击"确认转账"

#### **预期结果：**
- ❌ 转账失败
- ⚠️ 提示："仅AI代理可以互转积分，请先成为代理（30U）"

---

### **场景4：代理互转积分（双方都是代理）**

#### **操作步骤：**
1. 登录代理用户A（有互转积分）
2. 进入"转账"页面
3. 选择"互转积分"
4. 输入代理用户B的用户名
5. 输入金额（如100积分）
6. 点击"确认转账"

#### **预期结果：**
- ✅ 转账成功
- ✅ 用户A积分减少100
- ✅ 用户B积分增加100
- ✅ 交易记录显示

---

### **场景5：代理转积分给非代理**

#### **操作步骤：**
1. 登录代理用户A
2. 进入"转账"页面
3. 选择"互转积分"
4. 输入非代理用户C的用户名
5. 输入金额
6. 点击"确认转账"

#### **预期结果：**
- ❌ 转账失败
- ⚠️ 提示："接收方 [用户名] 还不是代理，无法接收积分"

---

### **场景6：代理激活第一台学习机（100积分）**

#### **操作步骤：**
1. 登录代理用户（互转积分 ≥ 100）
2. 进入"AI学习机"页面
3. 购买1台学习机
4. 确认购买

#### **预期结果：**
- ✅ 购买成功
- ✅ 扣除100互转积分
- ✅ 学习机数量从0台变为1台
- ✅ U余额不变
- 💡 提示信息消失（"需要先成为AI代理"）

---

### **场景7：购买第2台学习机（7U）**

#### **操作步骤：**
1. 已有1台学习机的代理用户
2. 进入"AI学习机"页面
3. 购买1台学习机
4. 确认购买

#### **预期结果：**
- ✅ 购买成功
- ✅ 扣除7U
- ✅ 学习机数量从1台变为2台
- ✅ 互转积分不变

---

### **场景8：完整流程（新用户→代理→激活学习机）**

#### **操作步骤：**
1. **注册新用户**
   - 初始：50U + 0积分 + 0学习机

2. **成为代理**
   - 支付30U → 剩余20U
   - 状态：普通用户 → 代理

3. **获得积分**
   - 方式A：邀请人转赠100积分
   - 方式B：团队成员互转100积分

4. **激活第一台学习机**
   - 支付100积分 → 剩余0积分
   - 学习机：0台 → 1台

5. **购买第二台学习机**
   - 支付7U → 剩余13U
   - 学习机：1台 → 2台

#### **预期结果：**
- ✅ 所有步骤顺利完成
- ✅ 最终状态：13U + 0积分 + 2台学习机

---

## 🔍 数据库验证

### **检查用户代理状态：**
```sql
SELECT 
  id,
  username,
  is_agent,
  agent_paid_at,
  u_balance,
  transfer_points
FROM users
WHERE username = '用户名';
```

### **检查学习机记录：**
```sql
SELECT 
  id,
  user_id,
  initial_points,
  released_points,
  is_active,
  created_at
FROM mining_machines
WHERE user_id = '用户ID'
ORDER BY created_at DESC;
```

### **检查交易记录：**
```sql
SELECT 
  id,
  user_id,
  type,
  amount,
  currency,
  description,
  created_at
FROM transactions
WHERE user_id = '用户ID'
ORDER BY created_at DESC
LIMIT 10;
```

---

## 🐛 常见问题排查

### **问题1：成为代理后按钮还在**
- **原因：** 前端缓存未刷新
- **解决：** 刷新页面（F5）或退出重新登录

### **问题2：代理状态徽章未显示**
- **原因：** 数据库`is_agent`字段未更新
- **解决：** 检查数据库或重新成为代理

### **问题3：积分互转提示"非代理"**
- **原因：** 用户实际未成为代理
- **解决：** 检查数据库`is_agent`字段和`agent_paid_at`字段

### **问题4：购买学习机扣了积分但未创建**
- **原因：** 后端事务失败
- **解决：** 检查后端日志和数据库`mining_machines`表

---

## 📊 测试数据示例

### **测试用户数据：**

| 用户名 | 状态 | U余额 | 互转积分 | 学习机 | 说明 |
|--------|------|-------|----------|--------|------|
| admin | 代理 | 100U | 200 | 0台 | 测试转赠积分 |
| user01 | 普通 | 50U | 0 | 0台 | 测试成为代理 |
| user02 | 代理 | 30U | 100 | 0台 | 测试激活学习机 |
| user03 | 代理 | 50U | 50 | 1台 | 测试购买第2台 |

### **SQL创建测试数据：**
```sql
-- 给用户增加余额
UPDATE users
SET u_balance = u_balance + 100
WHERE username = 'user01';

-- 给代理用户转赠积分
UPDATE users
SET transfer_points = transfer_points + 100
WHERE username = 'user02' AND is_agent = true;
```

---

## ✅ 验收标准

### **功能完整性：**
- ✅ 非代理无法互转积分
- ✅ 非代理无法激活学习机
- ✅ 代理可以互转积分（双方都是代理）
- ✅ 代理可以用100积分激活第1台学习机
- ✅ 第2台及以后用7U购买
- ✅ U余额和积分正确扣除和增加
- ✅ 交易记录完整记录

### **UI/UX：**
- ✅ 代理徽章显示正确
- ✅ "成为代理"卡片显示/隐藏正确
- ✅ 提示信息友好明确
- ✅ 按钮状态和禁用逻辑正确
- ✅ 余额实时更新

### **安全性：**
- ✅ 不能绕过代理限制
- ✅ 不能重复成为代理
- ✅ 余额验证严格
- ✅ 并发操作安全

---

## 🎯 下一步

测试完成后：
1. 修复发现的Bug
2. 优化用户体验
3. 准备对碰系统（30U加入）
4. 配置定时任务
5. 准备部署

---

**祝测试顺利！** 🚀

