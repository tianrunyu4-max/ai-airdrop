# 🔒 系统安全审计报告

**审计日期**: 2025-10-30  
**审计范围**: AI智能空投系统（全局）  
**审计工程师**: AI Assistant

---

## 📊 审计总结

### ✅ 已加固（安全）
| 模块 | 状态 | 说明 |
|-----|------|------|
| **余额操作** | ✅ 安全 | 使用数据库原子操作 + 行级锁 |
| **游客账号创建** | ✅ 安全 | 已添加防重复创建锁 |
| **在线人数统计** | ✅ 已优化 | 实时查询数据库 |
| **转账操作** | ✅ 安全 | TransactionService事务保护 |
| **提现操作** | ✅ 安全 | WalletManager + 余额验证 |

### ⚠️ 需要加固（中危）
| 模块 | 风险等级 | 问题描述 | 建议修复 |
|-----|---------|---------|---------|
| **学习卡购买** | 🟡 中危 | localStorage + 单次数据库更新，并发可能导致余额扣除但卡未创建 | 改用事务或RPC函数 |
| **学习卡签到** | 🟡 中危 | 纯localStorage操作，无数据库原子保护 | 前端防抖 + 后端验证 |
| **升级代理** | 🟡 中危 | 按钮已有loading保护，但无后端幂等性保证 | 添加订单号/请求ID去重 |

### 🔴 需要加固（高危）
| 模块 | 风险等级 | 问题描述 | 建议修复 |
|-----|---------|---------|---------|
| **学习卡兑换（多次点击）** | 🔴 高危 | 前端只有loading状态，快速点击可能重复扣款 | **立即添加锁** |
| **团队奖励计算** | 🔴 高危 | 无并发保护，可能重复发放奖励 | **添加分布式锁** |

---

## 🔧 详细问题分析

### 1. 🔴 高危：学习卡兑换（重复点击）

**问题代码**:
```vue
// src/views/points/PointsView.vue:477
const exchangeCard = async () => {
  loading.value = true  // ❌ 只有状态标记，无法防止并发
  
  try {
    if (paymentMethod.value === 'u') {
      result = await MiningService.purchaseMachine(userId, quantity)
    }
  } finally {
    loading.value = false
  }
}
```

**风险场景**:
- 用户快速双击"立即兑换"按钮
- 网络延迟时点击多次
- 恶意用户使用脚本并发请求

**影响**:
- 💰 余额被多次扣除
- 📦 学习卡数量不符
- 🔍 流水记录混乱

**修复方案**:
```typescript
// ✅ 方案1：前端防重复锁（推荐）
const isExchanging = ref(false)

const exchangeCard = async () => {
  // 🔒 防重复点击
  if (isExchanging.value) {
    toast.warning('正在处理中，请勿重复点击')
    return
  }
  
  isExchanging.value = true
  loading.value = true
  
  try {
    // ... 业务逻辑
  } finally {
    loading.value = false
    // 延迟释放锁（防止快速重复点击）
    setTimeout(() => {
      isExchanging.value = false
    }, 1000)
  }
}
```

```typescript
// ✅ 方案2：后端幂等性保证（最佳）
// 在MiningService.purchaseMachine中添加:
static async purchaseMachine(userId, quantity, requestId?: string) {
  // 1. 检查requestId是否已处理
  if (requestId) {
    const processed = await this.checkRequestProcessed(requestId)
    if (processed) {
      throw new Error('该请求已处理，请勿重复提交')
    }
  }
  
  // 2. 使用数据库事务
  const { data, error } = await supabase.rpc('purchase_learning_card', {
    p_user_id: userId,
    p_quantity: quantity,
    p_request_id: requestId
  })
  
  // ... 后续逻辑
}
```

---

### 2. 🟡 中危：学习卡签到（并发问题）

**问题代码**:
```typescript
// src/services/MiningService.ts:399
static async checkin(userId: string) {
  // ❌ 纯localStorage操作，无原子性保证
  const allCards = JSON.parse(localStorage.getItem('user_learning_cards') || '[]')
  
  for (const card of activeCards) {
    card.released_points += dailyRelease  // ⚠️ 并发不安全
    card.last_checkin_date = today
  }
  
  localStorage.setItem('user_learning_cards', JSON.stringify(allCards))
}
```

**风险场景**:
- 多个标签页同时签到
- 签到中刷新页面
- localStorage数据不一致

**修复方案**:
```typescript
// ✅ 添加签到锁
const CHECKIN_LOCK_KEY = 'checkin_lock'

static async checkin(userId: string) {
  // 🔒 检查锁
  const lockTime = parseInt(localStorage.getItem(CHECKIN_LOCK_KEY) || '0')
  const now = Date.now()
  
  if (lockTime && (now - lockTime) < 3000) {
    throw new Error('签到处理中，请稍候...')
  }
  
  // 加锁
  localStorage.setItem(CHECKIN_LOCK_KEY, now.toString())
  
  try {
    // ... 签到逻辑
  } finally {
    // 释放锁
    localStorage.removeItem(CHECKIN_LOCK_KEY)
  }
}
```

---

### 3. 🟡 中危：升级代理（幂等性）

**问题代码**:
```vue
// src/views/subscription/SubscriptionView.vue:167
const handleBecomeAgent = async () => {
  becomingAgent.value = true  // ❌ 前端状态，刷新页面失效
  
  try {
    const result = await UserService.subscribeAgent(user.value.id)
  } finally {
    becomingAgent.value = false
  }
}
```

**修复方案**:
```typescript
// ✅ 后端添加幂等性检查
static async subscribeAgent(userId: string, requestId?: string) {
  // 1. 检查是否已经是代理
  const user = await UserRepository.findById(userId)
  if (user.is_agent) {
    return {
      success: true,
      data: user,
      message: '您已经是代理身份'
    }
  }
  
  // 2. 使用数据库事务 + 检查
  const { data, error } = await supabase.rpc('upgrade_to_agent', {
    p_user_id: userId,
    p_request_id: requestId
  })
  
  return { success: !error, data }
}
```

---

### 4. 🔴 高危：团队奖励计算（重复发放）

**问题描述**:
- TeamService.calculateRewards 可能被多次调用
- 对碰奖、级差奖可能重复计算
- 无分布式锁保护

**修复方案**:
```sql
-- ✅ 数据库级别的分布式锁
CREATE OR REPLACE FUNCTION calculate_team_rewards_with_lock(
  p_user_id UUID
)
RETURNS JSONB
LANGUAGE plpgsql
AS $$
DECLARE
  v_lock_key TEXT;
  v_lock_acquired BOOLEAN;
BEGIN
  v_lock_key := 'reward_calc_' || p_user_id::TEXT;
  
  -- 尝试获取锁（最多等待1秒）
  v_lock_acquired := pg_try_advisory_lock(hashtext(v_lock_key));
  
  IF NOT v_lock_acquired THEN
    RAISE EXCEPTION '奖励计算中，请稍候...';
  END IF;
  
  BEGIN
    -- 执行奖励计算逻辑
    -- ...
    
    -- 释放锁
    PERFORM pg_advisory_unlock(hashtext(v_lock_key));
    
    RETURN jsonb_build_object('success', true);
  EXCEPTION WHEN OTHERS THEN
    -- 异常时也要释放锁
    PERFORM pg_advisory_unlock(hashtext(v_lock_key));
    RAISE;
  END;
END;
$$;
```

---

## 🧪 测试清单

### 1. 并发测试

#### ✅ 余额操作并发测试
```bash
# 测试场景：100个并发请求同时扣除1U
for i in {1..100}; do
  curl -X POST /api/deduct_balance \
    -d '{"user_id":"xxx","amount":1}' &
done
wait

# 预期结果：
# - 余额准确减少100U（原子操作）
# - 流水记录100条（无遗漏）
# - 无报错或数据不一致
```

#### ⚠️ 学习卡购买并发测试（需修复后测试）
```bash
# 测试场景：快速点击10次兑换按钮
# 方法：使用浏览器控制台

for (let i = 0; i < 10; i++) {
  document.querySelector('button.exchange-btn').click()
}

# 预期结果：
# - 只扣款1次
# - 只创建1张学习卡
# - 其他9次被拒绝（有提示）
```

#### ⚠️ 签到并发测试
```bash
# 测试场景：多个标签页同时签到
# 方法：打开3个标签页，同时点击签到

# 预期结果：
# - 只有1次签到成功
# - 释放率只计算1次
# - 其他标签页显示"今日已签到"
```

---

### 2. 余额一致性测试

```javascript
// 测试脚本：检查localStorage和数据库余额是否一致
async function checkBalanceConsistency() {
  // 1. 读取localStorage余额
  const localUser = JSON.parse(localStorage.getItem('user_session'))
  const localBalance = localUser.u_balance
  
  // 2. 查询数据库余额
  const { data } = await supabase
    .from('users')
    .select('u_balance')
    .eq('id', localUser.id)
    .single()
  
  const dbBalance = data.u_balance
  
  // 3. 比较
  if (Math.abs(localBalance - dbBalance) > 0.01) {
    console.error('❌ 余额不一致！', {
      local: localBalance,
      db: dbBalance,
      diff: localBalance - dbBalance
    })
  } else {
    console.log('✅ 余额一致')
  }
}
```

---

### 3. 数据完整性测试

```sql
-- 测试1：检查学习卡总数是否正确
SELECT 
  u.username,
  u.id,
  COUNT(mc.id) as card_count,
  SUM(CASE WHEN mc.total_points = 300 THEN 8 ELSE 0 END) as total_cost
FROM users u
LEFT JOIN mining_machines mc ON u.id = mc.user_id
GROUP BY u.id
HAVING COUNT(mc.id) > 10; -- 应该没有超过10张的

-- 测试2：检查是否有未记录流水的扣款
SELECT 
  u.username,
  COUNT(t.id) as transaction_count,
  SUM(CASE WHEN t.amount < 0 THEN t.amount ELSE 0 END) as total_deduct
FROM users u
LEFT JOIN transactions t ON u.id = t.user_id
WHERE t.created_at > NOW() - INTERVAL '24 hours'
GROUP BY u.id;

-- 测试3：检查是否有重复签到
SELECT 
  user_id,
  last_checkin_date,
  COUNT(*) as checkin_count
FROM mining_machines
WHERE last_checkin_date = CURRENT_DATE
GROUP BY user_id, last_checkin_date
HAVING COUNT(*) > 1; -- 应该为空
```

---

## 🚀 立即修复的优先级

### P0（立即修复，今天内完成）
1. **学习卡兑换防重复点击** - 添加前端锁
2. **学习卡签到防并发** - 添加localStorage锁

### P1（本周内完成）
3. **升级代理幂等性** - 后端检查is_agent状态
4. **团队奖励分布式锁** - 添加数据库锁

### P2（下周完成）
5. **完善并发测试** - 编写自动化测试脚本
6. **余额一致性监控** - 定期检查localStorage vs DB

---

## 📝 代码修改清单

### 文件1: `src/views/points/PointsView.vue`
**需要修改的函数**:
- `exchangeCard()` - 添加防重复锁
- `handleCheckin()` - 添加防并发锁

### 文件2: `src/services/MiningService.ts`
**需要修改的函数**:
- `purchaseMachine()` - 改用RPC事务
- `checkin()` - 添加localStorage锁

### 文件3: `src/services/UserService.ts`
**需要修改的函数**:
- `subscribeAgent()` - 添加幂等性检查

### 文件4: `supabase/migrations/` (新建)
**需要创建的SQL**:
- `purchase_learning_card_rpc.sql` - 学习卡购买事务
- `team_rewards_lock.sql` - 团队奖励分布式锁

---

## ✅ 已经安全的模块（无需修改）

### 1. WalletManager（余额操作）
```typescript
// ✅ 使用数据库原子操作 + 行级锁
static async deduct(userId, amount, type, description) {
  const { data, error } = await supabase.rpc('deduct_user_balance', {
    p_user_id: userId,
    p_amount: amount
  })
  // 自动检查余额充足 + 事务保护
}
```

### 2. TransactionService（转账）
```typescript
// ✅ 使用事务 + 回滚机制
static async transferU({ fromUserId, toUserId, amount }) {
  // 1. 扣除发送方
  await WalletManager.deduct(fromUserId, amount, ...)
  
  // 2. 增加接收方
  await WalletManager.add(toUserId, amount, ...)
  
  // 失败自动回滚
}
```

### 3. AuthStore（游客账号）
```typescript
// ✅ 已添加防重复创建锁
const isCreatingGuest = ref(false)

async function createGuestAccount() {
  if (isCreatingGuest.value) {
    return false  // 防止重复创建
  }
  
  isCreatingGuest.value = true
  try {
    // ... 创建逻辑
  } finally {
    isCreatingGuest.value = false
  }
}
```

---

## 📊 风险评估矩阵

| 模块 | 发生概率 | 影响程度 | 风险等级 | 当前状态 |
|-----|---------|---------|---------|---------|
| 余额扣除 | 低 | 高 | 🟢 低 | ✅ 已加固 |
| 学习卡兑换 | 中 | 高 | 🔴 高 | ⚠️ 需修复 |
| 学习卡签到 | 中 | 中 | 🟡 中 | ⚠️ 需修复 |
| 升级代理 | 低 | 高 | 🟡 中 | ⚠️ 需修复 |
| 团队奖励 | 低 | 高 | 🔴 高 | ⚠️ 需修复 |
| 转账操作 | 低 | 高 | 🟢 低 | ✅ 已加固 |
| 游客注册 | 低 | 中 | 🟢 低 | ✅ 已加固 |

---

## 🎯 总结

### 当前状态
- ✅ **核心财务操作已安全**（余额、转账、提现）
- ⚠️ **学习卡系统需加固**（购买、签到）
- ⚠️ **代理升级需优化**（幂等性）
- ⚠️ **团队奖励需锁保护**（分布式锁）

### 建议措施
1. **立即修复P0问题**（学习卡兑换、签到）
2. **编写自动化测试**（并发、一致性）
3. **添加监控告警**（余额异常、重复操作）
4. **定期数据审计**（每天检查流水和余额）

---

**报告生成时间**: 2025-10-30  
**下次审计时间**: 2025-11-06

