# 空投系统部署指南（手动+自动）

## 🎯 系统概述

### **双模式运营：**
- **90% Web3空投** - 管理员手动添加/编辑
- **10% CEX空投** - 自动同步交易所（Binance/OKX/Bybit）

---

## 📋 部署步骤

### **步骤1：升级数据库表结构**

在Supabase SQL编辑器中执行：

```bash
文件位置：supabase/migrations/升级airdrops表结构.sql
```

或复制以下SQL：

```sql
-- 添加新字段
ALTER TABLE public.airdrops
ADD COLUMN IF NOT EXISTS twitter_url TEXT,
ADD COLUMN IF NOT EXISTS ai_score DECIMAL(3, 1) DEFAULT 7.0,
ADD COLUMN IF NOT EXISTS risk_level VARCHAR(20) DEFAULT 'medium',
ADD COLUMN IF NOT EXISTS estimated_value DECIMAL(10, 2) DEFAULT 0,
ADD COLUMN IF NOT EXISTS difficulty VARCHAR(20) DEFAULT 'medium',
ADD COLUMN IF NOT EXISTS time_required VARCHAR(50),
ADD COLUMN IF NOT EXISTS participation_cost TEXT,
ADD COLUMN IF NOT EXISTS tags JSONB DEFAULT '[]'::jsonb,
ADD COLUMN IF NOT EXISTS source TEXT,
ADD COLUMN IF NOT EXISTS source_type VARCHAR(50),
ADD COLUMN IF NOT EXISTS verified BOOLEAN DEFAULT false,
ADD COLUMN IF NOT EXISTS push_count INTEGER DEFAULT 0,
ADD COLUMN IF NOT EXISTS last_pushed_at TIMESTAMPTZ;

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_airdrops_type_status ON public.airdrops(type, status);
CREATE INDEX IF NOT EXISTS idx_airdrops_ai_score ON public.airdrops(ai_score DESC);
CREATE INDEX IF NOT EXISTS idx_airdrops_verified ON public.airdrops(verified);
CREATE INDEX IF NOT EXISTS idx_airdrops_source_type ON public.airdrops(source_type);
CREATE INDEX IF NOT EXISTS idx_airdrops_last_pushed ON public.airdrops(last_pushed_at DESC NULLS LAST);
```

---

### **步骤2：插入初始数据（可选）**

如果想要一些初始数据，执行：

```bash
文件位置：supabase/migrations/真实空投数据_完整版.sql
```

这将插入6个Web3空投 + 3个CEX空投的示例数据。

---

### **步骤3：部署Edge Function（自动同步CEX）**

#### **3.1 安装Supabase CLI**

```bash
# Windows (PowerShell)
scoop install supabase

# 或使用npm
npm install -g supabase
```

#### **3.2 登录Supabase**

```bash
supabase login
```

#### **3.3 部署Edge Function**

```bash
# 进入项目目录
cd "C:\Users\sss\Desktop\AI智能空投"

# 链接到你的项目
supabase link --project-ref vtezesyfhvbkgpdkuyeo

# 部署函数
supabase functions deploy sync-cex-airdrops
```

---

### **步骤4：设置定时任务（可选）**

如果想要自动定时同步CEX空投，有两种方式：

#### **方式A：Supabase Cron（推荐）**

在Supabase Dashboard → Database → Extensions 中启用 `pg_cron`，然后执行SQL：

```sql
-- 每天凌晨2点自动同步CEX空投
SELECT cron.schedule(
  'sync-cex-airdrops-daily',
  '0 2 * * *',
  $$
  SELECT
    net.http_post(
      url:='https://vtezesyfhvbkgpdkuyeo.supabase.co/functions/v1/sync-cex-airdrops',
      headers:='{"Content-Type": "application/json", "Authorization": "Bearer YOUR_ANON_KEY"}'::jsonb
    ) as request_id;
  $$
);
```

**注意：**
- 替换 `vtezesyfhvbkgpdkuyeo` 为你的项目ID
- 替换 `YOUR_ANON_KEY` 为你的Anon Key（在Supabase Settings → API中找到）

#### **方式B：手动触发**

管理员在后台点击"同步CEX空投"按钮手动同步。

---

### **步骤5：部署前端代码**

```bash
# 推送代码到GitHub
git add .
git commit -m "添加空投管理系统（手动+自动）"
git push

# Vercel会自动部署
# 等待2-3分钟
```

---

## 🎨 使用说明

### **管理员操作：**

1. **登录管理后台**
   - 访问：https://www.ai-airdrop.top/admin
   - 点击左侧菜单"空投管理"

2. **手动添加Web3空投**
   - 点击"添加Web3空投"按钮
   - 填写表单（标题、描述、奖励、AI评分等）
   - 点击"保存"

3. **编辑已有空投**
   - 在列表中点击"编辑"按钮
   - 修改信息后保存

4. **同步CEX空投**
   - 点击"同步CEX空投"按钮
   - 系统自动从Binance/OKX/Bybit获取最新空投
   - 同步完成后会显示新增和更新数量

5. **查看统计**
   - 顶部卡片显示：总数、Web3数、CEX数、平均评分
   - 可按类型、状态筛选

---

## 📊 数据流程

```
┌─────────────────────────────────────────────────────┐
│                     数据来源                          │
├──────────────────┬──────────────────────────────────┤
│   手动添加 (90%)  │      自动同步 (10%)               │
│                  │                                  │
│  管理员通过后台   │  Supabase Edge Function          │
│  添加Web3空投    │  ↓                               │
│  ↓               │  调用交易所API                    │
│  保存到数据库    │  ↓                               │
│                  │  Binance Launchpool API          │
│                  │  OKX Jumpstart API               │
│                  │  Bybit ByStarter (静态)          │
│                  │  ↓                               │
│                  │  解析数据 → 保存到数据库          │
└──────────────────┴──────────────────────────────────┘
                            ↓
              ┌─────────────────────────┐
              │   airdrops 表            │
              │   (统一数据源)           │
              └─────────────────────────┘
                            ↓
              ┌─────────────────────────┐
              │  聊天机器人自动推送      │
              │  90% Web3               │
              │  10% CEX                │
              └─────────────────────────┘
```

---

## 🔧 API说明

### **Binance公告API**

```
GET https://www.binance.com/bapi/composite/v1/public/cms/article/list/query?type=1&pageSize=10
```

- **无需认证**
- **返回最新10条公告**
- **筛选包含"Launchpool"的公告**

### **OKX公告API**

```
GET https://www.okx.com/api/v5/public/announcements?annType=3&limit=10
```

- **无需认证**
- **返回最新10条公告**
- **筛选包含"Jumpstart"的公告**

### **Bybit**

- **暂无公开API**
- **使用固定模板数据**

---

## ⚙️ 配置参数

### **空投推送逻辑（ChatView.vue）**

```typescript
// 90% Web3, 10% CEX
const randomNum = Math.random()
const type = randomNum < 0.9 ? 'web3' : 'cex'

// 只推送 AI评分 ≥ 7.0 的优质项目
.gte('ai_score', 7.0)
.order('ai_score', { ascending: false })
```

---

## 📝 表结构说明

### **airdrops 表字段**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| title | TEXT | 标题 |
| description | TEXT | 描述 |
| reward_amount | DECIMAL | 预计奖励(USDT) |
| image_url | TEXT | 图片URL |
| project_url | TEXT | 项目链接 |
| twitter_url | TEXT | Twitter链接 |
| requirements | JSONB | 任务要求数组 |
| category | VARCHAR | 分类(DeFi/Layer2/CEX等) |
| type | VARCHAR | 类型(web3/cex) |
| status | VARCHAR | 状态(active/ended) |
| ai_score | DECIMAL | AI评分(0-10) |
| risk_level | VARCHAR | 风险(none/low/medium/high) |
| difficulty | VARCHAR | 难度 |
| time_required | VARCHAR | 所需时间 |
| participation_cost | TEXT | 参与成本 |
| tags | JSONB | 标签数组 |
| source | TEXT | 数据来源 |
| source_type | VARCHAR | 来源类型(manual/cex_announcement) |
| verified | BOOLEAN | 是否验证 |
| push_count | INTEGER | 推送次数 |
| last_pushed_at | TIMESTAMPTZ | 最后推送时间 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

---

## 🎯 优势

### **手动管理（Web3）：**
✅ **灵活性高** - 可以添加任何项目  
✅ **质量可控** - 人工筛选优质项目  
✅ **信息详细** - 可以写详细的攻略  
✅ **及时更新** - 发现新项目立即添加  

### **自动同步（CEX）：**
✅ **实时性强** - 交易所公告第一时间同步  
✅ **数据准确** - 直接来自官方API  
✅ **零维护** - 定时自动运行  
✅ **覆盖全面** - 主流交易所全覆盖  

---

## 🐛 故障排查

### **Edge Function部署失败**

```bash
# 检查Supabase CLI版本
supabase --version

# 重新链接项目
supabase link --project-ref vtezesyfhvbkgpdkuyeo

# 查看函数日志
supabase functions logs sync-cex-airdrops
```

### **同步CEX空投失败**

1. 检查网络连接
2. 查看控制台错误信息
3. 检查Edge Function日志
4. 交易所API可能被墙，考虑使用代理

### **数据不显示**

1. 检查数据库中是否有数据：
```sql
SELECT COUNT(*) FROM airdrops WHERE status = 'active';
```

2. 检查RLS策略是否正确
3. 刷新浏览器缓存（Ctrl + F5）

---

## 📞 支持

如有问题：
1. 查看控制台错误信息（F12）
2. 检查Supabase日志
3. 查看Edge Function日志

---

## 🚀 后续优化方向

1. **添加更多交易所** - Gate.io、Huobi等
2. **Twitter API集成** - 爬取官方推特
3. **AI自动评分** - 根据项目数据自动计算评分
4. **用户反馈系统** - 用户可以评价空投质量
5. **收藏和提醒** - 用户可以收藏空投并设置提醒

---

**部署完成后，你就拥有了一个手动+自动的完整空投系统！** 🎉

