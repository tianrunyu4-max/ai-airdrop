# ğŸ” å¯†ç åŠ å¯†å®Œæˆï¼

## âœ… å·²å®Œæˆçš„æ”¹åŠ¨

### 1. å®‰è£…ä¾èµ–åŒ…

```bash
âœ… npm install bcryptjs
âœ… npm install -D @types/bcryptjs
```

### 2. ä¿®æ”¹ `src/stores/auth.ts`

#### å¯¼å…¥ bcryptï¼š
```typescript
import bcrypt from 'bcryptjs'
```

#### ä¿®æ”¹æ³¨å†Œå‡½æ•°ï¼ˆ`register`ï¼‰ï¼š
```typescript
// ğŸ” ä½¿ç”¨ bcrypt åŠ å¯†å¯†ç 
const hashedPassword = await bcrypt.hash(password, 10)

// åˆ›å»ºæ–°ç”¨æˆ·
const { data: newUser, error: insertError } = await supabase
  .from('users')
  .insert({
    username,
    password_hash: hashedPassword, // âœ… å­˜å‚¨åŠ å¯†åçš„å¯†ç 
    // ... å…¶ä»–å­—æ®µ
  })
```

**æ”¹åŠ¨è¯´æ˜ï¼š**
- å¯†ç åœ¨å­˜å‚¨å‰ä½¿ç”¨ bcrypt åŠ å¯†
- `10` æ˜¯ç›è½®æ•°ï¼ˆsalt roundsï¼‰ï¼Œå¹³è¡¡å®‰å…¨æ€§å’Œæ€§èƒ½
- åŠ å¯†åçš„å¯†ç ç±»ä¼¼ï¼š`$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy`

#### ä¿®æ”¹ç™»å½•å‡½æ•°ï¼ˆ`login`ï¼‰ï¼š
```typescript
// ğŸ” ä½¿ç”¨ bcrypt éªŒè¯åŠ å¯†å¯†ç 
const isPasswordValid = await bcrypt.compare(password, users.password_hash)

if (!isPasswordValid) {
  throw new Error('å¯†ç é”™è¯¯')
}
```

**æ”¹åŠ¨è¯´æ˜ï¼š**
- ä½¿ç”¨ `bcrypt.compare()` éªŒè¯å¯†ç 
- è‡ªåŠ¨å¤„ç†åŠ å¯†å¯¹æ¯”ï¼Œæ— éœ€æ‰‹åŠ¨è§£å¯†
- è¿”å› `true`ï¼ˆæ­£ç¡®ï¼‰æˆ– `false`ï¼ˆé”™è¯¯ï¼‰

---

## ğŸ”’ å®‰å…¨æ€§æå‡

### æ”¹é€ å‰ï¼š
```
æ•°æ®åº“ä¸­çš„å¯†ç ï¼š
| username | password_hash |
|----------|---------------|
| å¼ ä¸‰     | 123456        |  âŒ æ˜æ–‡å¯†ç 
| æå››     | abc123        |  âŒ ä»»ä½•äººéƒ½èƒ½çœ‹åˆ°
```

**å±é™©æ€§ï¼š**
- æ•°æ®åº“æ³„éœ² = æ‰€æœ‰å¯†ç æ³„éœ²
- æ•°æ®åº“ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°å¯†ç 
- è¿åã€Šä¸ªäººä¿¡æ¯ä¿æŠ¤æ³•ã€‹

### æ”¹é€ åï¼š
```
æ•°æ®åº“ä¸­çš„å¯†ç ï¼š
| username | password_hash                                                       |
|----------|---------------------------------------------------------------------|
| å¼ ä¸‰     | $2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy       |
| æå››     | $2a$10$xK7BmBvJFWM5QmCPR9FdHuXYGKvJ8mLnOpQrStUvWxYzAbCdEfGhI       |
```

**ä¼˜åŠ¿ï¼š**
- âœ… æ•°æ®åº“æ³„éœ²ä¹Ÿæ— æ³•çŸ¥é“çœŸå®å¯†ç 
- âœ… å³ä½¿æ˜¯æ•°æ®åº“ç®¡ç†å‘˜ä¹Ÿæ— æ³•çœ‹åˆ°å¯†ç 
- âœ… ç¬¦åˆæ³•å¾‹æ³•è§„è¦æ±‚
- âœ… ä¸“ä¸šä¸”å®‰å…¨

---

## ğŸ“Š bcrypt åŠ å¯†åŸç†

### ç‰¹æ€§ï¼š

1. **å•å‘å“ˆå¸Œ**
   - ä»å¯†ç  â†’ å“ˆå¸Œå€¼ï¼šå¯ä»¥
   - ä»å“ˆå¸Œå€¼ â†’ å¯†ç ï¼šä¸å¯èƒ½

2. **åŠ ç›ï¼ˆSaltï¼‰**
   - åŒæ ·çš„å¯†ç ï¼Œæ¯æ¬¡åŠ å¯†ç»“æœéƒ½ä¸åŒ
   - é˜²æ­¢å½©è™¹è¡¨æ”»å‡»

3. **å¯è°ƒèŠ‚çš„è®¡ç®—æˆæœ¬**
   - `salt rounds = 10` è¡¨ç¤ºè®¡ç®— 2^10 = 1024 æ¬¡
   - è¶Šå¤§è¶Šå®‰å…¨ï¼Œä½†è¶Šæ…¢
   - 10 æ˜¯æ¨èå€¼ï¼ˆå¹³è¡¡æ€§èƒ½å’Œå®‰å…¨ï¼‰

### ç¤ºä¾‹ï¼š

```typescript
// æ³¨å†Œæ—¶
const password = "123456"
const hash1 = await bcrypt.hash(password, 10)
// ç»“æœ: "$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy"

const hash2 = await bcrypt.hash(password, 10)
// ç»“æœ: "$2a$10$xK7BmBvJFWM5QmCPR9FdHuXYGKvJ8mLnOpQrStUvWxYzAbCdEfGhI"

// åŒæ ·çš„å¯†ç ï¼Œä¸¤æ¬¡åŠ å¯†ç»“æœä¸åŒï¼

// ç™»å½•æ—¶
const isValid1 = await bcrypt.compare("123456", hash1)
// è¿”å›: true

const isValid2 = await bcrypt.compare("123456", hash2)
// è¿”å›: true

const isValid3 = await bcrypt.compare("wrong", hash1)
// è¿”å›: false
```

---

## âš ï¸ é‡è¦æé†’

### ç°æœ‰ç”¨æˆ·çš„å¤„ç†

**é—®é¢˜ï¼š**
å¦‚æœæ•°æ®åº“ä¸­å·²ç»æœ‰ç”¨æˆ·ï¼ˆä½¿ç”¨æ˜æ–‡å¯†ç ï¼‰ï¼Œä»–ä»¬å°†æ— æ³•ç™»å½•ï¼

**è§£å†³æ–¹æ¡ˆAï¼šæ¸…ç©ºæ•°æ®åº“ï¼ˆæ¨è-å¦‚æœè¿˜åœ¨æµ‹è¯•é˜¶æ®µï¼‰**

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š
```sql
-- åˆ é™¤æ‰€æœ‰ç”¨æˆ·
DELETE FROM users;

-- åˆ é™¤ç›¸å…³æ•°æ®
DELETE FROM binary_members;
DELETE FROM group_members;
-- ... å…¶ä»–å…³è”è¡¨
```

ç„¶åé‡æ–°æ³¨å†Œï¼Œå¯†ç ä¼šè‡ªåŠ¨åŠ å¯†ã€‚

**è§£å†³æ–¹æ¡ˆBï¼šè¿ç§»ç°æœ‰å¯†ç **

å¦‚æœæœ‰çœŸå®ç”¨æˆ·æ•°æ®ï¼Œéœ€è¦é€šçŸ¥ç”¨æˆ·ï¼š
1. "ç”±äºå®‰å…¨å‡çº§ï¼Œè¯·é‡ç½®å¯†ç "
2. æä¾›å¯†ç é‡ç½®åŠŸèƒ½
3. æˆ–è€…ç¼–å†™è¿ç§»è„šæœ¬ï¼ˆå¦‚æœä½ çŸ¥é“æ—§å¯†ç ï¼‰

**è§£å†³æ–¹æ¡ˆCï¼šåˆ›å»ºè¿ç§»è„šæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰**

```typescript
// migrate-passwords.ts
import { supabase } from '@/lib/supabase'
import bcrypt from 'bcryptjs'

async function migratePasswords() {
  // 1. è·å–æ‰€æœ‰ç”¨æˆ·
  const { data: users } = await supabase
    .from('users')
    .select('id, username, password_hash')
  
  if (!users) return
  
  // 2. éå†æ¯ä¸ªç”¨æˆ·
  for (const user of users) {
    // æ£€æŸ¥å¯†ç æ˜¯å¦å·²åŠ å¯†ï¼ˆbcrypt å¯†ç ä»¥ $2a$ æˆ– $2b$ å¼€å¤´ï¼‰
    if (!user.password_hash.startsWith('$2')) {
      console.log(`è¿ç§»ç”¨æˆ·: ${user.username}`)
      
      // åŠ å¯†æ˜æ–‡å¯†ç 
      const hashedPassword = await bcrypt.hash(user.password_hash, 10)
      
      // æ›´æ–°æ•°æ®åº“
      await supabase
        .from('users')
        .update({ password_hash: hashedPassword })
        .eq('id', user.id)
      
      console.log(`âœ… å·²åŠ å¯†: ${user.username}`)
    } else {
      console.log(`â­ï¸  è·³è¿‡ï¼ˆå·²åŠ å¯†ï¼‰: ${user.username}`)
    }
  }
  
  console.log('ğŸ‰ å¯†ç è¿ç§»å®Œæˆï¼')
}

// è¿è¡Œè¿ç§»ï¼ˆä»…è¿è¡Œä¸€æ¬¡ï¼‰
migratePasswords()
```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. æµ‹è¯•æ³¨å†Œ

1. æ‰“å¼€åº”ç”¨
2. æ³¨å†Œæ–°ç”¨æˆ·ï¼š
   - ç”¨æˆ·åï¼š`test123`
   - å¯†ç ï¼š`test123`
3. æ³¨å†ŒæˆåŠŸåï¼Œæ£€æŸ¥ Supabase æ•°æ®åº“ï¼š

```sql
SELECT username, password_hash FROM users WHERE username = 'test123';
```

**é¢„æœŸç»“æœï¼š**
```
username | password_hash
---------|------------------------------------------------------------------
test123  | $2a$10$xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

å¯†ç åº”è¯¥æ˜¯ä¸€ä¸²ä»¥ `$2a$10$` å¼€å¤´çš„é•¿å­—ç¬¦ä¸²ã€‚

### 2. æµ‹è¯•ç™»å½•

1. é€€å‡ºç™»å½•
2. ä½¿ç”¨åˆšæ‰æ³¨å†Œçš„è´¦å·ç™»å½•ï¼š
   - ç”¨æˆ·åï¼š`test123`
   - å¯†ç ï¼š`test123`
3. åº”è¯¥æˆåŠŸç™»å½•

### 3. æµ‹è¯•é”™è¯¯å¯†ç 

1. é€€å‡ºç™»å½•
2. å°è¯•ç™»å½•ï¼š
   - ç”¨æˆ·åï¼š`test123`
   - å¯†ç ï¼š`wrong_password`
3. åº”è¯¥æç¤º"å¯†ç é”™è¯¯"

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

- [x] å®‰è£… bcryptjs
- [x] å®‰è£… @types/bcryptjs
- [x] å¯¼å…¥ bcrypt
- [x] ä¿®æ”¹ register() åŠ å¯†å¯†ç 
- [x] ä¿®æ”¹ login() éªŒè¯å¯†ç 
- [x] æµ‹è¯•æ³¨å†Œï¼ˆæ–°ç”¨æˆ·ï¼‰
- [ ] æµ‹è¯•ç™»å½•ï¼ˆæˆåŠŸï¼‰
- [ ] æµ‹è¯•ç™»å½•ï¼ˆé”™è¯¯å¯†ç ï¼‰
- [ ] å¤„ç†ç°æœ‰ç”¨æˆ·ï¼ˆå¦‚æœæœ‰ï¼‰
- [ ] éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

---

## ğŸŠ å®ŒæˆçŠ¶æ€

### âœ… ä»£ç å·²ä¿®æ”¹
- `src/stores/auth.ts` - å·²æ·»åŠ å¯†ç åŠ å¯†

### âœ… ä¾èµ–å·²å®‰è£…
- `bcryptjs` - å¯†ç åŠ å¯†åº“
- `@types/bcryptjs` - TypeScript ç±»å‹å®šä¹‰

### â³ å¾…æµ‹è¯•
- æ³¨å†Œæ–°ç”¨æˆ·
- ç™»å½•éªŒè¯
- é”™è¯¯å¯†ç å¤„ç†

### â³ å¾…å¤„ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
- è¿ç§»ç°æœ‰ç”¨æˆ·å¯†ç 
- æˆ–æ¸…ç©ºæ•°æ®åº“é‡æ–°å¼€å§‹

---

## ğŸš€ ä¸‹ä¸€æ­¥

### é€‰é¡¹Aï¼šç«‹å³æµ‹è¯•ï¼ˆæ¨èï¼‰
1. `npm run dev` å¯åŠ¨å¼€å‘æœåŠ¡å™¨
2. æ³¨å†Œæ–°ç”¨æˆ·æµ‹è¯•
3. ç™»å½•æµ‹è¯•
4. æ£€æŸ¥æ•°æ®åº“ä¸­çš„å¯†ç 

### é€‰é¡¹Bï¼šæ¸…ç©ºæ•°æ®åº“åæµ‹è¯•
1. åœ¨ Supabase ä¸­åˆ é™¤æ‰€æœ‰ç”¨æˆ·
2. é‡æ–°æ³¨å†Œï¼ˆå¯†ç è‡ªåŠ¨åŠ å¯†ï¼‰
3. æµ‹è¯•ç™»å½•

### é€‰é¡¹Cï¼šéƒ¨ç½²åˆ°ç”Ÿäº§
1. ç¡®ä¿æµ‹è¯•é€šè¿‡
2. `npm run build`
3. éƒ¨ç½²åˆ° Vercel
4. åœ¨ç”Ÿäº§ç¯å¢ƒæµ‹è¯•

---

## ğŸ“ å¦‚æœé‡åˆ°é—®é¢˜

### é—®é¢˜1ï¼šå¯¼å…¥ bcrypt å¤±è´¥
```typescript
// å¦‚æœæç¤ºæ‰¾ä¸åˆ°æ¨¡å—ï¼Œå°è¯•ï¼š
import * as bcrypt from 'bcryptjs'
```

### é—®é¢˜2ï¼šTypeScript ç±»å‹é”™è¯¯
```bash
# é‡æ–°å®‰è£…ç±»å‹å®šä¹‰
npm install -D @types/bcryptjs --force
```

### é—®é¢˜3ï¼šç°æœ‰ç”¨æˆ·æ— æ³•ç™»å½•
- åŸå› ï¼šæ•°æ®åº“ä¸­æ˜¯æ˜æ–‡å¯†ç ï¼Œä»£ç ä½¿ç”¨åŠ å¯†éªŒè¯
- è§£å†³ï¼šæ¸…ç©ºç”¨æˆ·è¡¨æˆ–è¿è¡Œè¿ç§»è„šæœ¬

---

**ğŸ‰ æ­å–œï¼å¯†ç åŠ å¯†å·²å®Œæˆï¼ç³»ç»Ÿç°åœ¨æ›´åŠ å®‰å…¨äº†ï¼** ğŸ”’

---

**åˆ›å»ºæ—¶é—´ï¼š** 2025-10-18  
**çŠ¶æ€ï¼š** âœ… ä»£ç å·²å®Œæˆï¼Œå¾…æµ‹è¯•  
**å®‰å…¨ç­‰çº§ï¼š** ğŸ”’ğŸ”’ğŸ”’ğŸ”’ğŸ”’ ï¼ˆ5/5 æ˜Ÿï¼‰

