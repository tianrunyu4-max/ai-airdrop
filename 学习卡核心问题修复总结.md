# ğŸ¯ å­¦ä¹ å¡"ç”¨æˆ·ä¸å­˜åœ¨"é—®é¢˜å½»åº•ä¿®å¤

## âŒ é—®é¢˜æ ¹æº

**æ•°æ®å­˜å‚¨ä¸ä¸€è‡´å¯¼è‡´çš„æŸ¥æ‰¾å¤±è´¥ï¼š**

```javascript
// âŒ æ—§ä»£ç ï¼ˆé”™è¯¯ï¼‰
const registeredUsers = JSON.parse(localStorage.getItem('registered_users') || '{}')
const userKey = Object.keys(registeredUsers).find(key => 
  registeredUsers[key].userData.id === userId
)
if (!userKey) {
  return { success: false, error: 'ç”¨æˆ·ä¸å­˜åœ¨' } // â† ä¸€ç›´æŠ¥é”™
}
```

**åŸå› ï¼š**
1. **ç™»å½•ç³»ç»Ÿ**ä½¿ç”¨ `localStorage.user_session` å­˜å‚¨ç”¨æˆ·æ•°æ®
2. **å­¦ä¹ å¡ç³»ç»Ÿ**å´ä» `localStorage.registered_users` æŸ¥æ‰¾ç”¨æˆ·
3. `registered_users` æ˜¯**æ—§æ•°æ®ç»“æ„**ï¼Œæ—©å·²åºŸå¼ƒ
4. ä¸¤ä¸ªå­˜å‚¨ä½ç½®ä¸åŒæ­¥ â†’ **æ°¸è¿œæ‰¾ä¸åˆ°ç”¨æˆ·ï¼**

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. **ç»Ÿä¸€ä½¿ç”¨ `user_session` ä½œä¸ºå”¯ä¸€æ•°æ®æº**

```javascript
// âœ… æ–°ä»£ç ï¼ˆæ­£ç¡®ï¼‰
const userSession = localStorage.getItem('user_session')
if (!userSession) {
  return { success: false, error: 'è¯·å…ˆç™»å½•' }
}

let user
try {
  user = JSON.parse(userSession)
  if (user.id !== userId) {
    return { success: false, error: 'ç”¨æˆ·IDä¸åŒ¹é…' }
  }
} catch (e) {
  return { success: false, error: 'ç”¨æˆ·æ•°æ®å¼‚å¸¸' }
}
```

### 2. **ä½™é¢æ›´æ–°ç»Ÿä¸€åŒæ­¥åˆ° Supabase å’Œ localStorage**

```javascript
// âœ… å…‘æ¢å­¦ä¹ å¡ï¼šæ‰£é™¤ä½™é¢
const newBalance = Number((currentBalance - totalCost).toFixed(2))

// 1. æ›´æ–° Supabaseï¼ˆæ•°æ®åº“ï¼‰
await supabase
  .from('users')
  .update({ u_balance: newBalance })
  .eq('id', userId)

// 2. æ›´æ–° localStorageï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰
user.u_balance = newBalance
localStorage.setItem('user_session', JSON.stringify(user))

// 3. è§¦å‘å‰ç«¯åˆ·æ–°
await authStore.loadUser() // ä» Supabase é‡æ–°åŠ è½½
```

### 3. **ç­¾åˆ°é‡Šæ”¾ä¹Ÿä½¿ç”¨ç›¸åŒé€»è¾‘**

```javascript
// âœ… ç­¾åˆ°é‡Šæ”¾ï¼šå¢åŠ ä½™é¢
const newUBalance = Number((currentUBalance + uAmount).toFixed(2))

// 1. æ›´æ–° Supabase
await supabase
  .from('users')
  .update({ u_balance: newUBalance })
  .eq('id', userId)

// 2. æ›´æ–° localStorage
user.u_balance = newUBalance
localStorage.setItem('user_session', JSON.stringify(user))
```

---

## ğŸ”„ æ•°æ®æµï¼ˆä¿®å¤åï¼‰

```
ç”¨æˆ·ç™»å½•
  â†“
å­˜å‚¨åˆ° localStorage.user_session
å­˜å‚¨åˆ° Supabase.users
  â†“
å…‘æ¢å­¦ä¹ å¡ / ç­¾åˆ°é‡Šæ”¾
  â†“
1ï¸âƒ£ ä» user_session è¯»å–ç”¨æˆ·æ•°æ® âœ…
2ï¸âƒ£ æ›´æ–° Supabase ä½™é¢ âœ…
3ï¸âƒ£ æ›´æ–° user_session ä½™é¢ âœ…
4ï¸âƒ£ å‰ç«¯è°ƒç”¨ authStore.loadUser() åˆ·æ–°æ˜¾ç¤º âœ…
  â†“
âœ… æ•°æ®å®Œå…¨åŒæ­¥ï¼
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

### `src/services/MiningService.ts`

**ä¿®æ”¹ç‚¹ 1ï¼šå…‘æ¢å­¦ä¹ å¡æ—¶æŸ¥æ‰¾ç”¨æˆ·**
- ä» `registered_users` æ”¹ä¸º `user_session`

**ä¿®æ”¹ç‚¹ 2ï¼šå…‘æ¢å­¦ä¹ å¡æ—¶æ›´æ–°ä½™é¢**
- åŒæ—¶æ›´æ–° Supabase å’Œ `user_session`

**ä¿®æ”¹ç‚¹ 3ï¼šç­¾åˆ°é‡Šæ”¾æ—¶æŸ¥æ‰¾ç”¨æˆ·**
- ä» `registered_users` æ”¹ä¸º `user_session`

**ä¿®æ”¹ç‚¹ 4ï¼šç­¾åˆ°é‡Šæ”¾æ—¶æ›´æ–°ä½™é¢**
- åŒæ—¶æ›´æ–° Supabase å’Œ `user_session`

---

## âœ… æµ‹è¯•éªŒè¯

### å…‘æ¢å­¦ä¹ å¡æµç¨‹ï¼š
1. âœ… ç™»å½•è´¦å·
2. âœ… è¿›å…¥å­¦ä¹ å¡é¡µé¢
3. âœ… ç‚¹å‡»"å…‘æ¢1å¼ å­¦ä¹ å¡"ï¼ˆ8Uï¼‰
4. âœ… **ä¸å†æç¤º"ç”¨æˆ·ä¸å­˜åœ¨"**
5. âœ… ä½™é¢æ­£ç¡®æ‰£é™¤
6. âœ… å­¦ä¹ å¡æ­£ç¡®ç”Ÿæˆ
7. âœ… åˆ·æ–°é¡µé¢æ•°æ®ä¾ç„¶æ­£ç¡®

### ç­¾åˆ°é‡Šæ”¾æµç¨‹ï¼š
1. âœ… ç¬¬äºŒå¤©ç­¾åˆ°
2. âœ… ç§¯åˆ†æ­£ç¡®é‡Šæ”¾åˆ°Uä½™é¢
3. âœ… ä½™é¢æ­£ç¡®å¢åŠ 
4. âœ… åˆ·æ–°é¡µé¢æ•°æ®ä¾ç„¶æ­£ç¡®

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

**"å•ä¸€æ•°æ®æº"åŸåˆ™ï¼š**
- âœ… ç™»å½•åçš„ç”¨æˆ·æ•°æ® â†’ `localStorage.user_session`
- âœ… ä½™é¢æ›´æ–° â†’ åŒæ—¶å†™å…¥ Supabase + `user_session`
- âœ… å‰ç«¯æ˜¾ç¤º â†’ ä» `authStore.user`ï¼ˆæ¥è‡ª Supabaseï¼‰
- âŒ **ä¸å†ä½¿ç”¨** `registered_users`ï¼ˆå·²åºŸå¼ƒï¼‰

**æ•°æ®åŒæ­¥æœºåˆ¶ï¼š**
```javascript
// æ¯æ¬¡ä½™é¢å˜åŠ¨ï¼š
1. è®¡ç®—æ–°ä½™é¢
2. æ›´æ–° Supabaseï¼ˆæŒä¹…åŒ–ï¼‰
3. æ›´æ–° user_sessionï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰
4. è°ƒç”¨ authStore.loadUser()ï¼ˆåˆ·æ–°æ˜¾ç¤ºï¼‰
```

---

## ğŸš€ éƒ¨ç½²çŠ¶æ€

- âœ… ä»£ç å·²æ¨é€åˆ° GitHub
- âœ… Netlify è‡ªåŠ¨éƒ¨ç½²ä¸­ï¼ˆçº¦2-3åˆ†é’Ÿï¼‰
- âœ… éƒ¨ç½²åœ°å€ï¼šhttps://ai-airdrop-smart.netlify.app

---

## ğŸ“Œ åç»­æ³¨æ„äº‹é¡¹

1. **ä¸è¦å†æ··ç”¨æ•°æ®æº**
   - ç»Ÿä¸€ä½¿ç”¨ `user_session` æŸ¥æ‰¾ç”¨æˆ·
   - ç»Ÿä¸€ä½¿ç”¨ Supabase ä½œä¸ºä¸»æ•°æ®åº“

2. **ä½™é¢æ›´æ–°å¿…é¡»åŒæ­¥**
   - æ¯æ¬¡ä½™é¢å˜åŠ¨å¿…é¡»åŒæ—¶æ›´æ–° Supabase å’Œ localStorage
   - å‰ç«¯åˆ·æ–°å¿…é¡»è°ƒç”¨ `authStore.loadUser()`

3. **å½»åº•åºŸå¼ƒ `registered_users`**
   - æ‰€æœ‰æ—§ä»£ç ä¸å†ä½¿ç”¨è¿™ä¸ªå­—æ®µ
   - æœªæ¥å¯ä»¥æ¸…ç†åˆ é™¤

---

**ä¿®å¤æ—¶é—´ï¼š** 2025-10-22  
**é—®é¢˜çº§åˆ«ï¼š** ğŸ”´ ä¸¥é‡ï¼ˆæ ¸å¿ƒåŠŸèƒ½æ— æ³•ä½¿ç”¨ï¼‰  
**ä¿®å¤çŠ¶æ€ï¼š** âœ… å·²å½»åº•è§£å†³  

