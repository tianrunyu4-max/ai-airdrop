# V5.2 对碰奖和复投升级说明

更新时间：2025-10-25

---

## 🎯 **核心变更**

### 1️⃣ **对碰奖80%封顶**

**修改前**：
```
5组对碰 = 5组 × 6U = 30U（100%到账）
```

**修改后**：
```
5组对碰 = 5组 × 6U × 80% = 24U（80%封顶）
剩余20% = 6U（预留/销毁）
```

#### 📌 **配置变更**（`src/config/binary.ts`）

```typescript
PAIRING: {
  BONUS_PER_PAIR: 6,             // 每单对碰奖励6U
  MEMBER_RATIO: 0.8,             // 80%封顶 ← 修改
  MEMBER_AMOUNT: 4.8,            // 实际获得4.8U ← 修改
  RESERVED_RATIO: 0.2,           // 20%预留 ← 修改
}
```

---

### 2️⃣ **复投计算包含所有收益**

**总收益来源**：
1. ✅ **对碰奖**（80%封顶）
2. ✅ **见单奖**（1U/代，5代）
3. ✅ **学习卡收益**（85%转U部分）
4. ✅ **其他收益**（分红等）

**复投触发条件**：
```
总收益（total_earnings）>= 240U × (复投次数 + 1)
```

#### 📊 **复投示例**

| 复投次数 | 触发阈值 | 复投金额 |
|---------|---------|---------|
| 第1次 | 240U | 30U |
| 第2次 | 480U | 30U |
| 第3次 | 720U | 30U |
| ... | ... | ... |

---

### 3️⃣ **实际案例对比**

#### **案例1：5组对碰（2:1）**

**修改前**：
```
对碰奖：5组 × 6U = 30U
实际到账：30U ✅
```

**修改后**：
```
对碰奖：5组 × 6U × 80% = 24U
实际到账：24U ✅
预留部分：6U（20%）
```

#### **案例2：复投计算**

**场景**：用户A的总收益构成
```
├─ 对碰奖：150U（80%封顶）
├─ 见单奖：50U
└─ 学习卡收益：60U
───────────────────────
总收益：260U ≥ 240U
```

**结果**：
- ✅ 触发第1次复投（需支付30U）
- ✅ 订单数量+1
- ✅ 复购单自动补弱区

---

## 📝 **数据库字段说明**

### `binary_members` 表

| 字段 | 说明 | 包含内容 |
|------|------|---------|
| `total_pairing_bonus` | 对碰奖累计 | 80%封顶部分 |
| `total_order_bonus` | 见单奖累计 | 1U/代 × 5代 |
| `total_earnings` | 总收益 | 对碰+见单+学习卡+其他 |
| `reinvest_count` | 复投次数 | 每240U复投一次 |

---

## 🔧 **技术实现**

### **对碰奖发放**（`BinaryService.calculatePairing()`）

```typescript
// 计算对碰奖（80%封顶）
const actualPairingBonus = actualPairsToSettle × 6U × 0.8

// 发放奖励
await WalletManager.add(
  userId,
  actualPairingBonus,
  'pairing_bonus',
  `对碰奖：${actualPairsToSettle}组 × 6U × 80% = ${actualPairingBonus}U`
)

// 预留部分（20%）
const reservedAmount = actualPairsToSettle × 6U × 0.2
// 预留部分暂不发放，用于系统运营或销毁
```

### **复投检查**（`BinaryService.checkReinvestRequired()`）

```typescript
// 获取用户总收益（包含所有来源）
const { data: member } = await supabase
  .from('binary_members')
  .select('total_earnings, reinvest_count')
  .eq('user_id', userId)
  .single()

// 计算复投阈值
const threshold = 240 × (member.reinvest_count + 1)

// 判断是否需要复投
if (member.total_earnings >= threshold) {
  // 触发自动复投
  await autoReinvest(userId)
}
```

---

## 📊 **收益计算公式**

### **对碰奖**
```
对碰奖 = 对碰组数 × 6U × 80%
```

### **见单奖**
```
见单奖 = 对碰组数 × 1U × 5代
```

### **总收益**
```
总收益 = 对碰奖（80%） + 见单奖 + 学习卡收益 + 其他
```

### **复投触发**
```
IF (总收益 >= 240U × (复投次数 + 1)) THEN
  需复投30U
END IF
```

---

## ⚠️ **注意事项**

1. **对碰奖封顶**：从100%改为80%，每组实际到账4.8U
2. **预留部分**：20%预留部分暂不发放
3. **复投计算**：包含所有收益来源，不仅仅是对碰奖
4. **自动复投**：每240U自动触发，订单数+1
5. **学习卡收益**：85%转U部分也计入总收益

---

## 🚀 **升级影响**

### ✅ **优势**
- 对碰奖封顶，系统更可持续
- 复投计算更合理，包含所有收益
- 激励用户多元化收益（对碰+见单+学习卡）

### ⚠️ **调整**
- 对碰奖从100%降至80%
- 用户需适应新的收益比例

---

**升级完成后，系统将更加稳健和可持续！** 🎉

