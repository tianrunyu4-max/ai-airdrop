# 🚀 一键修复指南：充值审核 + 消息清理

## ⚠️ 当前问题

根据控制台错误：
1. ❌ **充值审核页面 404** - `recharge_records` 表不存在
2. ❌ **聊天消息不自动删除** - 消息清理逻辑未配置
3. ❌ **多个数据库查询错误** - RLS策略、字段缺失

---

## ✅ 一键修复方案（只需3步）

### 第 1 步：执行SQL（⏱️ 1分钟）

**操作步骤**：
1. 打开 Supabase Dashboard
2. 进入 **SQL Editor**
3. 复制文件 `一键修复-充值和消息.sql` 的全部内容
4. 粘贴并点击 **RUN**

**执行内容**：
```sql
✅ 创建 recharge_records 表（充值记录）
✅ 配置 RLS 策略（权限控制）
✅ 添加 is_bot 字段到 messages 表
✅ 创建 valid_messages 视图（自动过滤过期消息）
✅ 创建 cleanup_expired_messages() 函数
✅ 立即清理一次过期消息
✅ 添加充值配置到 system_config
```

**验证成功**：
```sql
-- 如果看到这些输出说明成功
✅ recharge_records 表已创建
✅ valid_messages 视图已创建
✅ cleanup_expired_messages() 函数已创建
✅ 消息清理完成
```

---

### 第 2 步：刷新页面（⏱️ 10秒）

**操作步骤**：
1. 回到浏览器
2. 按 `Ctrl + Shift + R`（强制刷新）
3. 清空控制台
4. 再次访问 `/admin/recharges`

**预期结果**：
```
✅ 充值审核页面正常显示
✅ 统计数据正常加载（待审核：0）
✅ 控制台无错误
```

---

### 第 3 步：测试功能（⏱️ 2分钟）

#### 测试 1：充值功能
1. 退出管理员账号
2. 用普通用户登录
3. 进入"个人中心"
4. 点击"充值"按钮
5. 填写金额、交易哈希
6. 提交

**预期**：
```
✅ 提交成功
✅ 显示"充值申请已提交"
```

#### 测试 2：管理员审核
1. 切回管理员账号
2. 进入 `/admin/recharges`
3. 看到刚才的充值申请
4. 点击"确认"
5. 填写备注并确认

**预期**：
```
✅ 确认成功
✅ 用户余额自动增加
✅ 状态变为"已确认"
```

#### 测试 3：消息清理
1. 进入聊天页面
2. 发送一条消息
3. 等待 5 分钟
4. 刷新页面

**预期**：
```
✅ 5分钟后消息自动消失
✅ 机器人消息按群组类型保留不同时间
   - 自动赚钱群：10分钟
   - AI科技群：24小时
```

---

## 📊 数据库结构说明

### 1. recharge_records 表
```sql
字段说明：
- id: UUID 主键
- user_id: 用户ID（外键）
- amount: 充值金额
- currency: 币种（默认USDT）
- network: 网络（TRC20/ERC20）
- txid: 交易哈希
- status: 状态（pending/confirmed/rejected）
- proof_image: 充值凭证图片
- admin_note: 管理员备注
- created_at: 创建时间
- confirmed_at: 确认时间
- confirmed_by: 确认人ID
```

### 2. valid_messages 视图
```sql
作用：自动过滤过期消息

规则：
- 用户消息：5分钟后不显示
- 自动赚钱群机器人：10分钟后不显示
- AI科技群机器人：24小时后不显示

用法：
SELECT * FROM valid_messages 
WHERE chat_group_id = 'xxx' 
ORDER BY created_at DESC;
```

### 3. cleanup_expired_messages() 函数
```sql
作用：手动清理过期消息

用法：
SELECT cleanup_expired_messages();

建议：
- 每天执行一次
- 或在管理后台添加"立即清理"按钮
```

---

## 🔧 前端代码（无需修改）

### ✅ 路由配置正确
```typescript
// src/router/index.ts
{
  path: 'recharges',
  name: 'admin-recharges',
  component: () => import('@/views/admin/RechargesView.vue')
}
```

### ✅ 服务层正确
```typescript
// src/services/RechargeService.ts
- getAllRecharges()  // 获取所有充值记录
- confirmRecharge()  // 确认充值
- rejectRecharge()   // 拒绝充值
```

### ✅ 组件正确
```typescript
// src/views/admin/RechargesView.vue
- 统计卡片显示
- 筛选功能
- 确认/拒绝操作
```

---

## 🎯 常见问题

### Q1: 执行SQL后还是404？
**A**: 检查RLS策略
```sql
-- 验证管理员策略
SELECT * FROM pg_policies 
WHERE tablename = 'recharge_records';

-- 应该看到4条策略
✅ 用户查看自己的充值记录
✅ 用户创建充值记录
✅ 管理员查看所有充值记录
✅ 管理员确认充值
```

### Q2: 消息还是不自动删除？
**A**: 手动执行清理
```sql
-- 立即清理过期消息
SELECT cleanup_expired_messages();

-- 查看清理后的消息
SELECT 
  cg.description,
  COUNT(*) as count,
  MAX(m.created_at) as latest
FROM messages m
JOIN chat_groups cg ON m.chat_group_id = cg.id
GROUP BY cg.description;
```

### Q3: 确认充值后余额没增加？
**A**: 检查 update_user_balance 函数
```sql
-- 验证函数存在
SELECT proname FROM pg_proc WHERE proname = 'update_user_balance';

-- 如果不存在，执行创建函数的SQL
```

---

## 📝 执行检查清单

- [ ] Step 1: 执行 `一键修复-充值和消息.sql`
- [ ] Step 2: 验证表创建成功
  ```sql
  SELECT table_name FROM information_schema.tables 
  WHERE table_name IN ('recharge_records');
  ```
- [ ] Step 3: 验证视图创建成功
  ```sql
  SELECT table_name FROM information_schema.views 
  WHERE table_name = 'valid_messages';
  ```
- [ ] Step 4: 验证函数创建成功
  ```sql
  SELECT proname FROM pg_proc 
  WHERE proname = 'cleanup_expired_messages';
  ```
- [ ] Step 5: 刷新浏览器
- [ ] Step 6: 测试充值功能
- [ ] Step 7: 测试消息清理
- [ ] Step 8: 验证控制台无错误

---

## ✅ 预期结果

### 充值功能
```
✅ /admin/recharges 页面正常显示
✅ 统计数据正确（待审核/已确认/已拒绝）
✅ 可以正常确认/拒绝充值
✅ 确认后用户余额自动增加
✅ 控制台无错误
```

### 消息清理
```
✅ 用户消息 5分钟后自动消失
✅ 自动赚钱群机器人消息 10分钟后消失
✅ AI科技群机器人消息 24小时后消失
✅ 管理员可以手动清理
✅ 控制台无错误
```

---

## 🚀 立即执行

**只需复制粘贴，1分钟搞定！**

1. 打开 Supabase SQL Editor
2. 复制 `一键修复-充值和消息.sql`
3. 点击 RUN
4. 刷新浏览器
5. 测试功能

**所有问题一次解决，前后端完全对齐！** ✅

