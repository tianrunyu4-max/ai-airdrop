<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”§ ä¿®å¤ç­¾åˆ°è®°å½•</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 15px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    .btn-secondary:hover {
      background: #e0e0e0;
    }
    .log {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    .log-item {
      margin-bottom: 5px;
      padding: 5px;
      border-radius: 5px;
    }
    .log-success {
      color: #28a745;
      background: #d4edda;
    }
    .log-error {
      color: #dc3545;
      background: #f8d7da;
    }
    .log-info {
      color: #007bff;
      background: #d1ecf1;
    }
    .log-warning {
      color: #ffc107;
      background: #fff3cd;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      border-radius: 10px;
      color: white;
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ ç­¾åˆ°è®°å½•ä¿®å¤å·¥å…·</h1>
    <p class="subtitle">æ£€æµ‹å¹¶ä¿®å¤ä¸¢å¤±çš„ç­¾åˆ°è®°å½•</p>
    
    <button class="btn btn-primary" onclick="diagnose()">
      ğŸ” å¼€å§‹è¯Šæ–­
    </button>
    
    <button class="btn btn-secondary" onclick="createRepairRecord()">
      âœ¨ åˆ›å»ºè¡¥æ•‘è®°å½•
    </button>
    
    <div class="stats" id="stats" style="display: none;">
      <div class="stat-card">
        <div class="stat-value" id="totalRecords">0</div>
        <div class="stat-label">æ€»è®°å½•æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="checkinRecords">0</div>
        <div class="stat-label">ç­¾åˆ°è®°å½•</div>
      </div>
    </div>
    
    <div class="log" id="log"></div>
  </div>

  <script>
    function addLog(message, type = 'info') {
      const log = document.getElementById('log')
      const item = document.createElement('div')
      item.className = `log-item log-${type}`
      item.textContent = message
      log.appendChild(item)
      log.scrollTop = log.scrollHeight
    }

    function clearLog() {
      document.getElementById('log').innerHTML = ''
    }

    function updateStats(total, checkin) {
      document.getElementById('stats').style.display = 'grid'
      document.getElementById('totalRecords').textContent = total
      document.getElementById('checkinRecords').textContent = checkin
    }

    function diagnose() {
      clearLog()
      addLog('=== ğŸ” å¼€å§‹è¯Šæ–­ ===', 'info')
      
      try {
        // æ£€æŸ¥localStorageæ˜¯å¦å¯ç”¨
        if (typeof localStorage === 'undefined') {
          addLog('âŒ localStorageä¸å¯ç”¨', 'error')
          return
        }
        
        // è·å–ç”¨æˆ·ä¿¡æ¯
        const userSession = localStorage.getItem('user_session')
        if (!userSession) {
          addLog('âŒ æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•ç½‘ç«™', 'error')
          addLog('ğŸ’¡ æ‰“å¼€ https://www.ai-airdrop.top ç™»å½•åå†è¯•', 'info')
          return
        }
        
        const user = JSON.parse(userSession)
        const userId = user.id
        
        addLog(`âœ… ç”¨æˆ·ID: ${userId}`, 'success')
        addLog(`ğŸ’° å½“å‰Uä½™é¢: ${user.u_balance}U`, 'success')
        
        // æ£€æŸ¥äº¤æ˜“è®°å½•
        const transactions = JSON.parse(localStorage.getItem('user_transactions') || '[]')
        addLog(`ğŸ“Š æ€»äº¤æ˜“è®°å½•: ${transactions.length}æ¡`, 'info')
        
        const myTransactions = transactions.filter(tx => tx.user_id === userId)
        addLog(`ğŸ“ æˆ‘çš„äº¤æ˜“è®°å½•: ${myTransactions.length}æ¡`, 'info')
        
        const checkinRecords = myTransactions.filter(tx => tx.type === 'checkin_release')
        addLog(`ğŸ“… ç­¾åˆ°é‡Šæ”¾è®°å½•: ${checkinRecords.length}æ¡`, 'info')
        
        updateStats(myTransactions.length, checkinRecords.length)
        
        // æ£€æŸ¥å­¦ä¹ å¡
        const cards = JSON.parse(localStorage.getItem('user_learning_cards') || '[]')
        const myCards = cards.filter(c => c.user_id === userId)
        addLog(`ğŸ’³ æˆ‘çš„å­¦ä¹ å¡: ${myCards.length}å¼ `, 'info')
        
        // æ£€æŸ¥ä»Šå¤©çš„ç­¾åˆ°
        const today = new Date().toISOString().split('T')[0]
        const todayCheckins = checkinRecords.filter(r => r.created_at?.startsWith(today))
        
        if (todayCheckins.length === 0) {
          addLog('âš ï¸ ä»Šå¤©è¿˜æ²¡æœ‰ç­¾åˆ°è®°å½•', 'warning')
          addLog('ğŸ’¡ ç‚¹å‡»"åˆ›å»ºè¡¥æ•‘è®°å½•"æŒ‰é’®ä¿®å¤', 'info')
        } else {
          addLog(`âœ… ä»Šå¤©å·²æœ‰${todayCheckins.length}æ¡ç­¾åˆ°è®°å½•`, 'success')
        }
        
        // æ£€æŸ¥å­¦ä¹ å¡ç­¾åˆ°çŠ¶æ€
        myCards.forEach((card, idx) => {
          const lastCheckin = card.last_checkin_date
          const isToday = lastCheckin?.startsWith(today)
          if (isToday) {
            addLog(`âœ… å­¦ä¹ å¡${idx + 1}: ä»Šå¤©å·²ç­¾åˆ°`, 'success')
          } else {
            addLog(`âš ï¸ å­¦ä¹ å¡${idx + 1}: ${lastCheckin ? 'æœªç­¾åˆ°' : 'ä»æœªç­¾åˆ°'}`, 'warning')
          }
        })
        
        addLog('=== è¯Šæ–­å®Œæˆ ===', 'info')
        
      } catch (error) {
        addLog(`âŒ è¯Šæ–­å¤±è´¥: ${error.message}`, 'error')
        console.error(error)
      }
    }

    function createRepairRecord() {
      clearLog()
      addLog('=== âœ¨ åˆ›å»ºè¡¥æ•‘è®°å½• ===', 'info')
      
      try {
        // è·å–ç”¨æˆ·ä¿¡æ¯
        const userSession = localStorage.getItem('user_session')
        if (!userSession) {
          addLog('âŒ æœªæ‰¾åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·å…ˆç™»å½•ç½‘ç«™', 'error')
          return
        }
        
        const user = JSON.parse(userSession)
        const userId = user.id
        
        // è·å–å­¦ä¹ å¡ä¿¡æ¯
        const cards = JSON.parse(localStorage.getItem('user_learning_cards') || '[]')
        const myCards = cards.filter(c => c.user_id === userId)
        
        if (myCards.length === 0) {
          addLog('âŒ æ‚¨è¿˜æ²¡æœ‰å­¦ä¹ å¡ï¼Œæ— æ³•åˆ›å»ºç­¾åˆ°è®°å½•', 'error')
          addLog('ğŸ’¡ è¯·å…ˆå…‘æ¢å­¦ä¹ å¡', 'info')
          return
        }
        
        // è·å–äº¤æ˜“è®°å½•
        const transactions = JSON.parse(localStorage.getItem('user_transactions') || '[]')
        
        // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æœ‰è®°å½•
        const today = new Date().toISOString().split('T')[0]
        const todayCheckins = transactions.filter(tx => 
          tx.user_id === userId && 
          tx.type === 'checkin_release' && 
          tx.created_at?.startsWith(today)
        )
        
        if (todayCheckins.length > 0) {
          addLog('â„¹ï¸ ä»Šå¤©å·²æœ‰ç­¾åˆ°è®°å½•', 'info')
          addLog(`ğŸ“… å…±${todayCheckins.length}æ¡è®°å½•`, 'info')
          
          const confirm = window.confirm('ä»Šå¤©å·²æœ‰ç­¾åˆ°è®°å½•ï¼Œæ˜¯å¦ä»ç„¶åˆ›å»ºè¡¥æ•‘è®°å½•ï¼Ÿ')
          if (!confirm) {
            addLog('âŒ æ“ä½œå·²å–æ¶ˆ', 'warning')
            return
          }
        }
        
        // è®¡ç®—ç­¾åˆ°æ”¶ç›Š
        const activeCards = myCards.filter(c => {
          const released = c.released_points || 0
          const total = c.total_points || 300
          return released < total
        })
        
        const cardsCount = activeCards.length
        const releaseRate = 0.05 // å‡è®¾5%é‡Šæ”¾ç‡
        const totalReleased = cardsCount * 5 * releaseRate // æ¯å¼ å¡5ç§¯åˆ†
        const toU = totalReleased * 0.8 // 80%è½¬U
        const toBurn = totalReleased * 0.2 // 20%é”€æ¯
        
        // åˆ›å»ºè¡¥æ•‘è®°å½•
        const newRecord = {
          id: `tx-${Date.now()}-checkin-è¡¥æ•‘`,
          user_id: userId,
          type: 'checkin_release',
          amount: parseFloat(toU.toFixed(2)),
          balance_after: user.u_balance,
          currency: 'U',
          description: `ç­¾åˆ°é‡Šæ”¾ï¼š${totalReleased.toFixed(2)}ç§¯åˆ† â†’ ${toU.toFixed(2)}Uï¼ˆé‡Šæ”¾ç‡${(releaseRate * 100).toFixed(1)}%ï¼‰+ ${toBurn.toFixed(2)}ç§¯åˆ†é”€æ¯`,
          metadata: {
            cards_count: cardsCount,
            total_released: totalReleased,
            to_u: toU,
            to_burn: toBurn,
            release_rate: releaseRate
          },
          created_at: new Date().toISOString()
        }
        
        transactions.push(newRecord)
        localStorage.setItem('user_transactions', JSON.stringify(transactions))
        
        addLog('âœ… è¡¥æ•‘è®°å½•åˆ›å»ºæˆåŠŸï¼', 'success')
        addLog(`ğŸ“ è®°å½•ID: ${newRecord.id}`, 'info')
        addLog(`ğŸ’° æ”¶ç›Š: +${toU.toFixed(2)}U`, 'success')
        addLog(`ğŸ’³ ç­¾åˆ°å­¦ä¹ å¡: ${cardsCount}å¼ `, 'info')
        addLog(`ğŸ“Š é‡Šæ”¾ç‡: ${(releaseRate * 100).toFixed(1)}%`, 'info')
        addLog('', 'info')
        addLog('ğŸ’¡ è¯·åˆ·æ–°æ”¶ç›Šè®°å½•é¡µé¢æŸ¥çœ‹', 'info')
        addLog('ğŸ”— https://www.ai-airdrop.top/earnings', 'info')
        
        // æ›´æ–°ç»Ÿè®¡
        const allMyTransactions = transactions.filter(tx => tx.user_id === userId)
        const allCheckinRecords = allMyTransactions.filter(tx => tx.type === 'checkin_release')
        updateStats(allMyTransactions.length, allCheckinRecords.length)
        
      } catch (error) {
        addLog(`âŒ åˆ›å»ºå¤±è´¥: ${error.message}`, 'error')
        console.error(error)
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¯Šæ–­
    window.addEventListener('load', () => {
      setTimeout(() => {
        addLog('ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ç­¾åˆ°è®°å½•ä¿®å¤å·¥å…·', 'info')
        addLog('ğŸ’¡ ç‚¹å‡»"å¼€å§‹è¯Šæ–­"æŒ‰é’®æ£€æŸ¥æ‚¨çš„ç­¾åˆ°è®°å½•', 'info')
      }, 100)
    })
  </script>
</body>
</html>

