# V5.2 完整升级说明

## 🎯 核心升级点

### 1️⃣ **对碰奖：80%封顶到账** ✅

```
对碰奖 = 对碰组数 × 6U × 80% = 对碰组数 × 4.8U

示例：
- 5组对碰 → 5 × 6U × 80% = 24U（实际到账）
- 10组对碰 → 10 × 6U × 80% = 48U（实际到账）

预留部分：
- 对碰组数 × 6U × 20% = 对碰组数 × 1.2U（系统预留）
```

---

### 2️⃣ **见单奖：按组数计算（1组1U）** ✅

```
见单奖 = 对碰组数 × 1U

条件：
✅ 上级直推≥2人
✅ 向上追溯5代直推链（串糖葫芦式）
✅ 每次对碰触发（重复拿！）

示例：
- 下级对碰1组 → 上级拿1U
- 下级对碰5组 → 上级拿5U
- 下级对碰10组 → 上级拿10U

（只有满足直推≥2人的上级才能拿）
```

---

### 3️⃣ **复投：总收益包含学习卡收益** ✅

```
total_earnings（复投计算依据）= 
  对碰奖 + 见单奖 + 平级奖 + 学习卡签到收益 ✅

规则：
✅ 学习卡每日签到释放的85%收益，计入total_earnings
✅ 每240U自动复投1单（原点复投）
✅ 复投不送学习卡（只增加订单数量）
✅ 复投单自动补弱区（滑落机制）
```

---

## 📊 完整案例演示

### **用户A的完整收益流程**

#### **初始状态**
```
├─ 已加入Binary系统（30U）
├─ 购买1张学习卡（8U = 100积分）
├─ 团队A区：10单，B区：5单
└─ 直推人数：3人（满足见单奖条件）
```

---

#### **对碰结算（本周期）**

```
对碰比例：2:1
对碰组数：5组（A区10单÷2 vs B区5单÷1）

【对碰奖】A自己获得：
5组 × 6U × 80% = 24U ✅

【剩余单量】
A区：10 - (5×2) = 0单
B区：5 - (5×1) = 0单（全部消耗）
```

---

#### **见单奖发放（A的下级B对碰时）**

```
假设：A的下级B对碰了3组

【见单奖】A获得：
3组 × 1U = 3U ✅

条件：A的直推≥2人（满足）
```

---

#### **学习卡签到释放**

```
【当前学习卡】
├─ 总积分：100积分
├─ 已释放：20积分
├─ 今日释放：100积分 × 2% = 2积分
└─ 释放进度：22%

【签到收益分配】
├─ 2积分 × 85% = 1.7积分 → 转U
│   └─ 1.7积分 × 0.08 = 0.136U ✅
├─ 2积分 × 15% = 0.3积分 → 销毁（防泡沫）
└─ 学习卡收益计入total_earnings ✅
```

---

#### **总收益计算（用于复投）**

```
total_earnings（累计）= 
  对碰奖：24U
+ 见单奖：3U
+ 学习卡：0.136U
+ 平级奖：0U
= 27.136U ✅

复投阈值：240U（第1次复投）
当前进度：27.136U / 240U = 11.3%
```

---

#### **自动复投触发（达到240U时）**

```
【复投条件】
total_earnings ≥ 240U → 触发自动复投

【复投操作】
✅ 订单数量+1（原点复投）
✅ 自动补弱区（滑落机制）
✅ 触发上级重新对碰
❌ 不赠送学习卡

【复投阈值递增】
第1次：240U
第2次：480U
第3次：720U
...
```

---

## 🔑 核心规则总结

| 项目 | 规则 | 说明 |
|------|------|------|
| **对碰奖** | 6U × 80% = 4.8U | 80%到账，20%预留 |
| **见单奖** | 1U/组（5代） | 按组数计算，直推≥2人 |
| **学习卡收益** | 计入复投 | 85%转U，15%销毁 |
| **复投阈值** | 240U（递增） | 所有收益累计 |
| **复投操作** | +1单，补弱区 | 不送学习卡 |

---

## 📈 收益分配流程图

```
┌─────────────────────────────────────┐
│         下级对碰5组                    │
└─────────────────────────────────────┘
               │
       ┌───────┴───────┐
       │               │
   对碰奖           见单奖
  5×6U×80%        5×1U×5代
  = 24U           = 25U（5人满足条件）
       │               │
       └───────┬───────┘
               │
        计入total_earnings
               │
        ┌──────┴──────┐
        │              │
    学习卡收益      总收益累计
    85%转U       ≥240U自动复投
        │              │
        └──────┬───────┘
               │
          +1单补弱区
         （触发上级对碰）
```

---

## 🚀 V5.2 vs V5.1 vs V5.0

| 对比项 | V5.0 | V5.1 | V5.2 |
|--------|------|------|------|
| 对碰奖 | 8U/组（85%=6.8U） | 6U/组（100%） | 6U/组（80%=4.8U）✅ |
| 见单奖 | ❌ | 固定1U/次 | 按组数（1U/组）✅ |
| 复投计算 | 只对碰奖 | 只对碰奖 | 所有收益✅ |
| 学习卡收益 | 不计入 | 不计入 | 计入复投✅ |
| 复投送卡 | ✅ 送卡 | ✅ 送卡 | ❌ 不送卡✅ |

---

## ✅ 代码修改清单

### 1. `src/config/binary.ts`
```typescript
PAIRING: {
  BONUS_PER_PAIR: 6,        // 每单6U
  MEMBER_RATIO: 0.8,        // 80%到账
  MEMBER_AMOUNT: 4.8,       // 会员实际获得4.8U
  RESERVED_RATIO: 0.2,      // 20%预留
  ...
}

SPOT_BONUS: {
  AMOUNT: 1,                // 每组1U ✅
  DEPTH: 5,                 // 5代直推链
  UNLOCK_CONDITION: 2,      // 直推≥2人
  ...
}
```

---

### 2. `src/services/BinaryService.ts`
```typescript
// ✅ 见单奖按组数计算
const orderBonus = ORDER_BONUS_PER_PAIR * pairsCount

// ✅ 复投计算使用total_earnings
if (member.total_earnings >= threshold) {
  // 自动复投（不送学习卡）
}
```

---

### 3. `src/services/MiningService.ts`
```typescript
// ✅ V5.2：同步更新 binary_members.total_earnings（用于复投计算）
const { error: binaryError } = await supabase
  .from('binary_members')
  .update({
    total_earnings: supabase.raw(`COALESCE(total_earnings, 0) + ${uAmount}`)
  })
  .eq('user_id', userId)
```

---

## 🎉 升级完成

**部署状态：**
- ✅ 代码已提交：`3ebcdfe`
- ✅ 自动部署中：等待2-3分钟
- ✅ Vercel域名：https://ai-airdrop.vercel.app
- ✅ 自定义域名：https://ai-airdrop.top

**验证方式：**
1. 对碰5组 → 检查到账 24U（4.8U×5）
2. 下级对碰 → 上级拿见单奖（1U×组数）
3. 学习卡签到 → total_earnings增加
4. 累计240U → 自动复投+1单

---

**升级时间：** 2025-10-25  
**版本号：** V5.2 完整版  
**状态：** ✅ 已完成并部署

