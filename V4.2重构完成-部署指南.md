# 🚀 V4.2 参数热更新重构 - 部署指南

## ✅ 完成的工作

### 1. 核心重构 ✅
- ✅ **BinaryService.ts**：添加 `getDynamicConfig()` 方法
- ✅ **动态参数读取**：所有核心方法支持从数据库读取参数
- ✅ **降级机制**：数据库不可用时自动降级到硬编码配置
- ✅ **参数缓存**：利用 SystemParamsService 的1分钟缓存

### 2. 更新的方法 ✅
- ✅ `calculatePairing()` - 对碰奖计算
- ✅ `triggerLevelBonus()` - 平级奖触发
- ✅ `checkReinvestRequired()` - 复投检查
- ✅ `getBinaryInfo()` - 二元信息获取

### 3. 支持的动态参数 ✅
| 参数名 | 数据库字段 | 默认值 | 用途 |
|-------|-----------|-------|------|
| 对碰奖金 | `pairing_bonus_per_pair` | 10U | 每对对碰奖励 |
| 平级奖金 | `level_bonus_per_person` | 2U | 每人平级奖励 |
| 平级奖层级 | `level_bonus_depth` | 3代 | 追溯层级 |
| 复投阈值 | `reinvest_threshold` | 200U | 复投触发金额 |
| 解锁直推数 | `min_direct_referrals` | 2人 | 解锁条件 |
| 分红条件 | `dividend_min_referrals` | 10人 | 分红资格 |
| 会员比例 | `member_ratio` | 85% | 会员获得比例 |
| 平台比例 | `platform_ratio` | 15% | 平台分红比例 |

### 4. 保留硬编码的参数 ⚠️
以下参数暂不支持动态修改（复杂配置）：
- 加入费用：30U
- 复投金额：30U
- 对碰规则：2:1/1:2
- 弱区补贴：启用
- 滑落机制：启用

---

## 📋 部署步骤

### 步骤1：执行数据库SQL（必须）🔴

#### 1.1 登录 Supabase Dashboard
打开：https://supabase.com/dashboard

#### 1.2 执行参数同步SQL
在 SQL Editor 中执行：

```sql
-- 文件：supabase/migration_sync_params_v4.1.sql

-- 更新Binary系统参数
UPDATE system_params SET param_value = 10 WHERE param_key = 'pairing_bonus_per_pair';
-- 对碰奖从7U提升到10U

UPDATE system_params SET param_value = 200 WHERE param_key = 'reinvest_threshold';
-- 复投阈值从300U降低到200U

UPDATE system_params SET param_value = 3 WHERE param_key = 'level_bonus_depth';
-- 平级奖层级从8代减少到3代

UPDATE system_params SET param_value = 2 WHERE param_key = 'level_bonus_per_person';
-- 平级奖金额确认为2U

-- 查看更新结果
SELECT param_key, param_value, param_unit, description
FROM system_params
WHERE category = 'binary'
ORDER BY param_key;
```

**预期结果**：
```
pairing_bonus_per_pair | 10 | U
reinvest_threshold | 200 | U
level_bonus_depth | 3 | 代
level_bonus_per_person | 2 | U
min_direct_referrals | 2 | 人
dividend_min_referrals | 10 | 人
member_ratio | 85 | %
platform_ratio | 15 | %
```

#### 1.3 执行平台联系方式SQL
在 SQL Editor 中执行：

```sql
-- 文件：supabase/migration_platform_contacts.sql

INSERT INTO system_config (key, value, description) VALUES
(
  'platform_contacts',
  '{
    "bilibili": "https://space.bilibili.com/你的B站ID",
    "youtube": "https://youtube.com/@你的频道",
    "telegram": "https://t.me/你的群组",
    "wechat": "AI_TECH_2025",
    "shipin": "搜索\"AI科技创新\"",
    "tiktok": "@aitech_official"
  }'::jsonb,
  '平台官方联系方式'
)
ON CONFLICT (key) DO UPDATE
SET value = EXCLUDED.value,
    updated_at = NOW();

-- 验证
SELECT key, value, description
FROM system_config
WHERE key = 'platform_contacts';
```

---

### 步骤2：构建前端（本地）✅

在项目根目录执行：

```bash
npm run build
```

**预期输出**：
- ✅ 构建成功
- ✅ 生成 `dist/` 目录
- ✅ 文件数量约 60+ 个

---

### 步骤3：部署到 Netlify（生产）✅

在项目根目录执行：

```bash
netlify deploy --prod
```

**预期输出**：
- ✅ 上传资源成功
- ✅ 部署完成
- ✅ 生产URL：https://eth10.netlify.app

---

### 步骤4：验证部署结果 🔍

#### 4.1 验证前端更新
1. 打开 https://eth10.netlify.app
2. 强制刷新（Ctrl+F5）
3. 登录管理后台
4. 进入"系统参数配置"页面
5. 确认看到黄色警告提示

#### 4.2 验证参数热更新
1. 在管理后台修改"对碰奖金"（如改为 11U）
2. 保存到数据库
3. 等待1分钟（缓存过期）
4. 触发一次对碰
5. 检查对碰奖励是否为 11U × 85% = 9.35U

#### 4.3 验证平台联系方式
1. 进入"我的"页面
2. 滑到底部
3. 确认显示：
   - 📺 官方视频频道：B站、YouTube
   - 📞 联系我们：微信、Telegram、视频号、TikTok
4. 点击测试跳转和弹窗功能

---

## 🎯 测试清单

### 对碰奖测试
- [ ] 2:1 配对计算正确
- [ ] 1:2 配对计算正确
- [ ] 奖金使用数据库参数（10U × 85% = 8.5U）
- [ ] 平台分红正确（10U × 15% = 1.5U）

### 平级奖测试
- [ ] 仅追溯3代
- [ ] 每人获得2U
- [ ] 直推≥2人才触发

### 复投测试
- [ ] 200U触发复投提示
- [ ] 自动增加订单数量
- [ ] 滑落到弱区

### 参数热更新测试
- [ ] 修改参数后1分钟内生效
- [ ] 数据库不可用时降级到硬编码
- [ ] 缓存正常工作

---

## 📊 技术细节

### 动态参数工作流程

```
1. BinaryService 方法调用
   ↓
2. getDynamicConfig() 读取参数
   ↓
3. SystemParamsService.getParam()
   ↓
4. 检查缓存（1分钟TTL）
   ├─ 有效 → 返回缓存值
   └─ 过期 → 查询数据库 → 更新缓存
   ↓
5. 使用动态参数计算
   ↓
6. 数据库失败 → 降级硬编码
```

### 缓存机制
- **缓存时间**：60秒
- **缓存位置**：`SystemParamsService.cache`
- **刷新时机**：TTL过期或手动清除
- **降级策略**：数据库不可用时使用 `BinaryConfig`

### 性能优化
- ✅ 批量并行读取参数（Promise.all）
- ✅ 1分钟缓存减少查询
- ✅ 降级机制保证可用性
- ✅ 按需加载动态配置

---

## 🔧 故障排查

### 问题1：参数修改不生效
**原因**：缓存未过期  
**解决**：等待1分钟或重启服务

### 问题2：计算结果异常
**原因**：数据库参数错误  
**解决**：检查 system_params 表数据

### 问题3：降级到硬编码
**原因**：数据库连接失败  
**解决**：检查 Supabase 连接状态

### 问题4：前端显示不更新
**原因**：浏览器缓存  
**解决**：强制刷新（Ctrl+F5）

---

## 📝 代码变更总结

### 新增代码
```typescript
// src/services/BinaryService.ts
private static async getDynamicConfig() {
  // 从数据库读取参数
  // 支持降级到硬编码
  // 返回统一配置对象
}
```

### 修改方法
- `calculatePairing()` - 使用 config.pairingBonus
- `triggerLevelBonus()` - 使用 config.levelBonusDepth/Amount
- `checkReinvestRequired()` - 使用 config.reinvestThreshold
- `getBinaryInfo()` - 使用 config 计算预估奖励

### 删除代码
- ❌ 无删除（仅替换硬编码引用）

---

## 🎉 升级亮点

### 1. 参数热更新 ⭐
- 管理员可在后台实时修改参数
- 1分钟内自动生效
- 无需重启服务

### 2. 降级保护 🛡️
- 数据库故障时自动降级
- 系统持续可用
- 错误日志清晰

### 3. 性能优化 ⚡
- 参数缓存减少查询
- 批量并行读取
- 响应速度不受影响

### 4. 易于维护 🔧
- 集中管理配置
- 代码清晰易读
- 扩展性强

---

## 🚀 下一步计划

### 短期（已完成）
- ✅ 重构 BinaryService
- ✅ 支持核心参数热更新
- ✅ 添加降级机制
- ✅ 更新前端提示

### 中期（可选）
- ⏳ 支持更多参数动态化（复投金额、分红比例）
- ⏳ 添加参数变更历史记录
- ⏳ 实现参数修改审计日志

### 长期（规划）
- ⏳ A/B测试支持
- ⏳ 参数回滚功能
- ⏳ 图形化参数管理

---

## ✅ 部署完成确认

### 数据库
- [ ] 执行 migration_sync_params_v4.1.sql
- [ ] 执行 migration_platform_contacts.sql
- [ ] 验证参数值正确

### 前端
- [ ] npm run build 成功
- [ ] netlify deploy --prod 成功
- [ ] 生产URL可访问

### 功能验证
- [ ] 参数热更新工作正常
- [ ] 对碰奖计算正确
- [ ] 平级奖触发正确
- [ ] 复投机制正常
- [ ] 联系方式显示正确

### 文档
- [ ] 阅读本部署指南
- [ ] 了解参数配置方法
- [ ] 掌握故障排查方法

---

**部署时间**：2025-10-14  
**版本号**：V4.2  
**部署人员**：AI Assistant  
**状态**：✅ 准备就绪

🎉 **恭喜！V4.2 参数热更新功能已完成重构，现在可以开始部署了！**


