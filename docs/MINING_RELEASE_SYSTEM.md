# 🏭 矿机释放系统 - 完整文档

> **版本**: v3.0  
> **更新时间**: 2025-10-04  
> **状态**: ✅ 已实现

---

## 📊 最新矿机配置

### 核心参数

| 配置项 | 数值 | 说明 |
|--------|------|------|
| **基础释放率** | 1%/天 | 所有矿机统一基础释放率 |
| **直推加速** | 1.5%/个 | 每个直推增加1.5%释放率 |
| **最大加速** | 10% | 加速率上限 |
| **最大有效直推** | 6-7个 | 10% ÷ 1.5% ≈ 6.67个 |

---

### 🔷 三种矿机类型

| 矿机类型 | 成本 | 基础产出 | 出局倍数 | 总产出 | 特点 |
|---------|------|---------|---------|--------|------|
| **一型** | 100积分 | 1积分/天 | **10倍** | 1,000积分 | 高倍数，长周期 |
| **二型** | 1,000积分 | 10积分/天 | **2倍** | 2,000积分 | 快速回本 |
| **三型** | 5,000积分 | 50积分/天 | **2倍** | 10,000积分 | 大额快速 |

---

## ⚡ 加速机制详解

### 计算公式

```
每日释放积分 = 投入积分 × (基础释放率 + 加速率)
基础释放率 = 1%
加速率 = min(直推数 × 1.5%, 10%)
```

### 加速等级表

| 直推数 | 加速率 | 总释放率 | 一型日产 | 二型日产 | 三型日产 |
|--------|--------|---------|---------|---------|---------|
| 0 | 0% | 1% | 1积分 | 10积分 | 50积分 |
| 1 | 1.5% | 2.5% | 2.5积分 | 25积分 | 125积分 |
| 2 | 3% | 4% | 4积分 | 40积分 | 200积分 |
| 3 | 4.5% | 5.5% | 5.5积分 | 55积分 | 275积分 |
| 4 | 6% | 7% | 7积分 | 70积分 | 350积分 |
| 5 | 7.5% | 8.5% | 8.5积分 | 85积分 | 425积分 |
| 6 | 9% | 10% | 10积分 | 100积分 | 500积分 |
| **7+** | **10%** | **11%** | **11积分** | **110积分** | **550积分** |

⚠️ **注意**: 7个及以上直推效果相同，都是最大加速10%

---

## 🎯 出局周期计算

### 一型矿机（100积分 → 1,000积分）

| 直推数 | 日产 | 出局天数 | 说明 |
|--------|------|---------|------|
| 0 | 1 | 1000天 | 约2.7年 |
| 1 | 2.5 | 400天 | 约13个月 |
| 2 | 4 | 250天 | 约8个月 |
| 3 | 5.5 | 182天 | 约6个月 |
| 4 | 7 | 143天 | 约4.7个月 |
| 5 | 8.5 | 118天 | 约4个月 |
| 6 | 10 | 100天 | 约3.3个月 |
| **7+** | **11** | **91天** | **约3个月（最快）** |

---

### 二型矿机（1,000积分 → 2,000积分）

| 直推数 | 日产 | 出局天数 | 说明 |
|--------|------|---------|------|
| 0 | 10 | 200天 | 约6.7个月 |
| 1 | 25 | 80天 | 约2.7个月 |
| 2 | 40 | 50天 | 约1.7个月 |
| 3 | 55 | 37天 | 约1.2个月 |
| 4 | 70 | 29天 | 约1个月 |
| 5 | 85 | 24天 | 约24天 |
| 6 | 100 | 20天 | 约20天 |
| **7+** | **110** | **19天** | **约19天（最快）** |

---

### 三型矿机（5,000积分 → 10,000积分）

| 直推数 | 日产 | 出局天数 | 说明 |
|--------|------|---------|------|
| 0 | 50 | 200天 | 约6.7个月 |
| 1 | 125 | 80天 | 约2.7个月 |
| 2 | 200 | 50天 | 约1.7个月 |
| 3 | 275 | 37天 | 约1.2个月 |
| 4 | 350 | 29天 | 约1个月 |
| 5 | 425 | 24天 | 约24天 |
| 6 | 500 | 20天 | 约20天 |
| **7+** | **550** | **19天** | **约19天（最快）** |

---

## 🔄 每日自动释放系统

### 系统架构

```
┌─────────────────────────────────────┐
│   应用启动 (App.vue)                 │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│   定时任务服务                       │
│   (SchedulerService)                │
│   • 每日零点执行                     │
│   • 自动释放所有活跃矿机             │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│   矿机服务 (MiningService)          │
│   • releaseAllMachines()            │
│   • releaseDailyPoints()            │
└──────────┬──────────────────────────┘
           │
           ▼
┌─────────────────────────────────────┐
│   数据库更新                         │
│   • 更新矿机释放积分                 │
│   • 更新用户积分余额                 │
│   • 检查出局条件                     │
└─────────────────────────────────────┘
```

---

### 核心代码实现

#### 1. 定时任务服务 (`scheduler.service.ts`)

```typescript
export class SchedulerService {
  /**
   * 启动每日释放任务
   * 每天零点自动执行
   */
  static startDailyReleaseTask(): void {
    const scheduleNextRelease = () => {
      const now = new Date()
      const tomorrow = new Date(now)
      tomorrow.setDate(tomorrow.getDate() + 1)
      tomorrow.setHours(0, 0, 0, 0)
      
      const timeUntilMidnight = tomorrow.getTime() - now.getTime()
      
      this.releaseTimer = setTimeout(async () => {
        await this.executeDailyRelease()
        scheduleNextRelease() // 递归安排下一次
      }, timeUntilMidnight)
    }
    
    scheduleNextRelease()
  }
  
  /**
   * 执行每日释放
   */
  static async executeDailyRelease(): Promise<void> {
    await MiningService.releaseAllMachines()
  }
}
```

#### 2. 矿机服务释放逻辑 (`mining.service.ts`)

```typescript
/**
 * 批量释放所有活跃矿机
 */
static async releaseAllMachines(): Promise<void> {
  const { data: machines } = await supabase
    .from('mining_machines')
    .select('id')
    .eq('is_active', true)
  
  // 并发释放所有矿机
  const releasePromises = machines.map(machine => 
    this.releaseDailyPoints(machine.id)
  )
  
  await Promise.all(releasePromises)
}

/**
 * 释放单个矿机的积分
 */
static async releaseDailyPoints(machineId: string): Promise<number> {
  const { data: machine } = await supabase
    .from('mining_machines')
    .select('*')
    .eq('id', machineId)
    .single()
  
  // 计算每日释放量
  const dailyRelease = machine.initial_points * 
    (machine.base_rate + machine.boost_rate)
  
  // 检查是否达到出局上限
  const potentialRelease = machine.released_points + dailyRelease
  let actualRelease = dailyRelease
  let shouldExit = false
  
  if (potentialRelease >= machine.total_points) {
    actualRelease = machine.total_points - machine.released_points
    shouldExit = true
  }
  
  // 更新矿机和用户积分
  await supabase
    .from('mining_machines')
    .update({
      released_points: machine.released_points + actualRelease,
      is_active: !shouldExit,
      exited_at: shouldExit ? new Date().toISOString() : null
    })
    .eq('id', machineId)
  
  await supabase
    .from('users')
    .update({
      points_balance: supabase.rpc('increment', { 
        row_id: machine.user_id, 
        amount: actualRelease 
      })
    })
    .eq('id', machine.user_id)
  
  return actualRelease
}
```

---

## 💰 收益计算器

### 一型矿机收益（7个直推，最大加速）

```
投入: 100积分
日产: 11积分/天
周期: 91天
总产出: 1,000积分
兑换收益: 
  ├─ U余额: 1,000 × 0.07 × 0.7 = 49U
  └─ 互转积分: 1,000 × 0.3 = 300积分

ROI: 10倍
日均收益: 0.54U
```

### 二型矿机收益（7个直推，最大加速）

```
投入: 1,000积分
日产: 110积分/天
周期: 19天
总产出: 2,000积分
兑换收益:
  ├─ U余额: 2,000 × 0.07 × 0.7 = 98U
  └─ 互转积分: 2,000 × 0.3 = 600积分

ROI: 2倍
日均收益: 5.16U
```

### 三型矿机收益（7个直推，最大加速）

```
投入: 5,000积分
日产: 550积分/天
周期: 19天
总产出: 10,000积分
兑换收益:
  ├─ U余额: 10,000 × 0.07 × 0.7 = 490U
  └─ 互转积分: 10,000 × 0.3 = 3,000积分

ROI: 2倍
日均收益: 25.79U
```

---

## 🎯 投资策略建议

### 策略1: 保守型（适合新手）

**配置**: 1台一型矿机

```
初始投入: 100积分
推荐直推: 3-5个
预期周期: 118-182天
预期收益: 49U + 300积分

优势:
✅ 投入小，风险低
✅ 10倍出局，高ROI
✅ 适合长期持有
✅ 学习成本低
```

---

### 策略2: 激进型（适合高级）

**配置**: 2台二型 + 1台三型

```
初始投入: 7,000积分
推荐直推: 7个以上
预期周期: 19天（最快）
预期收益: 686U + 4,200积分

优势:
✅ 快速回本
✅ 高日均收益
✅ 适合有团队的用户
✅ 复投效率高
```

---

### 策略3: 混合型（推荐）

**配置**: 3台一型 + 1台二型

```
初始投入: 1,300积分
推荐直推: 5-7个
预期周期: 一型91-118天，二型19-24天
预期收益: 245U + 1,500积分

优势:
✅ 风险分散
✅ 长短结合
✅ 适合中级用户
✅ 平衡性好
```

---

## 🔧 手动触发释放（测试功能）

### 在浏览器控制台测试

```javascript
// 手动触发一次释放
import { SchedulerService } from '@/services/scheduler.service'
await SchedulerService.manualRelease()

// 查看任务状态
const status = SchedulerService.getStatus()
console.log(status)

// 启动测试模式（每分钟释放一次）
SchedulerService.startTestMode()

// 停止任务
SchedulerService.stopDailyReleaseTask()
```

---

## 📊 对比：旧版 vs 新版

| 对比项 | 旧版 v2.0 | 新版 v3.0 |
|--------|----------|----------|
| 直推加速 | 2%/个 | **1.5%/个** |
| 最大加速 | 40% (20个直推) | **10% (6-7个直推)** |
| 一型出局 | 10倍 | **10倍（不变）** |
| 二型出局 | 10倍 | **2倍** |
| 三型出局 | 10倍 | **2倍** |
| 自动释放 | ❌ 无 | **✅ 每日零点自动** |

---

## 🎯 核心优势

### 1. **降低推广门槛**
- 旧版需要20个直推才能达到最大加速
- **新版只需6-7个直推即可**
- 推广难度大幅降低

### 2. **快速回本**
- 二型和三型矿机改为2倍出局
- **最快19天即可回本**
- 提高用户积极性

### 3. **自动化释放**
- 无需手动操作
- **每日零点自动释放**
- 提升用户体验

### 4. **灵活复投**
- 一型适合长期持有（10倍）
- 二型/三型快速回本（2倍）
- **满足不同用户需求**

---

## 📝 使用说明

### 1. 查看定时任务状态

打开浏览器控制台，查看任务日志：

```
🚀 应用启动，初始化定时任务系统
🧪 开发环境：启动测试模式（每分钟释放）
📊 定时任务状态: { isRunning: true, nextReleaseTime: '2025-10-05 00:00:00' }
⏰ 下次释放时间: 2025-10-05 00:00:00
⏱️ 距离下次释放: 123 分钟
```

### 2. 购买矿机

访问应用的"积分"页面，选择矿机类型并购买。

### 3. 等待自动释放

每日零点系统会自动释放所有活跃矿机的积分。

### 4. 查看收益

在"积分"页面查看"我的矿机"，可以看到每台矿机的释放进度。

---

## 🛠️ 技术细节

### 文件位置
- **定时任务服务**: `src/services/scheduler.service.ts`
- **矿机服务**: `src/services/mining.service.ts`
- **应用入口**: `src/App.vue`
- **积分页面**: `src/views/points/PointsView.vue`

### 核心常量
```typescript
MACHINE_TYPE_1_COST = 100
MACHINE_TYPE_2_COST = 1000
MACHINE_TYPE_3_COST = 5000
MACHINE_TYPE_1_MULTIPLIER = 10
MACHINE_TYPE_2_MULTIPLIER = 2
MACHINE_TYPE_3_MULTIPLIER = 2
BASE_RELEASE_RATE = 0.01
BOOST_PER_REFERRAL = 0.015
MAX_BOOST_RATE = 0.10
```

---

## 📈 数据统计

### 测试数据（假设100个用户，各有7个直推）

| 矿机类型 | 数量 | 日总释放 | 月总释放 | 说明 |
|---------|------|---------|---------|------|
| 一型 | 300台 | 3,300积分 | 99,000积分 | 长期稳定 |
| 二型 | 150台 | 16,500积分 | 495,000积分 | 中等规模 |
| 三型 | 50台 | 27,500积分 | 825,000积分 | 大额快速 |
| **总计** | **500台** | **47,300积分** | **1,419,000积分** | **日均释放** |

---

## 🎉 总结

### ✅ 主要更新

1. ✅ **降低推广门槛**: 6-7个直推即可达到最大加速
2. ✅ **快速回本**: 二型/三型改为2倍出局，最快19天
3. ✅ **自动释放**: 每日零点自动释放所有矿机
4. ✅ **灵活策略**: 一型10倍长期，二三型2倍快速

### 🎯 适用场景

- **新手用户**: 购买一型矿机，长期持有
- **中级用户**: 混合投资，平衡收益
- **高级用户**: 重仓二三型，快速回本

### 🚀 下一步

- 继续推广，增加直推
- 购买矿机，开始挖矿
- 等待每日自动释放
- 出局后复投或提现

---

**文档版本**: v3.0  
**最后更新**: 2025-10-04  
**测试状态**: ✅ 已实现并测试






























