# ✅ 参数一致性检查清单

## 📊 Binary系统参数对比

### 核心参数对比表

| 参数名称 | 配置文件位置 | 代码值 | 数据库字段 | 数据库旧值 | 同步后值 | 状态 |
|---------|------------|-------|-----------|----------|---------|------|
| **代理费用** | `BinaryConfig.JOIN_FEE` | 30U | `agent_fee` | 30 | 30 | ✅ 一致 |
| **对碰奖金** | `BinaryConfig.PAIRING.BONUS_PER_PAIR` | 10U | `pairing_bonus_per_pair` | 7 | **10** | ⚠️ 需同步 |
| **会员比例** | `BinaryConfig.PAIRING.MEMBER_RATIO` | 85% | `member_ratio` | 85 | 85 | ✅ 一致 |
| **平台比例** | `BinaryConfig.PAIRING.PLATFORM_RATIO` | 15% | `platform_ratio` | 15 | 15 | ✅ 一致 |
| **平级奖金** | `BinaryConfig.LEVEL_BONUS.AMOUNT` | 2U | `level_bonus_per_person` | 2 | 2 | ✅ 一致 |
| **平级奖层级** | `BinaryConfig.LEVEL_BONUS.DEPTH` | 3代 | `level_bonus_depth` | 8 | **3** | ⚠️ 需同步 |
| **解锁直推数** | `BinaryConfig.LEVEL_BONUS.UNLOCK_CONDITION` | 2人 | `min_direct_referrals` | 2 | 2 | ✅ 一致 |
| **复投阈值** | `BinaryConfig.REINVEST.THRESHOLD` | 200U | `reinvest_threshold` | 300 | **200** | ⚠️ 需同步 |
| **复投金额** | `BinaryConfig.REINVEST.AMOUNT` | 30U | - | - | - | ⚠️ 硬编码 |
| **分红条件** | `BinaryConfig.DIVIDEND.CONDITION` | 10人 | `dividend_min_referrals` | 10 | 10 | ✅ 一致 |
| **分红比例** | `BinaryConfig.DIVIDEND.RATIO` | 15% | - | - | - | ⚠️ 硬编码 |

---

## 📝 AI学习机参数对比

| 参数名称 | 配置位置 | 代码值 | 数据库字段 | 数据库值 | 状态 |
|---------|---------|-------|-----------|---------|------|
| **学习机价格** | - | 7U | `machine_price` | 7 | ✅ 一致 |
| **首次激活积分** | - | 100 | `first_activation_points` | 100 | ✅ 一致 |
| **每日释放率** | - | 10% | `daily_release_rate` | 10 | ✅ 一致 |
| **退出倍数** | - | 2倍 | `exit_multiplier` | 2 | ✅ 一致 |
| **释放到U比例** | - | 70% | `to_u_percent` | 70 | ✅ 一致 |
| **释放到积分比例** | - | 30% | `to_transfer_percent` | 30 | ✅ 一致 |

---

## 💰 提现参数对比

| 参数名称 | 配置位置 | 代码值 | 数据库字段 | 数据库值 | 状态 |
|---------|---------|-------|-----------|---------|------|
| **最低提现** | - | - | `min_amount` | 10 | ⚠️ 仅数据库 |
| **手续费比例** | - | - | `fee_percent` | 5 | ⚠️ 仅数据库 |
| **每日限额** | - | - | `daily_limit` | 10000 | ⚠️ 仅数据库 |

---

## 🔧 需要执行的同步操作

### 步骤1：执行SQL同步（必须）
```sql
-- 文件：supabase/migration_sync_params_v4.1.sql

UPDATE system_params SET param_value = 10 WHERE param_key = 'pairing_bonus_per_pair';
UPDATE system_params SET param_value = 200 WHERE param_key = 'reinvest_threshold';
UPDATE system_params SET param_value = 3 WHERE param_key = 'level_bonus_depth';
```

### 步骤2：检查生效情况
1. 登录 Supabase Dashboard
2. 打开 SQL Editor
3. 执行查询：
   ```sql
   SELECT param_key, param_value, param_unit, description
   FROM system_params
   WHERE category = 'binary'
   ORDER BY param_key;
   ```
4. 确认以下参数已更新：
   - ✅ `pairing_bonus_per_pair` = 10
   - ✅ `reinvest_threshold` = 200
   - ✅ `level_bonus_depth` = 3

---

## ⚠️ 当前设计缺陷

### 问题1：硬编码参数
以下参数仅在代码中定义，未存储在数据库：
- `BinaryConfig.REINVEST.AMOUNT` (30U)
- `BinaryConfig.DIVIDEND.RATIO` (15%)
- `BinaryConfig.PAIRING.REQUIRED_UNITS` (2:1, 1:2)
- `BinaryConfig.AUTO_PLACEMENT.WEAK_SIDE_PRIORITY` (true)

**影响**：这些参数无法通过管理后台修改。

### 问题2：参数不生效
管理员在后台修改 `system_params` 表的参数后：
- ✅ 前端界面会显示新值
- ❌ 后端业务逻辑不会使用新值
- ❌ 仍然使用 `BinaryConfig` 硬编码值

**原因**：`BinaryService.ts` 没有导入和使用 `SystemParamsService`。

### 问题3：两套配置系统
- **system_params 表**：数字类型参数（用于管理界面）
- **system_config 表**：JSONB类型配置（如平台联系方式）
- **BinaryConfig 文件**：硬编码配置（实际生效）

**影响**：配置管理混乱，容易导致不一致。

---

## 🎯 解决建议

### 短期方案（已实施）✅
1. ✅ 执行 SQL 同步参数
2. ✅ 在管理后台添加警告提示
3. ✅ 编写问题报告文档

### 中期方案（推荐）⭐
1. 重构 `BinaryService` 使用 `SystemParamsService.getParam()`
2. 添加参数缓存，减少数据库查询
3. 保留 `BinaryConfig` 作为降级方案

### 长期方案（理想状态）
1. 统一所有参数到数据库
2. 实现参数变更历史记录
3. 支持参数A/B测试
4. 添加参数修改审计

---

## 📋 检查清单

### 数据库同步
- [ ] 执行 `migration_sync_params_v4.1.sql`
- [ ] 验证 `pairing_bonus_per_pair` = 10
- [ ] 验证 `reinvest_threshold` = 200
- [ ] 验证 `level_bonus_depth` = 3
- [ ] 执行 `migration_platform_contacts.sql`

### 前端更新
- [x] 管理后台添加警告提示
- [x] 个人中心联系方式更新
- [x] 按钮文字改为"保存到数据库"

### 文档完善
- [x] 创建《前后端参数不一致问题报告.md》
- [x] 创建《参数一致性检查清单.md》
- [x] 创建《平台联系方式配置说明.md》
- [x] 更新 SQL 迁移文件

### 测试验证
- [ ] 测试对碰奖计算（应为10U）
- [ ] 测试复投提示（应为200U）
- [ ] 测试平级奖触发（应为3代）
- [ ] 测试管理后台参数显示
- [ ] 测试平台联系方式显示

---

## 📊 参数使用情况分析

### 从数据库读取的参数（少数）
- AI学习机参数（通过 `MiningService`）
- 提现参数（通过各个服务零散读取）

### 硬编码的参数（多数）
- Binary系统所有参数
- 奖励计算参数
- 业务规则参数

### 混合使用
- 前端显示：从数据库读取
- 后端计算：使用硬编码

---

## 🔍 代码审计

### BinaryService.ts 使用的硬编码
```typescript
// 第16行
import { BinaryConfig, ... } from '@/config/binary'

// 第535行
while (currentUserId && generation <= BinaryConfig.LEVEL_BONUS.DEPTH) {

// 第586行
const threshold = BinaryConfig.REINVEST.THRESHOLD * (member.reinvest_count + 1)
```

**问题**：这些代码直接使用配置文件，不会读取数据库。

### SystemParamsService.ts 功能
```typescript
// 提供了读取参数的方法
static async getParam(paramKey: string): Promise<number>

// 但没有被 BinaryService 使用！
```

---

## 💡 总结

| 项目 | 状态 | 优先级 |
|-----|------|-------|
| **参数同步SQL** | ✅ 已创建 | P0 |
| **问题文档** | ✅ 已完成 | P0 |
| **前端警告** | ✅ 已添加 | P1 |
| **数据库执行** | ⏳ 待执行 | P0 |
| **代码重构** | ⏳ 待实施 | P1 |
| **测试验证** | ⏳ 待测试 | P1 |

**当前状态**：
- ✅ 系统可正常运行（使用硬编码）
- ⚠️ 参数不一致（已准备同步脚本）
- ⚠️ 管理后台功能受限（已添加提示）

**下一步**：
1. 执行 SQL 同步数据库参数
2. 测试验证系统功能
3. 规划代码重构方案


