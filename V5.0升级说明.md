# V5.0 重大升级说明（简化版）

更新日期：2025-10-15

---

## 📋 核心变更总览

### 1. 自动排线逻辑 ✨
**V4.2旧逻辑**：
- 向上追溯找根节点
- 从根节点开始查找整个团队的弱区
- 全局弱区优先滑落

**V5.0新逻辑**：
- 取消全局弱区优先
- 改为"团队内部滑落"
- 新用户直接滑落到推荐人的直推下面
- 选择推荐人直推中的弱边

**示例**：
```
我(推荐人)
├─ A (第1个直推) ← C滑到这里的弱边
│  └─ C (第3个直推)
└─ B (第2个直推)
```

---

### 2. 对碰结算 ✨
**V4.2旧逻辑**：
- 即时结算（秒结算）
- 达到2:1或1:2立即触发

**V5.0新逻辑**：
- 每天凌晨12点统一结算
- 累积pending单量，等待定时结算
- 减少系统负载，更公平

---

### 3. 奖励机制 ✨
**V4.2旧逻辑**：
- 平级奖：追溯3代直推链，每人2U固定奖励
- 分红池：对碰奖的15%进分红池，直推≥10人分享

**V5.0新逻辑**：
- ❌ **删除平级奖**
- ❌ **删除贡献奖**
- ❌ **删除分红池**
- ✅ **只保留对碰奖**
- 对碰奖10U：85%（8.5U）给会员，**15%（1.5U）预留**
- 预留资金暂不分配，留作将来使用

---

### 4. 复购机制 ✨
**V4.2旧逻辑**：
- 赚200U复投30U

**V5.0新逻辑**：
- 赚240U（8倍）复投30U
- **复购单自动添加到弱区pending**
- 帮助平衡A区B区

**示例**：
```
复购前：A区5单，B区3单（B是弱区）
复购后：A区5单，B区4单（弱区+1单）
```

---

## 🔧 技术实现要点

### 1. 配置文件变更
**文件**：`src/config/binary.ts`

```typescript
// V5.0 简化版配置
PAIRING: {
  BONUS_PER_PAIR: 10,            // 每单对碰奖励10U
  MEMBER_RATIO: 0.85,            // 85%给会员（8.5U）
  RESERVED_RATIO: 0.15,          // 15%预留（1.5U，暂不分配）
  SCHEDULED_SETTLEMENT: true,    // 定时结算
  SETTLEMENT_TIME: '00:00'       // 凌晨12点
}

AUTO_PLACEMENT: {
  STRATEGY: 'TEAM_INTERNAL',     // 团队内部滑落
  SLIDE_TO_DIRECT_REFERRAL: true // 滑落到直推下面
}

REINVEST: {
  THRESHOLD: 240,                // 240U（8倍）
  ADD_TO_WEAK_SIDE: true         // 复购单给弱区
}

SETTLEMENT: {
  PAIRING_SCHEDULED: true,       // 对碰定时结算
  LEVEL_BONUS_ENABLED: false,    // 平级奖已删除
  CONTRIBUTION_ENABLED: false,   // 贡献奖已删除
  DIVIDEND_ENABLED: false        // 分红已删除
}
```

---

### 2. 服务层变更
**文件**：`src/services/BinaryService.ts`

**需要修改的方法**：
1. `findBestPlacement()` - 改为团队内部滑落
2. `calculatePairing()` - 改为定时触发，累积pending，记录预留15%
3. `checkReinvestRequired()` - 阈值改为240U，复购单给弱区
4. ~~`triggerLevelBonus()` - 删除平级奖逻辑~~

---

### 3. 定时任务
**需要新增**：
- **对碰结算定时任务**：每天凌晨12点触发

**实现方式**：
- Supabase Edge Functions + Cron
- 或使用 `pg_cron` 扩展

---

### 4. 数据库变更
**执行迁移SQL**：`supabase/migrations/migration_v5.0_upgrade.sql`

**主要内容**：
```sql
-- 1. 更新系统参数
UPDATE system_params SET param_value = 240 WHERE param_key = 'reinvest_threshold';

-- 2. 新增定时任务表
CREATE TABLE IF NOT EXISTS scheduled_tasks (...);
INSERT INTO scheduled_tasks (task_name, cron_schedule) VALUES
('pairing_settlement', '0 0 * * *');  -- 每天凌晨12点

-- 3. 新增预留资金表
CREATE TABLE IF NOT EXISTS reserved_funds (...);

-- 4. binary_members表新增字段
ALTER TABLE binary_members 
ADD COLUMN IF NOT EXISTS pending_settlement_amount DECIMAL(20, 2) DEFAULT 0;
```

---

## 📊 前端显示变更

### 1. 二元信息页面
**文件**：`src/views/binary/BinaryView.vue`

**变更**：
- ~~"3代平级奖"~~ → **删除**
- "即时结算" → "每天凌晨12点结算"
- "对碰奖：10U" → "对碰奖：8.5U到账+1.5U预留"
- 新增说明：
  ```
  💰 对碰奖（2:1或1:2）：
  - 85%（8.5U）→ 自动到账
  - 15%（1.5U）→ 预留待用
  - 每天凌晨12点统一结算
  ```

---

### 2. 收益页面
**文件**：`src/views/earnings/EarningsView.vue`

**变更**：
- 删除"平级奖"选项卡
- 删除"分红"选项卡
- 只保留"对碰奖"选项卡

---

### 3. 个人中心
**文件**：`src/views/profile/ProfileView.vue`

**变更**：
- 复投提示：200U → 240U
- 新增"复购单自动补弱区"说明

---

## 🧪 测试要点

### 1. 自动排线测试
- [ ] 测试推荐人A区B区都空时，新用户放A区
- [ ] 测试推荐人只有A区有人，新用户放B区
- [ ] 测试推荐人A区B区都有人，新用户滑到弱边
- [ ] 验证不再向上追溯到根节点

### 2. 对碰结算测试
- [ ] 测试pending单量累积
- [ ] 测试凌晨12点定时结算
- [ ] 验证结算后pending清零
- [ ] 验证85%到账，15%记录到预留资金表

### 3. 复购测试
- [ ] 测试240U复购提示
- [ ] 测试复购单自动加到弱区pending
- [ ] 验证A区B区平衡

### 4. 奖励测试
- [ ] 验证只有对碰奖，没有平级奖
- [ ] 验证没有分红池结算
- [ ] 验证收益页面只显示对碰奖

---

## 📝 部署检查清单

- [ ] 1. 执行数据库迁移SQL
- [ ] 2. 更新配置文件（`binary.ts`）
- [ ] 3. 修改服务层（`BinaryService.ts`）
- [ ] 4. 配置定时任务（Supabase Edge Functions）
- [ ] 5. 更新前端显示
- [ ] 6. 更新文档
- [ ] 7. 冒烟测试
- [ ] 8. 部署到生产环境
- [ ] 9. 监控错误日志
- [ ] 10. 通知用户新规则

---

## ⚠️ 注意事项

1. **数据迁移**：
   - 旧的"平级奖"记录保留，标记为历史数据
   - 新的"贡献奖"从升级后开始生效

2. **定时任务**：
   - 确保定时任务正确配置
   - 测试定时任务是否按时触发

3. **用户通知**：
   - 通知用户新规则（尤其是贡献奖和定时结算）
   - 在前端显示明显的升级公告

4. **回滚计划**：
   - 保留V4.2配置备份
   - 如有问题，可快速回滚

---

## 🎯 预期效果

1. **更公平**：
   - 团队内部滑落，避免全局弱区被"蹭奖"
   - 定时结算，减少抢单现象
   - 规则透明，只有对碰奖

2. **更简单**：
   - 删除平级奖、贡献奖、分红池
   - 只保留对碰奖，规则清晰
   - 易于理解和解释

3. **更稳定**：
   - 定时结算，减少系统负载
   - 复购单补弱区，自动平衡
   - 预留15%，留作将来扩展

4. **更灵活**：
   - 15%预留资金可在将来用于：
     - 平台运营
     - 特殊奖励活动
     - 用户补贴
     - 其他用途

---

**升级后，整个系统将更加简洁、公平、稳定！** ✨

