# 🗑️ 群聊管理和删除聊天记录位置

## 📍 位置 1：系统管理页面（删除过期消息）

### 访问路径
```
管理后台 → 系统管理 → 聊天消息管理
/admin/system
```

### 功能说明
```
文件：src/views/admin/SystemView.vue（第1-40行）

✅ 显示消息统计：
  - 总消息数
  - 用户消息数
  - 机器人消息数
  - 待清理消息数

✅ 清理规则：
  - 用户消息：超过5分钟自动清理
  - 机器人消息（自动赚钱群）：超过10分钟清理
  - 机器人消息（AI科技群）：超过24小时清理

✅ 操作按钮：
  - 🔄 刷新统计
  - 🗑️ 立即清理
```

### 代码位置
```typescript
// src/views/admin/SystemView.vue

// 第779-791行：加载消息统计
const loadStats = async () => {
  messageStats.value = await AdminCleanupService.getMessageStats()
}

// 第793-814行：清理过期消息
const cleanup = async () => {
  const result = await AdminCleanupService.cleanupExpiredMessages()
}
```

---

## 📍 位置 2：群聊管理页面（管理群组）

### 访问路径
```
管理后台 → 群聊管理
/admin/groups
```

### 功能说明
```
文件：src/views/admin/GroupManagement.vue

✅ 管理群聊分类
✅ 管理群组列表
✅ 创建新群组
✅ 编辑群组信息
✅ 删除群组（会连带删除该群所有消息）
```

---

## 🔧 后端清理服务

### 文件位置
```
src/services/AdminCleanupService.ts
```

### 主要方法

#### 1. 获取消息统计
```typescript
AdminCleanupService.getMessageStats()

返回：
{
  total: 100,           // 总消息数
  userMessages: 50,     // 用户消息数
  botMessages: 50,      // 机器人消息数
  expiredUsers: 10,     // 过期用户消息
  expiredBots: 5,       // 过期机器人消息
  willDelete: 15        // 待清理总数
}
```

#### 2. 清理过期消息
```typescript
AdminCleanupService.cleanupExpiredMessages()

调用数据库函数：cleanup_expired_messages()

返回：
{
  success: true,
  message: '✅ 消息清理完成'
}
```

---

## 🗄️ 数据库清理函数

### 函数名
```sql
cleanup_expired_messages()
```

### 执行位置
```
Supabase SQL Editor
```

### 手动执行
```sql
-- 立即清理过期消息
SELECT cleanup_expired_messages();
```

### 清理逻辑
```sql
-- 1. 删除超过5分钟的用户消息
DELETE FROM messages
WHERE is_bot = false
  AND created_at < NOW() - INTERVAL '5 minutes';

-- 2. 删除超过10分钟的机器人消息（自动赚钱群）
DELETE FROM messages
WHERE is_bot = true
  AND chat_group_id IN (
    SELECT id FROM chat_groups WHERE type = 'default'
  )
  AND created_at < NOW() - INTERVAL '10 minutes';

-- 3. 删除超过24小时的机器人消息（AI科技群）
DELETE FROM messages
WHERE is_bot = true
  AND chat_group_id IN (
    SELECT id FROM chat_groups WHERE type = 'ai_push'
  )
  AND created_at < NOW() - INTERVAL '24 hours';
```

---

## 🎯 使用指南

### 方式 1：前端管理（推荐）
```
1. 访问 /admin/system
2. 查看"聊天消息管理"卡片
3. 点击"刷新统计"查看当前消息数
4. 点击"立即清理"删除过期消息
```

### 方式 2：数据库手动清理
```sql
-- Step 1: 查看当前消息
SELECT 
  cg.description,
  COUNT(*) as count,
  MAX(m.created_at) as latest
FROM messages m
JOIN chat_groups cg ON m.chat_group_id = cg.id
GROUP BY cg.description;

-- Step 2: 清理过期消息
SELECT cleanup_expired_messages();

-- Step 3: 验证清理结果
SELECT 
  cg.description,
  COUNT(*) as count
FROM messages m
JOIN chat_groups cg ON m.chat_group_id = cg.id
GROUP BY cg.description;
```

### 方式 3：删除特定群组的所有消息
```sql
-- 查看所有群组
SELECT id, name, description FROM chat_groups;

-- 删除指定群组的所有消息
DELETE FROM messages 
WHERE chat_group_id = 'YOUR_GROUP_ID';
```

### 方式 4：删除所有消息（危险！）
```sql
-- ⚠️ 警告：这将删除所有聊天记录！
-- 请在执行前确认！

DELETE FROM messages;
```

---

## 🔍 控制台错误说明

### 当前看到的错误
```
❌ table "public.recharge_records" does not exist
❌ table "public.dividend_records" does not exist
❌ table "public.chat_groups" does not exist
❌ table "public.chat_categories" does not exist
```

### 解决方案
**执行一键修复SQL：**
```
文件：一键修复-充值和消息.sql
位置：Supabase SQL Editor
```

这将创建：
- ✅ recharge_records 表（充值记录）
- ✅ messages 表的 is_bot 字段
- ✅ valid_messages 视图（自动过滤）
- ✅ cleanup_expired_messages() 函数
- ✅ 所有必要的索引和RLS策略

---

## ✅ 总结

| 功能 | 位置 | 路径 | 文件 |
|------|------|------|------|
| **删除过期消息** | 系统管理 | `/admin/system` | `SystemView.vue` |
| **管理群组** | 群聊管理 | `/admin/groups` | `GroupManagement.vue` |
| **清理服务** | 后端服务 | - | `AdminCleanupService.ts` |
| **数据库函数** | SQL函数 | Supabase | `cleanup_expired_messages()` |

---

**删除聊天记录的3种方式：**
1. ✅ **推荐**：访问 `/admin/system`，点击"立即清理"按钮
2. ⚙️ **高级**：Supabase执行 `SELECT cleanup_expired_messages()`
3. 🗑️ **全部删除**：Supabase执行 `DELETE FROM messages`

**现在执行一键修复SQL，所有功能就能正常使用了！** 🚀

