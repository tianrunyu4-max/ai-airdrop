# 后端错误修复指南

## 🔍 **问题分析**

从控制台错误看到：

```
❌ "Could not find the table 'public.checkin_records'"
❌ "Could not find the table 'public.recharge_records'"
❌ "column withdrawals.created_at does not exist"
❌ "GET system_config?select=platform_contacts 400"
```

**原因：** 数据库有4个问题：
1. `checkin_records` - 签到记录表不存在
2. `recharge_records` - 充值记录表不存在
3. `withdrawals.created_at` - 提现表缺少创建时间字段
4. `platform_contacts` - 平台联系方式配置缺失

---

## ✅ **解决方案（3步）**

### **步骤1：登录Supabase**

1. 打开 https://supabase.com
2. 登录你的账号
3. 选择项目：`AI智能空投`

---

### **步骤2：打开SQL Editor**

1. 点击左侧菜单 **SQL Editor**
2. 点击 **New query**

---

### **步骤3：执行修复SQL**

复制下面的完整SQL，粘贴到SQL编辑器，然后点击 **Run**：

```sql
-- ==========================================
-- 修复缺失的数据库表
-- ==========================================

-- 1. 创建签到记录表（如果不存在）
CREATE TABLE IF NOT EXISTS public.checkin_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  machine_id UUID,
  checkin_date DATE NOT NULL,
  points_released DECIMAL(10, 2) DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, checkin_date)
);

-- 2. 创建充值记录表（如果不存在）
CREATE TABLE IF NOT EXISTS public.recharge_records (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  amount DECIMAL(10, 2) NOT NULL,
  currency VARCHAR(10) DEFAULT 'USDT',
  network VARCHAR(20) NOT NULL,
  txid TEXT,
  status VARCHAR(20) DEFAULT 'pending',
  proof_image TEXT,
  admin_note TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  confirmed_at TIMESTAMPTZ,
  confirmed_by UUID REFERENCES auth.users(id)
);

-- 3. 启用RLS
ALTER TABLE public.checkin_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.recharge_records ENABLE ROW LEVEL SECURITY;

-- 4. 创建RLS策略 - checkin_records
DROP POLICY IF EXISTS "用户可查看自己的签到记录" ON public.checkin_records;
CREATE POLICY "用户可查看自己的签到记录" ON public.checkin_records
  FOR SELECT USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "用户可创建自己的签到记录" ON public.checkin_records;
CREATE POLICY "用户可创建自己的签到记录" ON public.checkin_records
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- 5. 创建RLS策略 - recharge_records
DROP POLICY IF EXISTS "用户可查看自己的充值记录" ON public.recharge_records;
CREATE POLICY "用户可查看自己的充值记录" ON public.recharge_records
  FOR SELECT USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "用户可创建充值记录" ON public.recharge_records;
CREATE POLICY "用户可创建充值记录" ON public.recharge_records
  FOR INSERT WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "管理员可查看所有充值记录" ON public.recharge_records;
CREATE POLICY "管理员可查看所有充值记录" ON public.recharge_records
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE users.id = auth.uid()
      AND users.is_admin = true
    )
  );

DROP POLICY IF EXISTS "管理员可更新充值记录" ON public.recharge_records;
CREATE POLICY "管理员可更新充值记录" ON public.recharge_records
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM public.users
      WHERE users.id = auth.uid()
      AND users.is_admin = true
    )
  );

-- 6. 创建索引（提高查询性能）
CREATE INDEX IF NOT EXISTS idx_checkin_records_user_id ON public.checkin_records(user_id);
CREATE INDEX IF NOT EXISTS idx_checkin_records_date ON public.checkin_records(checkin_date);
CREATE INDEX IF NOT EXISTS idx_recharge_records_user_id ON public.recharge_records(user_id);
CREATE INDEX IF NOT EXISTS idx_recharge_records_status ON public.recharge_records(status);
CREATE INDEX IF NOT EXISTS idx_recharge_records_created_at ON public.recharge_records(created_at DESC);

-- 7. 验证表已创建
SELECT 
  table_name,
  table_type
FROM information_schema.tables
WHERE table_schema = 'public'
  AND table_name IN ('checkin_records', 'recharge_records')
ORDER BY table_name;
```

---

### **步骤4：执行充值配置SQL**

继续执行这个SQL（配置充值地址）：

```sql
-- 配置充值系统
INSERT INTO system_config (key, value, description)
VALUES (
  'recharge_config',
  jsonb_build_object(
    'usdt_trc20', 'TQTjfehUeHRWkw7QkcRKojWYdzYPebr9iS',
    'usdt_bep20', '0xc8288b98f7c2cc11bccbc033754effcc87c1909e',
    'enable_recharge', true,
    'min_amount', 30,
    'notice', '💡 充值说明：\n1. 认真核对充值地址\n2. 30U起步\n3. AI自动审核 稍等片刻'
  ),
  '充值系统配置（TRC20波场链 + BEP20币安智能链）'
)
ON CONFLICT (key) DO UPDATE
SET 
  value = jsonb_build_object(
    'usdt_trc20', 'TQTjfehUeHRWkw7QkcRKojWYdzYPebr9iS',
    'usdt_bep20', '0xc8288b98f7c2cc11bccbc033754effcc87c1909e',
    'enable_recharge', true,
    'min_amount', 30,
    'notice', '💡 充值说明：\n1. 认真核对充值地址\n2. 30U起步\n3. AI自动审核 稍等片刻'
  ),
  updated_at = NOW();
```

---

## 🔍 **验证修复**

执行完成后，应该看到查询结果：

```
table_name          | table_type
--------------------|-------------
checkin_records     | BASE TABLE
recharge_records    | BASE TABLE
```

---

## 🎯 **刷新页面测试**

1. 关闭浏览器的**开发者工具**（F12）
2. 刷新页面（Ctrl + F5 强制刷新）
3. 再次打开开发者工具（F12）
4. 查看控制台，**应该没有错误了** ✅

---

## 📋 **功能测试清单**

执行SQL后，测试以下功能：

### **充值功能：**
- [ ] 打开"我的" → 点击"💰 充值"
- [ ] 选择TRC20，应该显示地址：`TQTjfehUeHRWkw7QkcRKojWYdzYPebr9iS`
- [ ] 选择BEP20，应该显示地址：`0xc8288b98f7c2cc11bccbc033754effcc87c1909e`
- [ ] 查看提示："认真核对充值地址 / 30U起步 / AI自动审核 稍等片刻"

### **学习卡签到：**
- [ ] 打开"积分"页面
- [ ] 如果有学习卡，点击"签到"
- [ ] 应该成功签到，不再报错

### **管理后台：**
- [ ] 打开"充值管理"
- [ ] 应该能看到充值记录列表（即使是空的）

---

## ⚠️ **常见问题**

### **Q1: 执行SQL时报错 "already exists"**
**A:** 忽略即可，说明表已经存在了，继续执行下一步。

### **Q2: 执行后还是报错**
**A:** 
1. 清除浏览器缓存（Ctrl + Shift + Delete）
2. 强制刷新页面（Ctrl + F5）
3. 重新登录

### **Q3: 充值地址没有显示**
**A:** 确保执行了"充值配置SQL"（步骤4）

---

## 📊 **错误对照表**

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `Could not find the table 'public.checkin_records'` | 签到记录表不存在 | 执行修复SQL ✅ |
| `Could not find the table 'public.recharge_records'` | 充值记录表不存在 | 执行修复SQL ✅ |
| `404 (Not Found)` | 表或配置不存在 | 执行两个SQL ✅ |
| `400 (Bad Request)` | RLS策略问题 | 修复SQL已包含RLS策略 ✅ |

---

## 🚀 **执行顺序总结**

```
1. 登录Supabase ✅
   ↓
2. 打开SQL Editor ✅
   ↓
3. 执行修复SQL（创建表）✅
   ↓
4. 执行充值配置SQL ✅
   ↓
5. 刷新页面验证 ✅
```

---

**修复时间：** 约3-5分钟  
**执行后效果：** 所有控制台错误消失，功能正常 ✅


