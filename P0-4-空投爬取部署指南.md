# 🚀 P0-4: 空投爬取部署指南

## ✅ 代码状态

### 已完成的文件：

1. ✅ **`src/services/AirdropCrawlerService.ts`**
   - RSS 源配置（Binance、OKX、CoinMarketCap）
   - 自动解析空投信息
   - AI 评分算法
   - 自动推送到核心群

2. ✅ **`supabase/functions/auto-crawl-airdrops/index.ts`**
   - Edge Function 完整代码
   - Cron Job 触发支持
   - 手动API触发支持

3. ✅ **`supabase/migrations/setup_auto_crawl_cron.sql`**
   - Cron Job 配置 SQL

---

## 📋 部署步骤

### 第1步：部署 Supabase Edge Function

#### 方法A：使用 Supabase CLI（推荐）

```bash
# 1. 安装 Supabase CLI（如果没有）
npm install -g supabase

# 2. 登录 Supabase
supabase login

# 3. 链接到你的项目
supabase link --project-ref YOUR_PROJECT_ID

# 4. 部署 Edge Function
supabase functions deploy auto-crawl-airdrops
```

#### 方法B：使用 Supabase Dashboard

1. 打开：https://supabase.com/dashboard/project/YOUR_PROJECT_ID/functions
2. 点击 "Create a new function"
3. 函数名：`auto-crawl-airdrops`
4. 复制 `supabase/functions/auto-crawl-airdrops/index.ts` 的内容
5. 点击 "Deploy"

---

### 第2步：设置 Cron Job（每2小时自动爬取）

#### 方法A：使用 pg_cron（推荐）

在 Supabase SQL Editor 中执行：

```sql
-- 1. 启用 pg_cron 扩展（如果还没有）
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- 2. 创建定时任务（每2小时执行一次）
SELECT cron.schedule(
  'auto-crawl-airdrops',     -- 任务名称
  '0 */2 * * *',             -- Cron 表达式：每2小时的第0分钟
  $$
  SELECT
    net.http_post(
      url:='https://YOUR_PROJECT_ID.supabase.co/functions/v1/auto-crawl-airdrops',
      headers:='{"Authorization": "Bearer YOUR_SERVICE_ROLE_KEY"}'::jsonb,
      body:='{}'::jsonb
    ) AS request_id;
  $$
);

-- 3. 查看已创建的定时任务
SELECT * FROM cron.job;

-- 4. 查看执行历史
SELECT * FROM cron.job_run_details ORDER BY start_time DESC LIMIT 10;
```

**替换变量：**
- `YOUR_PROJECT_ID` - 你的 Supabase 项目 ID
- `YOUR_SERVICE_ROLE_KEY` - 你的 Service Role Key（在 Settings → API 中找到）

#### Cron 表达式说明：

```
'0 */2 * * *'  = 每2小时的第0分钟
 │  │  │ │ │
 │  │  │ │ └─ 星期几 (0-7, 0和7都代表星期日)
 │  │  │ └─── 月份 (1-12)
 │  │  └───── 日期 (1-31)
 │  └──────── 小时 (0-23, */2 表示每2小时)
 └─────────── 分钟 (0-59)
```

**其他常见配置：**
- `0 * * * *` - 每小时
- `0 */4 * * *` - 每4小时
- `0 8,20 * * *` - 每天8点和20点
- `*/30 * * * *` - 每30分钟

---

### 第3步：手动测试

#### 在浏览器中测试：

```bash
# 使用 curl 或 Postman
curl -X POST \
  https://YOUR_PROJECT_ID.supabase.co/functions/v1/auto-crawl-airdrops \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json"
```

#### 在管理后台中测试：

在 `src/views/admin/AirdropsView.vue` 中，点击"自动爬取"按钮：

```typescript
// 这个功能已经实现，直接调用
const autoCrawl = async () => {
  const result = await AirdropCrawlerService.crawlAll()
  
  if (result.success) {
    alert(`✅ 爬取完成！发现 ${result.data.totalNew} 条新空投`)
  }
}
```

---

### 第4步：验证推送到聊天群

1. 手动触发一次爬取
2. 检查 `airdrops` 表是否有新数据
3. 检查 `messages` 表是否有机器人推送的消息
4. 打开聊天页面，查看是否收到空投通知

```sql
-- 检查最新的空投
SELECT * FROM airdrops 
ORDER BY created_at DESC 
LIMIT 10;

-- 检查机器人推送的消息
SELECT * FROM messages 
WHERE is_bot = true 
ORDER BY created_at DESC 
LIMIT 10;
```

---

## 🔧 配置说明

### RSS 源配置

在 `src/services/AirdropCrawlerService.ts` 中：

```typescript
const RSS_FEEDS = [
  {
    name: '币安公告（空投/Launchpool）',
    url: 'https://www.binance.com/en/support/announcement/rss',
    exchange: 'binance',
    enabled: true,      // ✅ 启用此源
    autoPush: true      // ✅ 自动推送到核心群
  },
  {
    name: 'OKX（欧易）公告',
    url: 'https://www.okx.com/support/hc/en-us/articles/rss',
    exchange: 'okx',
    enabled: true,
    autoPush: true
  },
  {
    name: 'CoinMarketCap 空投',
    url: 'https://coinmarketcap.com/airdrop/rss.xml',
    exchange: 'coinmarketcap',
    enabled: true,
    autoPush: false     // ❌ 仅手动推送（质量参差不齐）
  }
]
```

**自定义配置：**
- `enabled: false` - 禁用某个源
- `autoPush: false` - 不自动推送，仅手动推送

---

### AI 评分算法

在 `extractAirdropInfo()` 中：

```typescript
// 基础分：5分
let aiScore = 5

// 交易所加分
if (exchange === 'binance') aiScore += 3  // 币安 +3分
else if (exchange === 'okx') aiScore += 2  // OKX +2分

// 有明确奖励金额 +1分
if (rewardsMatch) aiScore += 1

// 官方项目 +1分
if (title.toLowerCase().includes('official')) aiScore += 1

// 最高10分
return Math.min(aiScore, 10)
```

**自定义评分规则：**
你可以根据需要调整评分逻辑。

---

### 推送消息格式

在 `pushToChat()` 中：

```typescript
const message = `━━━━━━━━━━━━━━━━━━━━
🎁 ${autoPush ? '自动空投通知' : '新空投通知'}

【标题】${airdrop.title}
【交易所】${airdrop.exchange.toUpperCase()}
【奖励】${airdrop.rewards}
【AI评分】${airdrop.ai_score}/10

${airdrop.description ? `【说明】${airdrop.description.substring(0, 200)}...\n\n` : ''}${airdrop.url ? `【链接】${airdrop.url}\n\n` : ''}━━━━━━━━━━━━━━━━━━━━
💡 ${autoPush ? '每2小时自动爬取' : '手动推送'}，立即参与！
━━━━━━━━━━━━━━━━━━━━`
```

**自定义格式：**
你可以修改消息格式、添加表情符号等。

---

## 🐛 故障排查

### 问题1：Cron Job 没有执行

**检查：**
```sql
-- 查看任务状态
SELECT * FROM cron.job WHERE jobname = 'auto-crawl-airdrops';

-- 查看执行日志
SELECT * FROM cron.job_run_details 
WHERE jobid = (SELECT jobid FROM cron.job WHERE jobname = 'auto-crawl-airdrops')
ORDER BY start_time DESC 
LIMIT 10;
```

**解决：**
- 确保 `pg_cron` 扩展已启用
- 确保 Service Role Key 正确
- 确保 Edge Function URL 正确

---

### 问题2：RSS 解析失败

**原因：**
- RSS 源地址变更
- rss2json API 限流（免费版每天 10,000 次）

**解决：**
- 更换 RSS 源
- 使用自己的 RSS 解析服务
- 升级 rss2json Pro 版本

---

### 问题3：没有推送到聊天群

**检查：**
```sql
-- 检查是否有核心群
SELECT * FROM chat_groups WHERE type = 'default_hall' AND is_active = true;

-- 检查是否有机器人消息
SELECT * FROM messages WHERE is_bot = true ORDER BY created_at DESC LIMIT 5;
```

**解决：**
- 确保 `chat_groups` 表有 `type = 'default_hall'` 的群组
- 确保 `messages` 表允许 `user_id = null` 的插入

---

## 📊 监控和管理

### 在管理后台中：

1. **查看所有空投：**
   - 路径：`/admin/airdrops`
   - 功能：查看、编辑、删除空投信息

2. **手动触发爬取：**
   - 点击"自动爬取"按钮
   - 实时查看爬取结果

3. **手动推送到群聊：**
   - 选择空投
   - 点击"推送到群聊"
   - 选择目标群组

---

## ✅ 功能清单

### 已实现功能：

- ✅ RSS 源配置（Binance、OKX、CoinMarketCap）
- ✅ 自动解析空投信息
- ✅ AI 评分（1-10分）
- ✅ 去重（URL 唯一性）
- ✅ 自动推送到核心群
- ✅ 手动推送到指定群组
- ✅ Cron Job 定时爬取
- ✅ 管理后台界面
- ✅ 错误处理和日志

### 可扩展功能：

- ⏳ 添加更多 RSS 源
- ⏳ 更智能的 AI 评分
- ⏳ 用户订阅特定交易所
- ⏳ 邮件/短信通知
- ⏳ 自动参与空投（API集成）

---

## 🎉 部署完成检查清单

- [ ] Edge Function 已部署
- [ ] Cron Job 已配置
- [ ] 手动测试成功
- [ ] 消息推送到聊天群
- [ ] 管理后台可用
- [ ] RSS 源正常工作
- [ ] AI 评分合理
- [ ] 执行日志正常

---

## 🔄 维护建议

### 每周检查：
1. 查看 Cron Job 执行日志
2. 检查是否有新空投
3. 验证 RSS 源是否正常

### 每月检查：
1. 更新 RSS 源列表
2. 优化 AI 评分算法
3. 清理过期空投数据

```sql
-- 清理30天前的过期空投
DELETE FROM airdrops 
WHERE end_date < NOW() - INTERVAL '30 days';
```

---

**🎊 P0-4 部署指南完成！**

下一步：使用此指南部署 Edge Function 和配置 Cron Job。

