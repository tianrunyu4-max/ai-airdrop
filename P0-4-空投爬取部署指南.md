# ğŸš€ P0-4: ç©ºæŠ•çˆ¬å–éƒ¨ç½²æŒ‡å—

## âœ… ä»£ç çŠ¶æ€

### å·²å®Œæˆçš„æ–‡ä»¶ï¼š

1. âœ… **`src/services/AirdropCrawlerService.ts`**
   - RSS æºé…ç½®ï¼ˆBinanceã€OKXã€CoinMarketCapï¼‰
   - è‡ªåŠ¨è§£æç©ºæŠ•ä¿¡æ¯
   - AI è¯„åˆ†ç®—æ³•
   - è‡ªåŠ¨æ¨é€åˆ°æ ¸å¿ƒç¾¤

2. âœ… **`supabase/functions/auto-crawl-airdrops/index.ts`**
   - Edge Function å®Œæ•´ä»£ç 
   - Cron Job è§¦å‘æ”¯æŒ
   - æ‰‹åŠ¨APIè§¦å‘æ”¯æŒ

3. âœ… **`supabase/migrations/setup_auto_crawl_cron.sql`**
   - Cron Job é…ç½® SQL

---

## ğŸ“‹ éƒ¨ç½²æ­¥éª¤

### ç¬¬1æ­¥ï¼šéƒ¨ç½² Supabase Edge Function

#### æ–¹æ³•Aï¼šä½¿ç”¨ Supabase CLIï¼ˆæ¨èï¼‰

```bash
# 1. å®‰è£… Supabase CLIï¼ˆå¦‚æœæ²¡æœ‰ï¼‰
npm install -g supabase

# 2. ç™»å½• Supabase
supabase login

# 3. é“¾æ¥åˆ°ä½ çš„é¡¹ç›®
supabase link --project-ref YOUR_PROJECT_ID

# 4. éƒ¨ç½² Edge Function
supabase functions deploy auto-crawl-airdrops
```

#### æ–¹æ³•Bï¼šä½¿ç”¨ Supabase Dashboard

1. æ‰“å¼€ï¼šhttps://supabase.com/dashboard/project/YOUR_PROJECT_ID/functions
2. ç‚¹å‡» "Create a new function"
3. å‡½æ•°åï¼š`auto-crawl-airdrops`
4. å¤åˆ¶ `supabase/functions/auto-crawl-airdrops/index.ts` çš„å†…å®¹
5. ç‚¹å‡» "Deploy"

---

### ç¬¬2æ­¥ï¼šè®¾ç½® Cron Jobï¼ˆæ¯2å°æ—¶è‡ªåŠ¨çˆ¬å–ï¼‰

#### æ–¹æ³•Aï¼šä½¿ç”¨ pg_cronï¼ˆæ¨èï¼‰

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
-- 1. å¯ç”¨ pg_cron æ‰©å±•ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- 2. åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼ˆæ¯2å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼‰
SELECT cron.schedule(
  'auto-crawl-airdrops',     -- ä»»åŠ¡åç§°
  '0 */2 * * *',             -- Cron è¡¨è¾¾å¼ï¼šæ¯2å°æ—¶çš„ç¬¬0åˆ†é’Ÿ
  $$
  SELECT
    net.http_post(
      url:='https://YOUR_PROJECT_ID.supabase.co/functions/v1/auto-crawl-airdrops',
      headers:='{"Authorization": "Bearer YOUR_SERVICE_ROLE_KEY"}'::jsonb,
      body:='{}'::jsonb
    ) AS request_id;
  $$
);

-- 3. æŸ¥çœ‹å·²åˆ›å»ºçš„å®šæ—¶ä»»åŠ¡
SELECT * FROM cron.job;

-- 4. æŸ¥çœ‹æ‰§è¡Œå†å²
SELECT * FROM cron.job_run_details ORDER BY start_time DESC LIMIT 10;
```

**æ›¿æ¢å˜é‡ï¼š**
- `YOUR_PROJECT_ID` - ä½ çš„ Supabase é¡¹ç›® ID
- `YOUR_SERVICE_ROLE_KEY` - ä½ çš„ Service Role Keyï¼ˆåœ¨ Settings â†’ API ä¸­æ‰¾åˆ°ï¼‰

#### Cron è¡¨è¾¾å¼è¯´æ˜ï¼š

```
'0 */2 * * *'  = æ¯2å°æ—¶çš„ç¬¬0åˆ†é’Ÿ
 â”‚  â”‚  â”‚ â”‚ â”‚
 â”‚  â”‚  â”‚ â”‚ â””â”€ æ˜ŸæœŸå‡  (0-7, 0å’Œ7éƒ½ä»£è¡¨æ˜ŸæœŸæ—¥)
 â”‚  â”‚  â”‚ â””â”€â”€â”€ æœˆä»½ (1-12)
 â”‚  â”‚  â””â”€â”€â”€â”€â”€ æ—¥æœŸ (1-31)
 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0-23, */2 è¡¨ç¤ºæ¯2å°æ—¶)
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0-59)
```

**å…¶ä»–å¸¸è§é…ç½®ï¼š**
- `0 * * * *` - æ¯å°æ—¶
- `0 */4 * * *` - æ¯4å°æ—¶
- `0 8,20 * * *` - æ¯å¤©8ç‚¹å’Œ20ç‚¹
- `*/30 * * * *` - æ¯30åˆ†é’Ÿ

---

### ç¬¬3æ­¥ï¼šæ‰‹åŠ¨æµ‹è¯•

#### åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•ï¼š

```bash
# ä½¿ç”¨ curl æˆ– Postman
curl -X POST \
  https://YOUR_PROJECT_ID.supabase.co/functions/v1/auto-crawl-airdrops \
  -H "Authorization: Bearer YOUR_ANON_KEY" \
  -H "Content-Type: application/json"
```

#### åœ¨ç®¡ç†åå°ä¸­æµ‹è¯•ï¼š

åœ¨ `src/views/admin/AirdropsView.vue` ä¸­ï¼Œç‚¹å‡»"è‡ªåŠ¨çˆ¬å–"æŒ‰é’®ï¼š

```typescript
// è¿™ä¸ªåŠŸèƒ½å·²ç»å®ç°ï¼Œç›´æ¥è°ƒç”¨
const autoCrawl = async () => {
  const result = await AirdropCrawlerService.crawlAll()
  
  if (result.success) {
    alert(`âœ… çˆ¬å–å®Œæˆï¼å‘ç° ${result.data.totalNew} æ¡æ–°ç©ºæŠ•`)
  }
}
```

---

### ç¬¬4æ­¥ï¼šéªŒè¯æ¨é€åˆ°èŠå¤©ç¾¤

1. æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡çˆ¬å–
2. æ£€æŸ¥ `airdrops` è¡¨æ˜¯å¦æœ‰æ–°æ•°æ®
3. æ£€æŸ¥ `messages` è¡¨æ˜¯å¦æœ‰æœºå™¨äººæ¨é€çš„æ¶ˆæ¯
4. æ‰“å¼€èŠå¤©é¡µé¢ï¼ŒæŸ¥çœ‹æ˜¯å¦æ”¶åˆ°ç©ºæŠ•é€šçŸ¥

```sql
-- æ£€æŸ¥æœ€æ–°çš„ç©ºæŠ•
SELECT * FROM airdrops 
ORDER BY created_at DESC 
LIMIT 10;

-- æ£€æŸ¥æœºå™¨äººæ¨é€çš„æ¶ˆæ¯
SELECT * FROM messages 
WHERE is_bot = true 
ORDER BY created_at DESC 
LIMIT 10;
```

---

## ğŸ”§ é…ç½®è¯´æ˜

### RSS æºé…ç½®

åœ¨ `src/services/AirdropCrawlerService.ts` ä¸­ï¼š

```typescript
const RSS_FEEDS = [
  {
    name: 'å¸å®‰å…¬å‘Šï¼ˆç©ºæŠ•/Launchpoolï¼‰',
    url: 'https://www.binance.com/en/support/announcement/rss',
    exchange: 'binance',
    enabled: true,      // âœ… å¯ç”¨æ­¤æº
    autoPush: true      // âœ… è‡ªåŠ¨æ¨é€åˆ°æ ¸å¿ƒç¾¤
  },
  {
    name: 'OKXï¼ˆæ¬§æ˜“ï¼‰å…¬å‘Š',
    url: 'https://www.okx.com/support/hc/en-us/articles/rss',
    exchange: 'okx',
    enabled: true,
    autoPush: true
  },
  {
    name: 'CoinMarketCap ç©ºæŠ•',
    url: 'https://coinmarketcap.com/airdrop/rss.xml',
    exchange: 'coinmarketcap',
    enabled: true,
    autoPush: false     // âŒ ä»…æ‰‹åŠ¨æ¨é€ï¼ˆè´¨é‡å‚å·®ä¸é½ï¼‰
  }
]
```

**è‡ªå®šä¹‰é…ç½®ï¼š**
- `enabled: false` - ç¦ç”¨æŸä¸ªæº
- `autoPush: false` - ä¸è‡ªåŠ¨æ¨é€ï¼Œä»…æ‰‹åŠ¨æ¨é€

---

### AI è¯„åˆ†ç®—æ³•

åœ¨ `extractAirdropInfo()` ä¸­ï¼š

```typescript
// åŸºç¡€åˆ†ï¼š5åˆ†
let aiScore = 5

// äº¤æ˜“æ‰€åŠ åˆ†
if (exchange === 'binance') aiScore += 3  // å¸å®‰ +3åˆ†
else if (exchange === 'okx') aiScore += 2  // OKX +2åˆ†

// æœ‰æ˜ç¡®å¥–åŠ±é‡‘é¢ +1åˆ†
if (rewardsMatch) aiScore += 1

// å®˜æ–¹é¡¹ç›® +1åˆ†
if (title.toLowerCase().includes('official')) aiScore += 1

// æœ€é«˜10åˆ†
return Math.min(aiScore, 10)
```

**è‡ªå®šä¹‰è¯„åˆ†è§„åˆ™ï¼š**
ä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´è¯„åˆ†é€»è¾‘ã€‚

---

### æ¨é€æ¶ˆæ¯æ ¼å¼

åœ¨ `pushToChat()` ä¸­ï¼š

```typescript
const message = `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ ${autoPush ? 'è‡ªåŠ¨ç©ºæŠ•é€šçŸ¥' : 'æ–°ç©ºæŠ•é€šçŸ¥'}

ã€æ ‡é¢˜ã€‘${airdrop.title}
ã€äº¤æ˜“æ‰€ã€‘${airdrop.exchange.toUpperCase()}
ã€å¥–åŠ±ã€‘${airdrop.rewards}
ã€AIè¯„åˆ†ã€‘${airdrop.ai_score}/10

${airdrop.description ? `ã€è¯´æ˜ã€‘${airdrop.description.substring(0, 200)}...\n\n` : ''}${airdrop.url ? `ã€é“¾æ¥ã€‘${airdrop.url}\n\n` : ''}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ’¡ ${autoPush ? 'æ¯2å°æ—¶è‡ªåŠ¨çˆ¬å–' : 'æ‰‹åŠ¨æ¨é€'}ï¼Œç«‹å³å‚ä¸ï¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`
```

**è‡ªå®šä¹‰æ ¼å¼ï¼š**
ä½ å¯ä»¥ä¿®æ”¹æ¶ˆæ¯æ ¼å¼ã€æ·»åŠ è¡¨æƒ…ç¬¦å·ç­‰ã€‚

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šCron Job æ²¡æœ‰æ‰§è¡Œ

**æ£€æŸ¥ï¼š**
```sql
-- æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€
SELECT * FROM cron.job WHERE jobname = 'auto-crawl-airdrops';

-- æŸ¥çœ‹æ‰§è¡Œæ—¥å¿—
SELECT * FROM cron.job_run_details 
WHERE jobid = (SELECT jobid FROM cron.job WHERE jobname = 'auto-crawl-airdrops')
ORDER BY start_time DESC 
LIMIT 10;
```

**è§£å†³ï¼š**
- ç¡®ä¿ `pg_cron` æ‰©å±•å·²å¯ç”¨
- ç¡®ä¿ Service Role Key æ­£ç¡®
- ç¡®ä¿ Edge Function URL æ­£ç¡®

---

### é—®é¢˜2ï¼šRSS è§£æå¤±è´¥

**åŸå› ï¼š**
- RSS æºåœ°å€å˜æ›´
- rss2json API é™æµï¼ˆå…è´¹ç‰ˆæ¯å¤© 10,000 æ¬¡ï¼‰

**è§£å†³ï¼š**
- æ›´æ¢ RSS æº
- ä½¿ç”¨è‡ªå·±çš„ RSS è§£ææœåŠ¡
- å‡çº§ rss2json Pro ç‰ˆæœ¬

---

### é—®é¢˜3ï¼šæ²¡æœ‰æ¨é€åˆ°èŠå¤©ç¾¤

**æ£€æŸ¥ï¼š**
```sql
-- æ£€æŸ¥æ˜¯å¦æœ‰æ ¸å¿ƒç¾¤
SELECT * FROM chat_groups WHERE type = 'default_hall' AND is_active = true;

-- æ£€æŸ¥æ˜¯å¦æœ‰æœºå™¨äººæ¶ˆæ¯
SELECT * FROM messages WHERE is_bot = true ORDER BY created_at DESC LIMIT 5;
```

**è§£å†³ï¼š**
- ç¡®ä¿ `chat_groups` è¡¨æœ‰ `type = 'default_hall'` çš„ç¾¤ç»„
- ç¡®ä¿ `messages` è¡¨å…è®¸ `user_id = null` çš„æ’å…¥

---

## ğŸ“Š ç›‘æ§å’Œç®¡ç†

### åœ¨ç®¡ç†åå°ä¸­ï¼š

1. **æŸ¥çœ‹æ‰€æœ‰ç©ºæŠ•ï¼š**
   - è·¯å¾„ï¼š`/admin/airdrops`
   - åŠŸèƒ½ï¼šæŸ¥çœ‹ã€ç¼–è¾‘ã€åˆ é™¤ç©ºæŠ•ä¿¡æ¯

2. **æ‰‹åŠ¨è§¦å‘çˆ¬å–ï¼š**
   - ç‚¹å‡»"è‡ªåŠ¨çˆ¬å–"æŒ‰é’®
   - å®æ—¶æŸ¥çœ‹çˆ¬å–ç»“æœ

3. **æ‰‹åŠ¨æ¨é€åˆ°ç¾¤èŠï¼š**
   - é€‰æ‹©ç©ºæŠ•
   - ç‚¹å‡»"æ¨é€åˆ°ç¾¤èŠ"
   - é€‰æ‹©ç›®æ ‡ç¾¤ç»„

---

## âœ… åŠŸèƒ½æ¸…å•

### å·²å®ç°åŠŸèƒ½ï¼š

- âœ… RSS æºé…ç½®ï¼ˆBinanceã€OKXã€CoinMarketCapï¼‰
- âœ… è‡ªåŠ¨è§£æç©ºæŠ•ä¿¡æ¯
- âœ… AI è¯„åˆ†ï¼ˆ1-10åˆ†ï¼‰
- âœ… å»é‡ï¼ˆURL å”¯ä¸€æ€§ï¼‰
- âœ… è‡ªåŠ¨æ¨é€åˆ°æ ¸å¿ƒç¾¤
- âœ… æ‰‹åŠ¨æ¨é€åˆ°æŒ‡å®šç¾¤ç»„
- âœ… Cron Job å®šæ—¶çˆ¬å–
- âœ… ç®¡ç†åå°ç•Œé¢
- âœ… é”™è¯¯å¤„ç†å’Œæ—¥å¿—

### å¯æ‰©å±•åŠŸèƒ½ï¼š

- â³ æ·»åŠ æ›´å¤š RSS æº
- â³ æ›´æ™ºèƒ½çš„ AI è¯„åˆ†
- â³ ç”¨æˆ·è®¢é˜…ç‰¹å®šäº¤æ˜“æ‰€
- â³ é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥
- â³ è‡ªåŠ¨å‚ä¸ç©ºæŠ•ï¼ˆAPIé›†æˆï¼‰

---

## ğŸ‰ éƒ¨ç½²å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] Edge Function å·²éƒ¨ç½²
- [ ] Cron Job å·²é…ç½®
- [ ] æ‰‹åŠ¨æµ‹è¯•æˆåŠŸ
- [ ] æ¶ˆæ¯æ¨é€åˆ°èŠå¤©ç¾¤
- [ ] ç®¡ç†åå°å¯ç”¨
- [ ] RSS æºæ­£å¸¸å·¥ä½œ
- [ ] AI è¯„åˆ†åˆç†
- [ ] æ‰§è¡Œæ—¥å¿—æ­£å¸¸

---

## ğŸ”„ ç»´æŠ¤å»ºè®®

### æ¯å‘¨æ£€æŸ¥ï¼š
1. æŸ¥çœ‹ Cron Job æ‰§è¡Œæ—¥å¿—
2. æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç©ºæŠ•
3. éªŒè¯ RSS æºæ˜¯å¦æ­£å¸¸

### æ¯æœˆæ£€æŸ¥ï¼š
1. æ›´æ–° RSS æºåˆ—è¡¨
2. ä¼˜åŒ– AI è¯„åˆ†ç®—æ³•
3. æ¸…ç†è¿‡æœŸç©ºæŠ•æ•°æ®

```sql
-- æ¸…ç†30å¤©å‰çš„è¿‡æœŸç©ºæŠ•
DELETE FROM airdrops 
WHERE end_date < NOW() - INTERVAL '30 days';
```

---

**ğŸŠ P0-4 éƒ¨ç½²æŒ‡å—å®Œæˆï¼**

ä¸‹ä¸€æ­¥ï¼šä½¿ç”¨æ­¤æŒ‡å—éƒ¨ç½² Edge Function å’Œé…ç½® Cron Jobã€‚

