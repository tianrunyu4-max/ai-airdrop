# ğŸ è§å•å¥–åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

**è§å•å¥–ï¼ˆOrder Bonusï¼‰**ï¼šç›´æ¨å…³ç³»é“¾5å±‚ï¼Œä¸‹çº¿æ¯æ¬¡å¯¹ç¢°æˆåŠŸï¼Œä¸Šçº§ç›´æ¨é“¾çš„5ä¸ªäººå„è·å¾—1Uå¥–åŠ±ã€‚

---

## ğŸ¯ å¥–åŠ±è§„åˆ™

### åŸºæœ¬è§„åˆ™

- **å±‚çº§æ•°é‡**ï¼š5å±‚ç›´æ¨å…³ç³»é“¾
- **è§¦å‘æ¡ä»¶**ï¼šä¸‹çº¿å¯¹ç¢°æˆåŠŸ
- **å¥–åŠ±é‡‘é¢**ï¼šæ¯å±‚1U Ã— å¯¹ç¢°ç»„æ•°
- **å‘æ”¾å¯¹è±¡**ï¼šç›´æ¨ä¸Šçº§ï¼ˆä¸æ˜¯Binaryæ ‘ä¸Šçº§ï¼‰

### ç¤ºä¾‹è¯´æ˜

```
A (åˆ›ä¸–äºº)
â”œâ”€ B (Açš„ç›´æ¨)
   â”œâ”€ C (Bçš„ç›´æ¨)
      â”œâ”€ D (Cçš„ç›´æ¨)
         â”œâ”€ E (Dçš„ç›´æ¨)
            â”œâ”€ F (Eçš„ç›´æ¨)
               â””â”€ G (Fçš„ç›´æ¨)
```

**åœºæ™¯1ï¼šGå¯¹ç¢°1ç»„**
```
G å¯¹ç¢°1ç»„æˆåŠŸ â†’
  F è·å¾— 1U (ç¬¬1å±‚)
  E è·å¾— 1U (ç¬¬2å±‚)
  D è·å¾— 1U (ç¬¬3å±‚)
  C è·å¾— 1U (ç¬¬4å±‚)
  B è·å¾— 1U (ç¬¬5å±‚)
  A ä¸è·å¾—ï¼ˆè¶…è¿‡5å±‚ï¼‰
  
æ€»å‘æ”¾ï¼š5U
```

**åœºæ™¯2ï¼šGå¯¹ç¢°3ç»„**
```
G å¯¹ç¢°3ç»„æˆåŠŸ â†’
  F è·å¾— 3U (ç¬¬1å±‚ï¼Œ3ç»„ Ã— 1U)
  E è·å¾— 3U (ç¬¬2å±‚ï¼Œ3ç»„ Ã— 1U)
  D è·å¾— 3U (ç¬¬3å±‚ï¼Œ3ç»„ Ã— 1U)
  C è·å¾— 3U (ç¬¬4å±‚ï¼Œ3ç»„ Ã— 1U)
  B è·å¾— 3U (ç¬¬5å±‚ï¼Œ3ç»„ Ã— 1U)
  
æ€»å‘æ”¾ï¼š15U
```

**åœºæ™¯3ï¼šEå¯¹ç¢°2ç»„**
```
E å¯¹ç¢°2ç»„æˆåŠŸ â†’
  D è·å¾— 2U (ç¬¬1å±‚)
  C è·å¾— 2U (ç¬¬2å±‚)
  B è·å¾— 2U (ç¬¬3å±‚)
  A è·å¾— 2U (ç¬¬4å±‚)
  (æ²¡æœ‰ç¬¬5å±‚ä¸Šçº§)
  
æ€»å‘æ”¾ï¼š8U
```

---

## ğŸ’» æŠ€æœ¯å®ç°

### 1. ä»£ç ä½ç½®

**æ–‡ä»¶ï¼š** `src/services/BinaryService.ts`

**å‡½æ•°ï¼š** `triggerOrderBonus(triggerId: string, pairsCount: number)`

### 2. è°ƒç”¨æ—¶æœº

åœ¨ `calculatePairing()` å‡½æ•°ä¸­ï¼Œå¯¹ç¢°å¥–åŠ±å‘æ”¾åï¼š

```typescript
// å‘æ”¾å¯¹ç¢°å¥–
await WalletManager.add(userId, pairingBonus, ...)

// è§¦å‘å¹³çº§å¥–åŠ±
await this.triggerLevelBonus(userId, pairsCount)

// ğŸ è§¦å‘è§å•å¥–ï¼ˆæ–°å¢ï¼‰
await this.triggerOrderBonus(userId, pairsCount)

// æ£€æŸ¥å¤æŠ•
await this.checkReinvestRequired(userId)
```

### 3. æ ¸å¿ƒä»£ç 

```typescript
/**
 * ğŸ è§¦å‘è§å•å¥–ï¼ˆç›´æ¨é“¾5å±‚ï¼Œæ¯å±‚1Uï¼‰
 */
private static async triggerOrderBonus(
  triggerId: string,
  pairsCount: number
): Promise<void> {
  const ORDER_BONUS_DEPTH = 5  // 5å±‚
  const ORDER_BONUS_PER_PAIR = 1  // æ¯ç»„1U

  // è·å–è§¦å‘è€…ä¿¡æ¯
  const { data: triggerUser } = await supabase
    .from('users')
    .select('id, username, inviter_id')
    .eq('id', triggerId)
    .single()

  if (!triggerUser?.inviter_id) return

  // å‘ä¸Šè¿½æº¯5å±‚ç›´æ¨é“¾
  let currentUserId = triggerUser.inviter_id
  let generation = 1

  while (currentUserId && generation <= ORDER_BONUS_DEPTH) {
    const { data: upline } = await supabase
      .from('users')
      .select('id, username, inviter_id')
      .eq('id', currentUserId)
      .single()

    if (!upline) break

    // å‘æ”¾å¥–åŠ±
    const orderBonus = ORDER_BONUS_PER_PAIR * pairsCount

    await WalletManager.add(
      upline.id,
      orderBonus,
      'order_bonus',
      `è§å•å¥–ï¼ˆç¬¬${generation}å±‚ï¼‰ï¼šä¸‹çº¿${triggerUser.username}å¯¹ç¢°${pairsCount}ç»„ Ã— 1U`
    )

    // è®°å½•åˆ° order_bonuses è¡¨
    await supabase.from('order_bonuses').insert({
      user_id: upline.id,
      trigger_user_id: triggerUser.id,
      generation: generation,
      pairs: pairsCount,
      amount: orderBonus,
      trigger_username: triggerUser.username
    })

    // æ›´æ–°ç»Ÿè®¡
    await supabase
      .from('binary_members')
      .update({
        total_order_bonus: supabase.raw(`COALESCE(total_order_bonus, 0) + ${orderBonus}`),
        total_earnings: supabase.raw(`total_earnings + ${orderBonus}`)
      })
      .eq('user_id', upline.id)

    // ç»§ç»­å‘ä¸Š
    currentUserId = upline.inviter_id
    generation++
  }
}
```

---

## ğŸ—„ï¸ æ•°æ®åº“å˜æ›´

### 1. binary_members è¡¨æ·»åŠ å­—æ®µ

```sql
ALTER TABLE binary_members
ADD COLUMN IF NOT EXISTS total_order_bonus DECIMAL(10, 2) DEFAULT 0 NOT NULL;

COMMENT ON COLUMN binary_members.total_order_bonus IS 'è§å•å¥–æ€»é¢';
```

### 2. åˆ›å»º order_bonuses è¡¨

```sql
CREATE TABLE order_bonuses (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id),
  trigger_user_id UUID NOT NULL REFERENCES users(id),
  generation INT NOT NULL CHECK (generation >= 1 AND generation <= 5),
  pairs INT NOT NULL DEFAULT 1,
  amount DECIMAL(10, 2) NOT NULL DEFAULT 1.00,
  trigger_username VARCHAR(255),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_order_bonuses_user_id ON order_bonuses(user_id);
CREATE INDEX idx_order_bonuses_trigger_user_id ON order_bonuses(trigger_user_id);
```

**å­—æ®µè¯´æ˜ï¼š**
- `user_id`: è·å¾—å¥–åŠ±çš„ç”¨æˆ·
- `trigger_user_id`: è§¦å‘å¯¹ç¢°çš„ä¸‹çº¿ç”¨æˆ·
- `generation`: å±‚çº§ï¼ˆ1-5ï¼‰
- `pairs`: å¯¹ç¢°ç»„æ•°
- `amount`: å¥–åŠ±é‡‘é¢
- `trigger_username`: è§¦å‘è€…ç”¨æˆ·åï¼ˆä¾¿äºæŸ¥è¯¢ï¼‰

---

## ğŸ“Š æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥çœ‹æŸç”¨æˆ·çš„è§å•å¥–è®°å½•

```sql
SELECT 
  ob.id,
  ob.generation AS å±‚çº§,
  ob.trigger_username AS è§¦å‘è€…,
  ob.pairs AS å¯¹ç¢°ç»„æ•°,
  ob.amount AS å¥–åŠ±é‡‘é¢,
  ob.created_at AS è·å¾—æ—¶é—´
FROM order_bonuses ob
WHERE ob.user_id = 'USER_ID'
ORDER BY ob.created_at DESC
LIMIT 20;
```

### æŸ¥çœ‹æŸç”¨æˆ·è§¦å‘çš„è§å•å¥–ï¼ˆç»™äº†å¤šå°‘äººï¼‰

```sql
SELECT 
  u.username AS è·å¾—è€…,
  ob.generation AS å±‚çº§,
  ob.pairs AS å¯¹ç¢°ç»„æ•°,
  ob.amount AS å¥–åŠ±é‡‘é¢,
  ob.created_at AS æ—¶é—´
FROM order_bonuses ob
JOIN users u ON ob.user_id = u.id
WHERE ob.trigger_user_id = 'USER_ID'
ORDER BY ob.generation ASC, ob.created_at DESC;
```

### ç»Ÿè®¡è§å•å¥–æ€»é¢

```sql
SELECT 
  user_id,
  COUNT(*) AS è·å¾—æ¬¡æ•°,
  SUM(amount) AS æ€»é‡‘é¢,
  AVG(generation) AS å¹³å‡å±‚çº§
FROM order_bonuses
GROUP BY user_id
ORDER BY SUM(amount) DESC
LIMIT 10;
```

---

## ğŸ’° æ”¶ç›Šå¯¹æ¯”

### æ—§ç³»ç»Ÿï¼ˆæ— è§å•å¥–ï¼‰

```
ç”¨æˆ·Aç›´æ¨B, Bç›´æ¨C, Cå¯¹ç¢°1ç»„ï¼š
- Cè·å¾—ï¼š8.5U (å¯¹ç¢°å¥–)
- Bè·å¾—ï¼š0U (æ— è§å•å¥–)
- Aè·å¾—ï¼š0U (æ— è§å•å¥–)
```

### æ–°ç³»ç»Ÿï¼ˆæœ‰è§å•å¥–ï¼‰

```
ç”¨æˆ·Aç›´æ¨B, Bç›´æ¨C, Cå¯¹ç¢°1ç»„ï¼š
- Cè·å¾—ï¼š8.5U (å¯¹ç¢°å¥–)
- Bè·å¾—ï¼š1U (è§å•å¥–ç¬¬1å±‚)
- Aè·å¾—ï¼š1U (è§å•å¥–ç¬¬2å±‚)

æ€»å‘æ”¾ï¼š10.5U
```

### 5å±‚å®Œæ•´ç¤ºä¾‹

```
Aâ†’Bâ†’Câ†’Dâ†’Eâ†’F (6äººç›´æ¨é“¾)
F å¯¹ç¢°10ç»„ï¼š

Fçš„æ”¶ç›Šï¼š
- å¯¹ç¢°å¥–ï¼š85U (10ç»„ Ã— 8.5U)
- è§å•å¥–ï¼š0U

Eçš„æ”¶ç›Šï¼š
- è§å•å¥–ï¼š10U (ç¬¬1å±‚)

Dçš„æ”¶ç›Šï¼š
- è§å•å¥–ï¼š10U (ç¬¬2å±‚)

Cçš„æ”¶ç›Šï¼š
- è§å•å¥–ï¼š10U (ç¬¬3å±‚)

Bçš„æ”¶ç›Šï¼š
- è§å•å¥–ï¼š10U (ç¬¬4å±‚)

Açš„æ”¶ç›Šï¼š
- è§å•å¥–ï¼š10U (ç¬¬5å±‚)

æ€»å‘æ”¾ï¼š
- å¯¹ç¢°å¥–ï¼š85U
- è§å•å¥–ï¼š50U (5äºº Ã— 10U)
- åˆè®¡ï¼š135U
```

---

## ğŸ¯ ä¸šåŠ¡ä»·å€¼

### 1. æ¿€åŠ±æ¨å¹¿

- æ¨å¹¿æ›´å¤šä¸‹çº¿ = æ›´å¤šè§å•å¥–æœºä¼š
- 5å±‚æ·±åº¦é¼“åŠ±å›¢é˜Ÿè£‚å˜
- è¢«åŠ¨æ”¶å…¥ï¼Œèººèµšæ¨¡å¼

### 2. å¢å¼ºç²˜æ€§

- ä¸Šçº§å…³å¿ƒä¸‹çº§ä¸šç»©ï¼ˆå› ä¸ºæœ‰è§å•å¥–ï¼‰
- ä¸»åŠ¨å¸®åŠ©ä¸‹çº§æˆé•¿
- å›¢é˜Ÿæ°›å›´æ›´å¥½

### 3. å…¬å¹³åˆ†é…

- ä¸åŒºåˆ†A/BåŒºï¼Œåªçœ‹ç›´æ¨å…³ç³»
- æ¯å±‚å¥–åŠ±ç›¸åŒï¼ˆ1Uï¼‰
- ç®€å•é€æ˜

---

## âš™ï¸ é…ç½®å‚æ•°

### å½“å‰é…ç½®

```typescript
const ORDER_BONUS_DEPTH = 5  // ç›´æ¨é“¾å±‚æ•°
const ORDER_BONUS_PER_PAIR = 1  // æ¯ç»„æ¯å±‚å¥–åŠ±ï¼ˆUï¼‰
```

### å¯è°ƒæ•´é¡¹

å¦‚æœéœ€è¦ä¿®æ”¹é…ç½®ï¼Œåœ¨ `triggerOrderBonus()` å‡½æ•°ä¸­ï¼š

1. **ä¿®æ”¹å±‚æ•°**ï¼š
   ```typescript
   const ORDER_BONUS_DEPTH = 3  // æ”¹ä¸º3å±‚
   ```

2. **ä¿®æ”¹å¥–åŠ±**ï¼š
   ```typescript
   const ORDER_BONUS_PER_PAIR = 0.5  // æ”¹ä¸ºæ¯å±‚0.5U
   ```

3. **æ·»åŠ æ¡ä»¶**ï¼š
   ```typescript
   // ä¾‹å¦‚ï¼šéœ€è¦ç›´æ¨â‰¥2äººæ‰èƒ½è·å¾—è§å•å¥–
   if (upline.direct_referral_count < 2) {
     continue // è·³è¿‡ä¸ç¬¦åˆæ¡ä»¶çš„ä¸Šçº§
   }
   ```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. å‡†å¤‡æµ‹è¯•æ•°æ®

```sql
-- åˆ›å»ºæµ‹è¯•ç”¨æˆ·é“¾
-- A â†’ B â†’ C â†’ D â†’ E â†’ F

-- æ³¨å†Œç”¨æˆ·Aï¼ˆåˆ›ä¸–äººï¼‰
-- æ³¨å†Œç”¨æˆ·Bï¼ˆé‚€è¯·äººï¼šAï¼‰
-- æ³¨å†Œç”¨æˆ·Cï¼ˆé‚€è¯·äººï¼šBï¼‰
-- æ³¨å†Œç”¨æˆ·Dï¼ˆé‚€è¯·äººï¼šCï¼‰
-- æ³¨å†Œç”¨æˆ·Eï¼ˆé‚€è¯·äººï¼šDï¼‰
-- æ³¨å†Œç”¨æˆ·Fï¼ˆé‚€è¯·äººï¼šEï¼‰
```

### 2. è§¦å‘å¯¹ç¢°

```typescript
// è®©Fè´­ä¹°AIå­¦ä¹ å¡ï¼ˆåŠ å…¥Binaryç³»ç»Ÿï¼‰
// è§¦å‘Fçš„å¯¹ç¢°ï¼ˆæ‰‹åŠ¨æˆ–è‡ªåŠ¨ï¼‰
await BinaryService.calculatePairing('F_USER_ID')
```

### 3. éªŒè¯ç»“æœ

```sql
-- æŸ¥çœ‹Fçš„å¯¹ç¢°å¥–
SELECT * FROM pairing_bonuses WHERE user_id = 'F_USER_ID';

-- æŸ¥çœ‹è§å•å¥–è®°å½•
SELECT * FROM order_bonuses WHERE trigger_user_id = 'F_USER_ID';

-- æŸ¥çœ‹E, D, C, B, Açš„ä½™é¢å˜åŒ–
SELECT username, u_balance FROM users 
WHERE id IN ('E_ID', 'D_ID', 'C_ID', 'B_ID', 'A_ID');
```

**é¢„æœŸç»“æœï¼š**
- F: è·å¾—å¯¹ç¢°å¥–8.5Uï¼ˆæˆ–æ›´å¤šï¼‰
- E: è·å¾—è§å•å¥–1U
- D: è·å¾—è§å•å¥–1U
- C: è·å¾—è§å•å¥–1U
- B: è·å¾—è§å•å¥–1U
- A: è·å¾—è§å•å¥–1U

---

## ğŸ“ éƒ¨ç½²æ­¥éª¤

### 1. æ‰§è¡Œæ•°æ®åº“è¿ç§»

åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œï¼š

```sql
-- è¿è¡Œ supabase/migrations/add_order_bonus_field.sql
```

### 2. éƒ¨ç½²ä»£ç 

```bash
git add src/services/BinaryService.ts
git add supabase/migrations/add_order_bonus_field.sql
git commit -m "feat: æ–°å¢è§å•å¥–åŠŸèƒ½ - ç›´æ¨é“¾5å±‚æ¯å±‚1U"
git push
```

### 3. é‡å¯æœåŠ¡

```bash
# å¦‚æœä½¿ç”¨ Vercel
vercel --prod

# å¦‚æœä½¿ç”¨æœ¬åœ°
npm run build
npm run preview
```

### 4. éªŒè¯åŠŸèƒ½

- æ³¨å†Œæµ‹è¯•ç”¨æˆ·
- å»ºç«‹ç›´æ¨å…³ç³»é“¾
- è§¦å‘å¯¹ç¢°
- æŸ¥çœ‹è§å•å¥–è®°å½•

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ€§èƒ½è€ƒè™‘

- æ¯æ¬¡å¯¹ç¢°éœ€è¦è¿½æº¯5å±‚ä¸Šçº§
- 5æ¬¡æ•°æ®åº“æŸ¥è¯¢ + 5æ¬¡é’±åŒ…æ“ä½œ
- å¦‚æœå¯¹ç¢°é¢‘ç¹ï¼Œè€ƒè™‘å¼‚æ­¥å¤„ç†

### 2. é”™è¯¯å¤„ç†

- å·²æ·»åŠ  try-catch åŒ…è£¹
- è§å•å¥–å¤±è´¥ä¸å½±å“å¯¹ç¢°å¥–å‘æ”¾
- è®°å½•é”™è¯¯æ—¥å¿—ä¾¿äºæ’æŸ¥

### 3. æ•°æ®ä¸€è‡´æ€§

- ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
- é’±åŒ…ä½™é¢å’Œç»Ÿè®¡å­—æ®µåŒæ­¥æ›´æ–°
- è®°å½•è¯¦ç»†æ—¥å¿—ä¾¿äºå®¡è®¡

---

## ğŸŠ å®ŒæˆçŠ¶æ€

### âœ… å·²å®Œæˆ

- [x] å®ç° `triggerOrderBonus()` å‡½æ•°
- [x] åœ¨å¯¹ç¢°å¥–åŠ±åè°ƒç”¨
- [x] æ·»åŠ æ•°æ®åº“å­—æ®µ `total_order_bonus`
- [x] åˆ›å»º `order_bonuses` è®°å½•è¡¨
- [x] æ·»åŠ é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- [x] ç¼–å†™åŠŸèƒ½è¯´æ˜æ–‡æ¡£

### â³ å¾…æµ‹è¯•

- [ ] åˆ›å»ºæµ‹è¯•ç”¨æˆ·é“¾
- [ ] è§¦å‘å¯¹ç¢°éªŒè¯å¥–åŠ±
- [ ] æ£€æŸ¥æ•°æ®åº“è®°å½•
- [ ] éªŒè¯ä½™é¢å˜åŒ–

### ğŸ“ˆ å¯ä¼˜åŒ–

- [ ] æ·»åŠ åå°ç®¡ç†ç•Œé¢ï¼ˆæŸ¥çœ‹è§å•å¥–ç»Ÿè®¡ï¼‰
- [ ] åœ¨ç”¨æˆ·ç«¯æ˜¾ç¤ºè§å•å¥–æ”¶ç›Š
- [ ] æ·»åŠ è§å•å¥–æ’è¡Œæ¦œ
- [ ] ä¼˜åŒ–æ€§èƒ½ï¼ˆæ‰¹é‡å¤„ç†ï¼‰

---

**ğŸ‰ è§å•å¥–åŠŸèƒ½å·²å®Œæˆï¼5å±‚ç›´æ¨é“¾ï¼Œèººèµšè§å•å¥–ï¼** ğŸ’°

---

**åˆ›å»ºæ—¶é—´ï¼š** 2025-10-18  
**åŠŸèƒ½çŠ¶æ€ï¼š** âœ… ä»£ç å·²å®Œæˆï¼Œå¾…æµ‹è¯•  
**å¥–åŠ±è§„åˆ™ï¼š** 5å±‚ Ã— 1U Ã— å¯¹ç¢°ç»„æ•°

